---
title: "开题报告"
author: "Li"
date: "2019-04-15"
css: ./style/markdown.css
autoEqnLabels: true
eqnPrefixTemplate: ($$i$$)
linkReferences: true
bibliography: [Bibfile.bib, ]
notice: '@*'
csl: ./style/chinese-gb7714-2005-numeric.csl
link-citations: true
---

**TODO**




```{r setup, echo=F}
knitr::opts_knit$set(root.dir = getwd())
knitr::opts_chunk$set(echo = FALSE, results = 'hide')
knitr::opts_chunk$set(warning = FALSE, message=FALSE)
```

```{r prepare}
rm(list=ls())
options(digits=4)
options(scipen=100)
graphics.off()
Sys.setlocale("LC_ALL", "Chinese")
```


# 广义可加混合模型设定

在上一章，我们把非参数光滑器加入到一些熟悉模型之中，如线性回归模型
和Logistic回归模型，得到这些模型的半参数推广模型，这些模型都可以包括
在GAM框架下。在这一章，我们把非参数回归模型推广到混合模型，也即半参数混
合模型。与前面相同，我们可以在混合模型中使用光滑器来检验和拟合非线性。
尽管把光滑方法推广到混合模型的思想比较直观，但是半参数混合模型会带来估
计和检验上的难度。下面我们首先讨论线性混合模型，给出线性混合模型的模型
设定和参数估计。第二部分如何把半参数方法加入到混合模型中去，得到了半参
数混合模型。第三部分简单讨论广义线性模型、半参数方法和混合模型三者结合
得到的广义可加混合模型(GAMM)。

## 基础模型

在上一章中我们介绍了几种非参数回归模型。这些模型的一个优点就是它们在不
对函数形式做假设时就允许对变量$x$和$y$之间的关系进行估计。然而，对于自
变量个数超过2个的多维情况，非参数回归就难以应用。因此这严重限制了非参数
回归在应用领域的作用。而在实际统计建模过程中遇到更多的情况是自变量的个
数较多。如果对于多元情况无能为力，那么非参数回归在实际应用过程中很难发
挥作用。在这种情况下非参数回归仅仅只能作为在进行多元分析之前的一个探索
性分析工具。然而，只要增加一些条件，我们就能把非参数回归增加到在实际建
模中应用极为广泛的标准多元模型中去。如果我们假设自变量对因变量的作用是
可加的，那么我们就可以得到一个部分自变量以参数形式进入而另一部分自变量
以非参数形式进入的半参数回归模型。半参数回归模型可以在熟悉的多元回归模
型背景下估计带有非线性估计的标准参数模型，非参数项可以用于连续自变量或
用于非线性的检验。

这一章我们讨论半参数回归模型和广义可加模型。我们首先从讨论多元非参数回
归和可加模型开始。可加模型不是半参数模型，但其为半参数回归模型提供
了基础。接着我们给出了半参数回归模型的模型设定，并对半参数回归模型的估
计和推断方法进行了讨论。为把半参数模型推广到广义可加模型，我们对在实际
应用和理论研究上都有重要作用的广义线性模型也进行了较为详细的讨论。有了
可加模型和广义线性模型基础，得出广义可加模型是自然的。在这一章的最后一
部分，我们对广义可加模型的模型设定、估计和推断进行了讨论。



### 多元非参数回归 {#sec:multi-nonpara-reg}

在上一章中，我们主要关注的是两个变量，即一个因变量和一个自变量关系，没
有涉及到多个自变量。但是在大部分应用研究中需要考虑多元模型。局部多项式
非参数回归模型可以推广到多元框架下。

一般地，我们可以假设$k$元非参数回归模型为： $$\label{eq:semipara-72}
  Y_{i}=f(X_{1},\cdots,X_{k})+\varepsilon.$$

这个模型的估计与一个自变量的非参数回归模型相类似。这时，局部估计使用多
元局部多项式回归而不是一元局部多项式回归。像以前一样，靠近关注点的数据
比远离关注点的数据得到更多的权重。但由于窗的大小变成了平面的距离从而使
得局部窗宽的定义更为复杂。用来自多元局部多项式回归模型的预测值作为局部
估计，把其连接起来就得到了估计的曲面，这个曲面表示
了$x_{1i}$和$x_{2i}$对$y$的交互作用。二元非参数回归模型等价于非线性交互
模型的设定，其得到的估计是代表两个自变量对$y$的联合作用的曲面。

在这种形式中，有人可能会认为非参数回归适合于标准的多元条件，因此可以在
实际建模过程中使用。但这个模型有两个严重的局限性。第一个问题就是“维数
灾难”(curse of dimensionality)。当模型中自变量的个数增加时，在每个关注
点的局部临近区域内的观测值的个数下降的很快。因此对于固定容量的点来说，
当维度增加时，局部临域中用于估计的点越来越少。一个解决方法就是增加带宽，
但增加带宽增加了估计中的偏倚。第二，当自变量个数多于2个时，解释将变得不
可能。当$k$等于2时公式 的结果可以用一个三维曲线来
表示，其表示了这两个变量的联合效应。加入第3个自变量尽管估计是可行的，但
要解释得到的结果就需要额外的维度，而这是不可能的。这些模型不产生任何参
数，当模型中包含的自变量的个数多于两个时，估计的已不可能用图形来显示。
多元光滑方法的详细介绍可以参见 Wood(2006)[@wood2006generalized]。

下面给出维数灾难的一个例子。在单位区间$[0,1]$中含有平均分布在区间
的100个点，那么每个点之间的平均距离为0.01。对于一个边长相等的立方体来说，
需要$10^{20}$个点来使得立方体中每两个点之间的距离等于0.01。更一般地，维
数灾难表明二维情况下要达到与一维情况下相等的距离需要的点的数量比一维情
况下点的数量要大几个数量级。

假设这100个点就是数据。如果这100个数据点分布在范围为单位区间的$X$变量上，
那么数据点之间的空间将会很小。在非参数背景下，这暗示带宽可以相当小，而
我们仍然有稳定的局部估计。但如果这100个数据点是分布在一个平面上，数据点
之间的距离则要大的多，为了得到光滑估计，此时带宽必须很大。实际上，为了
得到一个光滑估计带宽可能必须增大到估计不再是局部估计而是一个整体估计。
因此，维数灾难使得局部回归的目的失败。在多维情况下数据变得如此稀疏以致
带宽必须增加到估计将不再是局部的程度。简而言之，如果没有非常大的数据量，
就没有办法得到稳定的局部估计。

在探讨将非参数回归推广到多个自变量的方法之前。我们先给出多元非参数模型
的分类，如图所示 \[fig:multi-nonpar\] 。


首先考虑完全的非参数模型$y=f(x)+\varepsilon$，其中$\varepsilon$为i.i.d，
具有0均值和常数方差$\sigma_{\varepsilon}^{2}$。如果仅假设$f$属于光滑函
数族$\mathfrak{F}$，那么此时模型是非参数的，且对其约束条件很少。这个也
就是完全的多元非参数回归模型。图 \[fig:multi-nonpar\] 中的两个对角处
给出了完全参数模型和完全非参数模型。

考虑到估计多个自变量的完全的非参数模型的困难，研究者一般寻求简约的混合
模型。一个这样的例子就是部分线性模型,也就是我们将要讨论的半参数回归模型。
我们从图 \[fig:multi-nonpar\] 中可以看到，对于任意固定的$x$，回归函数
是$\bm{z}$的线性函数。部分参数模型是部分线性模型的一个推广，其
中$y=g(\bm{z;\beta})+f(x)+\varepsilon$，$g$是一个已知的函数。对于
图 \[fig:multi-nonpar\] 中的部分参数模型曲面，对于任意固定
的$x$值$g$是$z-a$的二次函数。

单指标模型构成了另一种混合。在$y=f(\bm{x\beta})+\varepsilon$的情况下，
对于任意固定的指数值$\bm{x\beta}$，函数$f(\bm{x\beta})$是固定的。
图 \[fig:multi-nonpar\] 中描述的指数模型由$y=\cos(x_{1}+x_{2})$给出。
因此，在$x_{1}+x_{2}=$固定值时，函数是平的直线。部分线性指数模型是另一
类推广，即$y=f(\bm{x\beta})+\bm{z\delta}+\varepsilon$。

最后，如果我们可以把$\bm{x}$分为两个子集$\bm{x_{a}}$和$\bm{x_{b}}$，且
$f$可以写为$f_{a}(x_{a})+f_{b}(x_{b})$的形式，那么这个模型成为独立可加
的。(当然，部分线性模型和部分参数模型都是独立可加的，但这时一个部分是
参数的，另一个部分是非参数的。)

我们将讨论上面分类中的部分线性模型(半参数回归模型)和独立可加模型(简称
为可加模型)。

### 可加模型 {#sec:addtive_models}

多元非参数回归模型由于“维数灾难”等局限性导致其难以运用到实际建模过程
中。我们希望能找到既能达到数据降维同时又能保留非参数光滑优点方法。主要
的方法就是可加模型。

把非参数回归模型推广到两个以上的自变量需要额外的假设：可加。尽管可加
性的条件比完全的多元非参数回归模型具有限制性，但它是统计建模过程中使用
的参数模型中几个最常见的假设之一。对于参数线性回归模型，一般假设其函数
形式为： $$\label{eq:semipara-73}
 Y_{i}=\alpha+\beta_{1}X_{1}+\cdots+\beta_{k}X_{k}+\varepsilon.$$
在这个函数形式中，我们一般假设自变量对$Y$的作用是可加的：$X_{1}$和
$X_{2}$的作用是$\beta_{1}+\beta_{2}$。可加假设有时候可以放松到含有交
互项的模型： $$\label{eq:semipara-74}
  Y=\alpha+\beta_{1}X_{1}+\beta_{2}X_{2}+\beta_{3}X_{1}X_{2}+\varepsilon.$$
可加条件是相当严格的，但它已经在我们估计的大部分模型中出现，因此我们
可以把它推广到非参数回归模型。具有可加条件的非参数回归模型具有以下形
式： $$\label{eq:semipara-75}
  Y_{i}=\alpha+f_{1}(X_{1})+\cdots+f_{k}(X_{k})+\varepsilon$$
其中$f_{1},\cdots,f_{k}$是任意的光滑函数，我们将用数据通过光滑器进行估
计。具有可加条件的非参数回归模型称为**可加模型**。可加的动
机来源于把非参数回归模型推广到多元数据分析中的愿望(Hastie，
Tibshirani,1990)[@hastie1990generalized]。

这种例行的可加假设换取了额外的可解释性，因为这个假设表明了多元非参数
回归模型与多元线性回归模型具有相同的可解释性。例如，考虑以下可加模型:
$$\label{eq:semipara-76}
  Y_{i}=\alpha+f_{1}(X_{1})+f_{2}(X_{2})+f_{3}(X_{3})+\varepsilon.$$
考虑到可加假设，我们可以单独画出每一个$\hat f_{i}$的图形，因为
$X_{1}$和$X_{2}$的作用现在为$\hat f_{1}+\hat f_{2}$。而且，$\hat
f_{1}$的估计考虑了三个自变量之间的协方差，因此可以被解释为在固定
$X_{2}$和$X_{3}$时$X_{1}$对$Y$的作用。现在模型中每一个$\hat f_{i}$类似于
多元线性回归模型中的$\beta$系数。可加允许我们保留非参数回归灵活性的
同时使用参数模型的可解释性。

尽管可加模型相对于多元非参数回归模型来说具有许多优点，但他们仍然具有
一定的限制，这些限制使得可加模型在实际建模中使用并不多。具体地，可加
性模型缺少一个重要的特征，而这个特征包含在半参数回归模型中。

### 半参数回归模型 {#sec:semipara-reg-model}

如果我们只估计连续变量之间的非线性关系，可加模型刚好适合，但在实际建
模过程中并不都是非线性关系。首先，离散自变量是非常普遍的，而且个数通常
比连续自变量个数多。第二，有的自变量与因变量之间的关系可能实际上是线性
的。如果一个参数足够描述$X$与$Y$之间的关系，就没有必要使用额外的参数来
估计非参数回归。总之，最具灵活性的模型应是在同一个模型中既包含参数项又
包含非参数项。我们可以直接修改可加模型来同时估计参数项和非参数项。混合
参数项和非参数项的一个模型可以采取以下形式： $$\label{eq:semipara-77}
  Y_{i}=\alpha+f_{1}(X_{1})+\cdots+f_{j}(X_{j})+\beta_{1}X_{j+1}+\cdots+\beta_{k}X_{k}+\varepsilon.$$
在上面模型中，前$j$个自变量被认为对$Y$有非线性作用，因此用非参数光滑器
进行拟合。其它的自变量以参数形式进入模型。在可加模型中添加参数项就得
到**半参数回归模型**。半参数回归模型可以估计种类非常多的函数形式。
模型中的参数部分允许像哑变量或定序变量的离散变量与非参数项一起建模。研
究者认为对$Y$的作用为线性的连续自变量可以以参数方式进行估计以节省参数。
半参数模型相对于完全的参数模型也具有优势。在半参数框架下，非参数的推断
在半参数回归模型中得到了保留，它允许检验任何一个非参数项对于模型来说是
否需要。我们还可以在半参数光滑模型中包含交互项。例如，考虑以下半参数模
型： $$\label{eq:semipara-78}
  Y_{i}=\alpha+f_{1}(X_{1})+f_{2}(X_{2})+\beta_{3}X_{3}+\beta_{4}X_{4}+\varepsilon.$$
在这个模型中，$X_{3}$是哑变量，$X_{4}$和$X_{1}$，$X_{2}$一样是连续变量。
使用半参数回归模型，我们可以设置几个不同的交叉项。首先，我们可以估
计$X_{1}$与$X_{2}$之间的非线性交叉，结果将是一个三维图形等同于多元非参
数回归。我们也可以包含一个$X_{3}$和$X_{4}$之间的完全的参数交叉项。而且，
我们还可以在模型中添加参数和非参数项之间的混合交叉项，例如我们可以画出
在$X_{3}$或者$X_{4}$不同水平下的$X_{1}$的非线性作用图。总之，半参数回归
模型是一个可以同时对变量间线性和非线性依赖关系进行建模的工具。下面给出
对于可加模型和半参数模型的估计过程。

### 估计 {#sec:estimation}

可加模型和半参数回归模型的估计需要迭代算法。在不同的软件平台中实现了几
种迭代算法。一种方法是利用光滑样条和混合模型的等价性，并依赖Newton-Raphson算法来构造受
限极大似然估计量。也可以采取广义线性模型框架下标准的迭代重加权最小二乘
算法来估计半参数模型。然而，估计这些模型最著名的方法是
由Hastie，Tibshirani(1990)提出并实现
的算法[@hastie1990generalized]。Backfitting算
法灵活，而且可以同时估计非参数和参数项，并且其相对比较简单。下面简单叙
述backfitting算法的基本思想。

如果模型自变量之间是不相关的，带有多元非参数项的模型拟合就比较简单。如果
自变量之间是正交的，对于参数部分，我们可以使用OLS来估计一序列二元模型
的每一部分，对于非参数部分，使用或样条进行拟合。在这种
背景下，没有必要使用多元回归，因为一序列二元回归就与多元回归是等价的。
但是，一般我们很少有自变量之间是不相关的数据,因此我们需要对可加模型
或半参数模型中自变量之间协方差进行估计。Backfitting算法在估计模型中的
非参数和参数项时把这些变量之间的相关性也考虑进来了。

Backfitting算法的基本思想是通过部分回归函数来进行估计。考虑以下具有两
个自变量的可加模型： $$\label{eq:semipara-79}
  Y=\alpha+f_{1}(X_{1})+f_{2}(X_{2})+\varepsilon.$$
假设我们知道$f_{2}$的真实形式但$f_{1}$未知。如果这个假设成立，我们可以
整理方程得到部分回归函数以解出$f_{1}$： $$\label{eq:semipara-80}
  y-\alpha-f_{2}(X_{2})=f_{1}(X_{1})+\varepsilon.$$
光滑$y-\alpha-f_{2}(X_{2})$和$X_{1}$就得到$f_{1}(X)$的估计。因为知道一
个部分光滑函数就可以估计出另一个部分回归函数。但实际上，我们并不知道这
些函数的真实形式。但如果我们给出这些函数的一个起始值，就可以对可加模型
中的部分回归函数通过迭代进行估计。

半参数回归模型的backfitting算法处理方法与可加模型相同，对每一个自变量都
得到部分残差。如果某一自变量具有非参数形式，我们就用这个变量的部分残差
和这个变量进行光滑拟合。如果自变量具有参数形式，那么使用最小二乘而不是
光滑器对部分残差和这个变量进行回归。对backfitting的这个改动就可以估计半
参数回归模型。如果把backfitting算法应用于线性模型，在估计步骤中把非参数
回归换成线性回归，这时它得到的就是最小二乘估计。Backfitting算法具有一定
优点，但它也有一个缺点，即自动光滑技术很难集成到这个算法中去。软件中半
参数回归模型新的实现方法一般都采用没有这个缺点的再加权最小二乘算
法。Wood(2006)对这些算法给出了一个比较详细的讨
论[@wood2006generalized]。

### 推断 {#sec:inference}

半参数回归模型的推断混合了线性模型推断和非参数回归模型推断。对于模型中
的非参数项，我们估计置信带并与更节俭的参数模型进行检验。对于模型中参数
项，我们估计标准误构成置信区间并用于假设检验。在半参数回归模型中这些都
是可用的。

非参数项的置信带和参数项的标准误都需要估计方差协方差阵。半参数回归模型
的方差协方差阵的估计与非参数回归模型中的方差协方差阵的估计类似，但更复
杂。检验半参数回归模型对完全参数模型则比较直观，可以使用近似$F$检验或
似然比检验。首先，我们得到来自backfitting算法的方差协方差阵的估计，并
用它进行构建非参数项的置信带和参数项的标准误。其次，我们简单介绍使用部分
$F$检验或似然比检验的假设检验过程。

#### 置信带和标准误

在第 \[sec:smooth-local-regr\]节和第 \[sec:splines\]节中，我们定义
了光滑矩阵$\boldsymbol{S}$，它是对线性回归中帽子矩阵$\boldsymbol{H}$的
类比，此时有$\hat f=\boldsymbol{Sy}$。一旦我们得到了$\boldsymbol{S}$，
标准误就可以用类似于最小二乘的方式估计出来，用$\hat
\sigma^{2}\boldsymbol{SS'}$作为方差协方差矩阵。我们需要构建广义可加模
型和半参数回归模型的方差协方差矩阵，它允许我们进行统计推断。使用
$\mathcal{L}_{2}$函数空间，Hastie，Tibshirani(1990)把可加模型表示成
以下形式[@hastie1990generalized]： $$\left [
    \begin{array}{ccccc}
      \label{eq:semipara-82}
      I&S_{1}&S_{1}&\cdots &S_{1}\\
      S_{2}&I&S_{2}&\cdots &S_{2}\\
      \vdots &\vdots &\vdots & \ddots &\vdots\\
      S_{k}&S_{k}&S_{k}&\cdots &I
    \end{array}
  \right ]
  \left [
    \begin{array}{ccccc}
      f_{1}\\
      f_{2}\\
      \vdots\\
      f_{k}
    \end{array}
  \right ]
  =
  \left [
    \begin{array}{ccccc}
      S_{1}y\\
      S_{2}y\\
      \vdots\\
      S_{k}y
    \end{array}
  \right ]$$
其中$\bm{I}$为$n\times n$单位阵，$\bm{S}_{1},\cdots,\bm{S}_{k}$是对应
于每一个自变量$X$的光滑矩阵。

在理论上，上面的方程组可以直接使用像矩阵QR分解等非迭代程序解出来。但在
实际中，对于非迭代方法来说，这个方程组太大了，因此需要使用其它算法。我
们可以把上面的方程写成更紧凑的形式，并对其变形以得到一个类似于帽子矩阵
的矩阵：$$\begin{aligned}
  \label{eq:semipara-83}
  \hat Sf&=\hat Qy\nonumber \\
  \hat f&=\hat S^{-1}\hat Qy\nonumber\\
  \hat f&=Ry\end{aligned}$$
其中$\bm{R=\hat R^{-1}\hat Q}$。矩阵$\bm{R}$把$y$线性变换到$\hat f$。
$\bm{R}$就是可加模型或半参数回归模型中类比线性模型中帽子矩阵的光滑矩阵。
如果观测值是独立同分布的，则有： $$\label{eq:semipara-84}
  \mathbb{V}(\hat f)=\sigma^{2}\bm{RR'}$$ 其中$\sigma^{2}$用下式代替：
$$\label{eq:semipara-85}
  \hat \sigma^{2}=\frac{\sum e_{i}^{2}}{df_{\text{res}}}.$$
其中残差的自由度$df_{\text{res}}=n-\text{tr}(2\bm{R}-\bm{RR'})$。置信带
可以通过$\pm 2$倍$\hat \sigma^{2}\bm{RR'}$对角元素的平方根来构建。对于
半参数回归模型来说，光滑矩阵$\bm{R}$的对角元素也是估计的$\beta$的方
差。$\bm{R}$的估计需要迭代算法。例
如，Hastie，Tibshirani(1990)就用backfitting算法来计算$\bm{R}$，但此时方
差协方差阵的估计没有对$\hat f$的偏倚进行相应调
整[@hastie1990generalized]。我们可以再一次使用样条的混合模型公式或
贝叶斯方法对偏倚进行调整以得到无偏的置信带。但无论哪一种方法的使用都使
估计变得更复杂，需要对算法数值稳定性特别注
意。Rupper,Wand，Carrol(2003)和Wood(2006)都提供了可加模型和半参数回归模
型偏倚调整的方差协方差矩阵估计的细
节[@ruppert2003semiparametric; @wood2006generalized]。

#### 假设检验

可加模型和半参数回归模型的假设检验与线性模型相比并没有复杂多少。对于参
数项，来自光滑矩阵$\bm{R}$的标准误允许我们进行假设检验等推断过程。对于
非参数项，我们对两种检验感兴趣。这两种检验可以用部分$F$检验或似然比检
验进行。第一个是检验自变量对因变量是否有显著性作用，第二个是检验使用非
参数拟合与参数模型相比是否显著的改变了模型的拟合效果。可以通过一个例子
来描述这两个检验。考虑以下模型： $$\label{eq:semipara-86}
  Y=\alpha+f_{1}(X_{1})+f_{2}(X_{2})+\varepsilon.$$
为了检验$X_{2}$对$Y$是否有显著性的作用，我们可以把模型 和
以下模型进行比较： $$\label{eq:semipara-87}
  Y=\alpha+f_{1}(X_{1})+\varepsilon.$$
为了检验$X_{2}$对$Y$的作用是否为线性，可以把模型 和以下模 型进行比较：
$$\label{eq:semipara-88}
  Y=\alpha+f_{1}(x)+\beta_{1}X_{2}+\varepsilon.$$
$F$检验是基于残差平方和的。可加模型和半参数回归模型的残差平方和可以定
义为 $$\label{eq:semipara-89}
  \text{RSS}=\sum_{i=1}^{n}(y_{i}-\hat y_{i})^{2}.$$

用$\text{RSS}_{0}$表示受限模型的残差平方和。用$\text{RSS}_{1}$表示可加
或半参数回归模型的残差平方和，则检验统计量为 $$\label{eq:semipara-90}
  F=\frac{(\text{RSS}_{0}-\text{RSS}_{1})/\text{tr}(\bm{R})-1}{\text{RSS}_{1}/df_{\text{res}}}.$$
这个检验统计量近似服从自由度为
$df_{\text{res,smaller}}-df_{\text{res,larger}}$和
$df_{\text{res,larger}}$的$F$分布(Hastie，Tibshirani,1990)。

对于采用再加权最小二乘或受限极大似然方法而不是backfitting算法的可加模型
或半参数回归模型，我们可以使用似然比检验或偏差(difference of
deviance)检验。可加模型或半参数回归模型的似然比检验一般使用以下形式的统
计量： $$\label{eq:semipara-92}
  \text{LR}=-2(\text{LogLikelihood}_{0}-\text{LogLikelihood}_{1})$$
其中$\text{LogLikelihood}_{0}$是受限模型的对数似然，
$\text{LogLikelihood}_{1}$是可加模型或半参数回归模型的对数似然。这个检
验统计量在$H_{0}$成立时近似服从$\chi^{2}$分布，自由度就是两个模型中使
用的参数个数之差。一个模型的偏差(deviance)就是-2乘以对数似然。
difference of deviance检验的检验统计量就是两个模型的偏差相减，得到的检
验统计量服从$\chi^{2}$分布，统计量的自由度为两个模型中使用的参数的个数
之差。

对于可加模型或半参数回归模型推断有一点必须要注意：如果自动光滑技
术用于估计非参数项，此时检验统计量的分布被认为是近似服从$\chi^{2}$分布，
但这个近似的效果没有充分的保证(Wood,2006)。一般地，我们希望看到估计
的$p$值很小。如果$p$值仅是勉强拒绝原假设，这时的结论是不可靠的，应重新
使用手动选择光滑程度拟合后进行检验。对于样条模型，则可以使用无惩罚项的
样条模型来拟合，此时的$p$值比光滑样条更精确。我们也可以使用自助法来进行
这些检验，这时无需统计量参数分布已知，详细可以参
考Keele(2008)[@keele2008semiparametric]。

把非参数项添加到参数回归模型中就得到半参数回归模型，半参数回归模型可以
同时估计非线性函数形式并对离散自变量估计参数项。半参数回归模型保留了非
参数回归的检验机制，可以检验参数拟合是否足够拟合数据。半参数回归模型是
非参数光滑的灵活性和参数模型的可解释性的结合。

尽管使用半参数回归模型具有许多优点，但使用过程中也有一些注意事项。非参
数回归所有的缺点在半参数回归模型中仍然存在。第一，当光滑参数是由自动光
滑技术给出的时候，似然比检验的检验统计量是近似服从$\chi^{2}$分布的。如
果这个检验在边界附近，这时模型应用手动选择光滑参数或标准样条重新估计。
第二，半参数回归模型，像参数回归模型一样，也可能具有多重共线性。在半参
数模型中，这被称为共曲线性(concurvity)。如果两个自变量是高度相关
的，backfitting算法也许不能找到一条唯一的曲线，这时结果将是线性的。如果
没有额外的数据，这个问题将没有办法解决。

广义线性模型 {#sec:glm}
------------

在实际数据分析过程中，分类数据非常广泛。分类数据模型，像Logistic模
型和计数模型的用途很广。在统计上，分类数据的模型一般属于广义线性模
型(GLM)。为把半参数模型推广到分类数据等情形，我们需要与广义线性模型类似
的框架。下面我们就讨论广义线性模型。这一节主要参考了McCullagh，Nelder
(1989)[@mccullagh1989generalized]，Fahrmeir，
Tutz(1994)[@fahrmeir1994multivariate]，Lindsey
(1997)[@lindsey1997applying]，
Olsson(2002)[@olsson2002generalized]和Dobson，
Barnnet(2008)[@dobson2008introduction]等人关于广义线性模型的著作。

广义线性模型是经典线性模型的自然推广，最先由Nelder和Wedderburn在1972年
提出[@nelder1972generalized]。广义线性模型为这些常用统计模型提供了
一套统一的框架。许多在统计分析中常见的模型都可以看作是广义线性模型的特
殊情况，例如线性回归和方差分析，处理定性因变量的logit和probit模型，用于
分析计数数据的对数线性模型和泊松回归模型，生存数据分析中一些常见统计模
型等。上面这些模型虽然名称各异，但它们具有一些共同的特征，例如其本质具
有线性，它们的参数估计可以使用相同的估计方法。这些共同点使得我们可以把
这些模型放在一起作为一类模型来研究，而不是把它们看着是无关联的模型。

下面我们先给出经典线性模型，作为讨论广义线性模型的基础。

$Y_{1},\cdots, Y_{n}$是$n$个相互独立的随机向量,并且$Y_{i} \sim
\bm{\mathcal{N}}(\mu_{i},\sigma^{2}), i=1,\cdots, n$，$Y_{1},\cdots,
Y_{n}$的一次样本实现值为$y_{1},\cdots,y_{n}$。 令$\bm Y=(Y_{1},\cdots,
Y_{n})^T$，$\bm y=(y_{1},\cdots,y_{n})^{T}$，$\bm \mu=(\mu_{1},
\cdots, \mu_{n})^{T}$，即有$\mathbb{E}(\bm Y)= \bm \mu$。现有$p$个确定
性变量$x_{1},\cdots,x_{p}$，每个变量也有$n$个值，用矩阵$\bm X$来表示这
$n\times p$个值，即 $$\label{eq:semipara-1}
  \bm X= \left [
    \begin{array}{cccc}
      x_{11}& x_{12}& \ldots & x_{1p}\\
      x_{21}& x_{22}& \ldots & x_{2p}\\
      \vdots& \vdots& \ddots & \vdots\\
      x_{n1}& x_{n2} & \ldots & x_{np}
    \end{array}
  \right]$$
其中$x_{1}$变量一般取1，即$\bm X$的第一列一般全部为1。此外，用$\bm
\beta=(\beta_{1}, \cdots, \beta_{p})^{T}$表示$p$个固定未知参数。以$\bm
Y$为因变量，以$x_{1}, \cdots, x_{p}$为自变量，建立线性回归模型有
$$\label{eq:semipara-2}
  \mathbb{E}(\bm Y)=\bm \mu, \text{而} \bm \mu=\bm X \bm \beta.$$

经典线性模型的假设可以归纳为四点：(1)线性，即因变量的期望是自变量参数
的线性函数；(2)独立性，$Y_{1},\cdots, Y_{n}$之间是独立的；(3)正态性，
$Y_{1},\cdots, Y_{n}$都服从正态分布；(4)方差齐性，$Y_{1},\cdots,
Y_{n}$的方差为固定常数。

### GLM三个组成部分

为了简化从经典线性模型向广义线性模型的过渡，我们把公式分解为
以下三个部分的设定：

1\. 随机部分：这部分是关于因变量的分布或者是随机项的结构。在经
典线性模型中，$\bm Y$的分量相互独立，且都服从正态分布，$\mathbb{E}(\bm
Y)=\bm \mu$，方差为固定常数$\sigma^{2}$。

2.系统部分：这部分是自变量的一个函数，以期用它来解释因变量的期
望。在经典线性模型中，系统部分是自变量的线性组合，我们把这个线性函数称
为线性预测子(linear predictor)，用$\bm \eta$来表示，即
$$\label{eq:semipara-3}
  \bm \eta= \bm {X\beta}.$$

3\. 联接函数：联接函数是联接随机部分和系统部分的工具。在经典线
性模型中，联接函数为恒等函数，即 $$\label{eq:semipara-5}
  \bm \mu = \bm \eta.$$ 如果我们有 $$\eta_{i}=g(\mu_{i})$$
那么我们把函数$g(\cdot)$称为联接函数(link function)。

与经典线性模型相同，广义线性模型也由随机部分、系统部分和联接函数三部分
组成。但广义线性模型在随机部分和联接函数两个方面对经典线性模型进行了推
广。广义线性模型的随机部分可以不是正态分布，而是推广到指数分布簇；广义
线性模型的联接函数不必是恒等函数，可以推广到任意单调可微函数。

下面我们先看因变量分布的推广。

### 指数分布簇

指数分布簇是一大类包括许多常见分布的分布集合，它包括常见的分布，如正态
分布，指数分布，二项分布，泊松分布，伽马分布和逆正态分布等等。而常见的
不属于指数分布簇的分布有$t$分布和柯西分布。指数分布簇的概率密度函数具有以
下形式 $$\label{eq:semipara-6}
  f(y;\theta,\phi)=
  \exp \left[\frac{y\theta-b(\theta)}{a(\phi)}+c(y,\phi) \right],$$
其中$a(\cdot)$，$b(\cdot)$和$c(\cdot)$是一些具体的函数。当$\phi$已知时，
参数$\theta$被称为标准参数(canonical parameter)。当$\phi$未知
时，具有以上形式概率密度函数的分布有可能属于具有两个参数的指数分布簇，
也有可能不再属于指数分布簇。例如正态分布的概率密度函数可以写成指数分布
簇密度函数的形式 $$\begin{aligned}
  \label{eq:semipara-8}
  f(y;\mu,\sigma^{2})&=\frac{1}{\sqrt{2\pi\sigma^{2}}}
  \exp\left[-\frac{(y-\mu)^{2}}{2\sigma^{2}}\right]  \\
  &=\exp\left \{ \left[y\mu-\frac{\mu^{2}}{2} \right]
      \frac{1}{\sigma^{2}}-\frac{y^{2}}{2\sigma^{2}}-\frac{1}{2}\log(2\pi\sigma^{2}) \right\}\end{aligned}$$
此时$\theta=\mu$，$\phi=\sigma^{2}$，并且 $$\label{eq:semipara-9}
  a(\phi)=\phi, \quad b(\theta)=\theta^{2}/2,\quad c(y,\phi)=-[y^{2}/
  \phi+\log(2\pi \phi)]/2.$$

指数分布簇有一些良好的性质，服从指数分布簇的随机变量的期望和方差都与其
概率密度函数中的函数$b(\theta)$有关。下面就导出具体关系。

我们知道，对于任意概率密度函数，概率密度曲线与横轴所围成的面积为1，即
$$\label{eq:semipara-10}
  \int f(y;\theta)\ud y=1,$$
其中积分区间是所有可能的$y$值。如果是离散随机变量，积分符号则用$\sum$
代替。

对式等号两边同时对$\theta$取导数有 $$\label{eq:semipara-11}
  \frac{\ud}{\ud\theta}\int f(y;\theta)\ud y=\frac{\ud}{\ud\theta}1=0.$$
假设式第一项中的积分和导数可以互换，那么式可 以变化为
$$\label{eq:semipara-12}
  \int \frac{\ud f(y;\theta)}{\ud\theta} \ud y=0.$$
类似地，我们可以得到关于$\theta$的二阶导数的等式
$$\label{eq:semipara-13}
  \int \frac{\ud^{2} f(y;\theta)}{\ud\theta^{2}}\ud y=0.$$
结合指数分布簇的概率密度形式式和式，有 $$\label{eq:semipara-14}
  \int \left[\frac{y-b'(\theta)}{a(\phi)} \right]f(y;\theta)\ud y=0.$$
根据随机变量数学期望定义$\mathbb{E}(Y)=\int
yf(y;\theta)\ud y$和，上式可以简化为 $$\label{eq:semipara-15}
  \frac{1}{a(\phi)}[\mathbb{E}(Y)-b'(\theta)]=0,$$ 即
$$\label{eq:semipara-16}
  \mathbb{E}(Y)=b'(\theta)$$
式表明服从指数分布簇随机变量的期望等于其概率密度函数形式中
函数$b(\theta)$的一阶导数。

同理，结合式和式有 $$\label{eq:semipara-17}
  \int \left \{ \left[-\frac{b''(\theta)}{a(\phi)} \right]f(y;\theta)
  + \left[\frac{y-b'(\theta)}{a(\phi)} \right]^{2}f(y;\theta) \right
\} \ud y=0$$ 注意到$\mathbb{E}(Y)=b'(\theta)$和方差的定义
$\text{var}(Y)=\int[y-\mathbb{E}(Y)]^{2}f(y;\theta)\ud y$，上式可以简化为
$$\label{eq:semipara-18}
  -a(\phi)b''(\theta)+\text{var}(Y)=0,$$ 即 $$\label{eq:semipara-19}
  \text{var}(Y)=b''(\theta)a(\phi)$$
式表明服从指数分布簇分布随机变量的方差与其概率密度函数形式
中的$b(\theta)$和$a(\phi)$两个函数有关系，方差是$b(\theta)$的二阶导
数$b''(\theta)$和$a(\phi)$的乘积：第一个函数$b''(\theta)$只与标准参
数$\theta$有关，第二个函数$a(\phi)$与$\theta$无关，而只与$\phi$有关。由
于指数分布簇随机变量的期望$\mu$也与标准参数$\theta$有关，因
此$b''(\theta)$也是$\mu$的函数，这个函数一般记为$V(\mu)$，并把其称为方
差函数。参数$\phi$有时也记为$\sigma^{2}$，并把它称为尺度参数(scale
parameter)或散布参数(dispersion parameter)。函数$a(\phi)$一般具有以下形
式 $$\label{eq:semipara-23}
  a(\phi)=\frac{\phi}{w}$$ 其中$w$是事先确定的权重。

下面讨论指数分布簇中分布的似然函数和对数似然函数的一些性质。这些性质将
在广义线性模型参数估计和推断中发挥重要作用。

对于指数分布簇中的某一分布，其似然函数为
$\mathcal{L}(\theta,\phi;y)=f(y;\theta,\phi)$，由于指数分布簇分布的概
率密度函数形式具有式中的形式，因此对数似然函数为
$$\label{eq:semipara-20}
  l(\theta,\phi;y)=\log \mathcal{L}(\theta,\phi;y)
  =\frac{\theta y-b(\theta)}{a(\phi)}+c(\phi,y).$$
对数似然函数关于$\theta$的一阶导数为 $$\label{eq:semipara-21}
  U(\theta,\phi;y)=\frac{\partial l(\theta,\phi;y)}{\partial \theta}=
  \frac{y-b'(\theta)}{a(\phi)},$$
$U$的值随$y$的变化而变化，可以看作一随机变量，因此$U$是统计量，一般把
$U$称为得分统计量(score statistic)。容易得到，$U$具有以下性质：
$$\begin{aligned}
  \label{eq:semipara-22}
  \mathbb{E}(U)&=0,\\
  \text{var}(U)&=\frac{b''(\theta)}{a(\phi)},\\
  \text{var}(U)&=\mathbb{E}(U^{2})=-\mathbb{E}(U'),\end{aligned}$$
其中$U'=\partial U/\partial \theta=-b''(\theta)/a(\phi)$。一般把$U$的
方差记为$\mathfrak{J}$，并称其为信息(infomation)。

### 联接函数

联接函数$g(\cdot)$把线性预测子$\bm \eta$和因变量$\bm Y$的期望$\bm
\mu$联接起来，其一般形式为$g(\bm \mu)=\bm \eta=\bm{X\beta}$。函
数$g(\cdot)$必须单调可微。对于单调函数，我们可以定义其反函
数$g^{-1}(\cdot)$，此时有$g^{-1}(g(\mu))=\mu$。联接函数的选择依赖于数据
的类型。在经典线性模型中，因变量服从连续的正态分布，期望和线性预测子是
相同的，所以恒等联接是合理的，此时$\bm \eta$和$\bm \mu$都可以取实数轴上
的任意值。对于计算数据和泊松分布，期望必然大于0，此时使用恒等联接函数则
不太合适，因为$\bm \eta$可以为负值而$\bm \mu$不可以。对于泊松分布，联接
函数可以为对数函数，即$\bm \eta=\log \bm \mu$，它的逆函数为$\bm
\mu=e^{\bm \eta}$。对于二项分布，我们有$0<\bm \mu<1$。联接函数应该把区
间$[0,1]$映射到整个实数轴上。这时主要考虑三种联接函数：logit，probit和
互补log-log联接。此外，当期望为正值时，一种重要的联接函数是指数函数。下
面我们把重要的联接函数列举出来。

1\. 恒等联接：$\bm \eta=\bm \mu$，逆函数为$\bm \mu=\bm \eta$，
此时$\bm \mu$可以为任意实数值。

2\. log联接：$\bm \eta=\log \bm \mu$，逆函数为$\bm \mu= e^{\bm
\eta}$，此时$\bm \mu > 0$。

3\. logit联接：$\bm \eta=\log[\bm \mu/(1-\bm \mu)]$，逆函数为
$\bm \mu=[e^{\bm \eta}/(1+e^{\bm \eta})]$，此时$\bm \mu$的取值范围为$[0,1]$。

4\. probit联接：$\bm \eta=\Phi^{-1}(\bm \mu)$，其中
$\Phi(\cdot)$是标准正态分布累计分布函数，逆函数为$\bm \mu=\Phi(\bm
\eta)$，此时$\bm \mu$的取值范围为$[0,1]$。

5\. 互补log-log联接：$\bm \eta=\log[-\log(1-\bm \mu)]$，逆函数为
$\bm \mu=1-\exp[-\exp(\bm \eta)]$，此时$\bm \mu$的取值范围为$[0,1]$。

6\. 指数函数联接：
$$\bm \eta=\frac{\bm \mu^{\lambda}-1}{\lambda},\quad \lambda \neq 0，$$
其极限值为 $$\bm \eta=\log \bm \mu; \text{当}\lambda \rightarrow 0.$$
或者写成 $$\bm \eta= \left \{
    \begin{array}{lr}
      \bm \mu^{\lambda},& \lambda \neq 0,\\
      \log \bm \mu, & \lambda=0.
    \end{array} \right .$$
指数函数联接的例子有：$\bm \eta= \bm \mu^{2};\bm \eta= 1/ \bm \mu;\bm
\eta= \sqrt(\bm \mu)$和$\bm \eta= \log(\bm \mu)$，即log联接是指数函数联
接的特殊情况。这些都属于Box-Cox型变换。当$\lambda \neq 0$，指数函数联接
逆函数为$\bm \mu =e^{\frac{\ln (\lambda \bm
    \eta+1)}{\lambda}}$。当$\lambda = 0$，逆函数为$\bm \mu= e^{\bm
  \eta}$。

联接函数可以把一些看起来不具有线性结构的模型转化为线性模型。例如，当分别
采用logit和互补log-log联接时，Logistic和Gomperz增长曲线可以转化为线性
模型。

我们把指数簇分布的标准参数和预测子直接联接起来的联接函数称为标准联接函
数，即 $$\bm \theta=\bm \eta,$$
其中$\bm \theta$是指数簇分布定义中的标准参数。一些常见指数簇分布的标准
联接函数如表所示。

-2ex

0.2em

[&gt;p[4cm]{} &gt;p[3cm]{} &gt;p[5cm]{} ]{} &\
(l)[2-3]{} & 名称 & 函数形式\
正态分布 & 恒等 & $\bm \theta= \bm \eta= \bm \mu$\
泊松分布 & log & $\bm \theta= \bm \eta=\log \bm \mu$\
二项分布 & logit & $\bm \theta= \bm \eta= \log [\bm \pi/(1-\bm \pi)]$\
伽马分布 & 倒数 & $\bm \theta= \bm \eta= \bm \mu^{-1}$\
逆正态分布 & $\text{倒数}^{2}$ & $\bm \theta= \bm \eta= \bm \mu^{-2}$\

\[tab:3-1\]

当因变量的分布是指数簇分布并且尺度参数已知时，使用标准联接函数就可以得
到线性预测子中所有参数的充分统计量。此外，使用标准联接函数的模型具有较
好的统计性质，特别在小样本情况下。但我们并没有充足理由一定要使用标准联
接函数。尽管使用标准联接函数比较方便，但仅仅具有方便性不能取代模型拟合优良
性的选择准则。在具体的应用中，数据可能具有特殊性质或者理论上的要求使得
我们选择非标准联接函数。

### 线性预测子

广义线性模型中的线性预测子$\bm \eta= \bm{X\beta}$和经典线性模型中是相
同的。用$p\times 1$维向量$\bm x_{i}$表示第$i$个单位的$p$个自变量观测值
即$\bm x_{i}=[x_{i1},\cdots, x_{ip}]^{T}$，$\bm \beta$是$p \times 1$维
参数向量，即$\bm \beta=[\beta_{1}, \cdots, \beta_{p}]^{T}$。所有的$\bm
x_{i}^{T}, i=1,\cdots,n$按行拼接成$n\times p$阶矩阵$\bm X$，即
$$\label{eq:semipara-1}
  \bm X= \left [
    \begin{array}{cccc}
      x_{11}& x_{12}& \ldots & x_{1p}\\
      x_{21}& x_{22}& \ldots & x_{2p}\\
      \vdots& \vdots& \ddots & \vdots\\
      x_{n1}& x_{n2} & \ldots & x_{np}
    \end{array}
  \right].$$ $\bm X$被称为**设计矩阵**。

广义可加模型 {#sec:gener-addit-models}
------------

目前为止我们仅仅讨论了在线性模型框架下的半参数模型，但我们可以使用半参
数来估计各种类型的回归模型。我们把上一节讨论的广义线性模型应用到半参数
回归模型中就得到广义可加模型(GAM)。下面先对广义可加模型进行模型设定，
再对广义可加模型的估计方法和推断技术进行讨论。

### 模型设定

上一节讨论的GLM框架有助于说明为什么具有离散因变量的回归模型也需要半参数
方法。在GLM框架下，模型有三个部分:随机部分，系统部分和连接函数。我们必
须根据实际问题的情况来选择这三个部分。我们必须注意的是：GLM的基本函数形
式仍然是线性可加的。系统部分中的函数形式是线性的，在使用连接函数之后才
具有非线性。例如在一个Probit模型中，Probit模型的系统部分是线性的，在使
用正态分布累计函数之后，就把线性函数转化为一个非线性的概率度量。

我们可以改变系统部分的函数形式以放松线性和可加的假设。可以在函数形式
中增加额外的部分以引入交互项。重要的是，如果真实模型是变量的非线性形式，
那么这个非线性必须在系统部分中建模。连接函数对于自变量的非线性无能为力。例
如，如果系统部分的真实形式为 $$\label{eq:semipara-93}
  \eta_{i}=\alpha+\beta_{1}X_{1i}+\beta_{2}X_{2i}^{2}.$$
无论使用什么样的连接函数，二次项都必须在系统部分中引入。因此，如果系统
部分使用线性函数，一些非线性将不能被拟合，此时，模型中仍存在设计误差，
尽管它们是非线性模型。实际上，在GLM框架中对于大多数模型来说，设计误差变
得更为严重。在线性回归模型中，设计误差仅仅影响相关的自变量。但对于许多
具有非线性连接函数的GLM模型来说，不相关的变量也会影响设计误差，从而影响
估计(Yatchew，Griliches, 1985)[@yatchew1985specification]。因此，
无论选择何种连接函数，GLM模型系统部分中的非线性仍然没有办法消除。这时，
非参数方法可以对GLM中系统部分的非线性进行建模。这就得到广义可加模
型(GAM)，正与可加模型扩展了线性模型一样，GAM扩展了GLM。

为了设定GAM，我们允许GLM中系统部分的线性函数变为一些来自自变量的光滑函
数。一般地，广义可加模型具有以下形式： $$\label{eq:semipara-gam}
g(\mu_{i})=\bm{X\beta}+f_{1}(x_{1i}) + f_{2}(x_{2i}) + \cdots$$ 其中
$$\mu_{i} = \mathbb{E}(Y_{i}),\text{并且~} Y_{i}
  \overset{\text{i.i.d}}{\sim} \text{~指数分布簇中某一分布.}$$
$Y_{i}$是因变量，$\bm X$是设计矩阵，$\bm \beta$是对应的参数向量，
$f_{j}(\cdot)$是自变量$x_{k}$的光滑函数。

例如，对于一 个标准的GLM，我们可以把它的系统部分写为：
$$\label{eq:semipara-94}
  \eta=\alpha+\beta_{1}X_{1}+\beta_{2}X_{2}.$$
我们把这个线性函数改写为光滑非线性函数形式，就得到GAM的系统部分为：
$$\label{eq:semipara-95}
  \eta=\alpha+f_{1}(X_{1})+f_{2}(X_{2}).$$

这里，我们用两个从数据估计出的光滑函数来代替线性预测子中的参数。可加
假设仍然保留，因为其有助于对非参数回归进行解释。我们可以有限度的放松可
可加的假设以对非线性交互作用进行建模。使用GAM，我们仍然可以使用假设检验
来检验非参数回归对线性拟合或对幂转换拟合。像可加模型一样，GAM中如果不包
括参数项，那么其作用有限，而且加入参数项并不困难。
第 \[sec:addit-semip-regr\] 节的半参数回归模型可以扩展到离散数据模型。
对离散数据建模的半参数方法为诊断和拟合非线性提供了一套灵活的框架。尽
管GAM实质上不是半参数回归模型，但GAM这个术语经常应用到半参数GLM中。在下面
的讨论中，我们采取这个约定。因此，术语GAM同时包括可加GLM和半参数GLM。

### 模型估计

GLM的估计可以使用Newton-Raphson算法的直接最大似然估计法或迭代的再加权最
小二乘 法(IRLS)(Hardin，Hilbe,2007)得到[@hardin2007generalized]。
Newton-Raphson方法及其变化方法对于我们来说更为熟悉，但实际过程中一般使
用IRLS方法估计GLM，具体可以参考Hardin，Helbe(2007)给出的一个关于每种算
法的概述。IRLS更适合于GAM的估计，因为它把GLM的估计减少到加权最小二乘的
迭代应用。这表明我们可以使用第 \[sec:addit-semip-regr\] 节中给出
的backfitting算法来估计GAM中系统部分的光滑函数。GAM也可以使
用Newton-Raphson方法，但一般很罕见，因为它没有backfitting算法稳定。基于
样条混合模型的GAM采用了Newton-Raphson方法，详细参
见Ruppert，Wand，Carrol(2003)对这个估计程序的介
绍[@ruppert2003semiparametric]。关于用于估计GAM的IRLS算法的基本步
骤，详细可以参 考Hastie，Tibshirani(1990)和
Wood(2006)[@hastie1990generalized; @wood2006generalized]。

IRLS方法的优点是其估计GAM并没有比估计一个可加模型困难多少，而GAM模型的
估计明显比可加模型的计算强度更大。在可加模型里面，我们仅需要运行一
次backfitting算法，而在GAM里面，在IRLS的每一次迭代过程中，我们都必须估
计一个可加模型。在现代计算机上一般估计GAM会稍微慢一点，但对于大数据集来
说，估计GAM等待的时间可能会很明显。

### 统计推断

GAM的推断基础与可加模型和半参数模型相比没有多大改变。估计出的方差协方
差矩阵可以得到非参数项的置信带和对参数项进行假设检验。其它假设检验可以
通过模型的似然比较来进行。

#### 置信带

IRLS方法的另一个优点是方差协方差矩阵的估计仍然是基于
第 \[sec:addit-semip-regr\]节中定义的可加模型的光滑矩阵$\bm R$。为了
达到估计的目的，GAM使用了结果变量和权重的可加模型，这使得方差协方差矩阵
的估计变得简单。首先，我们定义估计的线性预测子$\hat \eta$的协方差。由
于GAM等价于加权可加模型，那么有 $$\label{eq:semipara-96}
  \bm{\hat \eta=Rz}$$
其中$\bm R$是光滑矩阵，$\bm z$是来自线性预测子的连续结果向量，拟合值和
响应值。这表明GAM的方差协方差矩阵为： $$\label{eq:semipara-97}
  \mathbb{V}\bm{(\hat \eta)\approx R\Sigma^{-1}R'}$$
其中$\bm \Sigma$是来自IRLS算法估计的权重集合，约等于号$\approx$表示渐近
相等，这在一般条件下是成立的。这个近似是必须的，因为$\bm R$依赖于IRLS算法
中的$Y_{i}$和$\mu$，因此它不是线性的(Hastie，Tibshirani,
1990)[@hastie1990generalized]。利用这个估计的方差协方差矩阵，我们
可以构建95%的置信带：$\hat f \pm 2\sqrt{\mathbb{V}(\bm{\hat \eta})}.$

#### 假设检验

GAM的假设检验与第 \[sec:addit-semip-regr\] 节中的可加模型和半参数模型
相比没有什么改变。唯一的区别是现在只使用似然比检验。检验统计量为：
$$\label{eq:semipara-98}
  \text{LR}=-2(\text{LogLikelihood}_{0}-\text{LogLikelihood}_{1})$$
其中$\text{LogLikelihood}_{0}$是来自更受限的参数模型的对数似
然，$\text{LogLikelihood}_{1}$是来自更一般的半参数回归模型的对数似然。
在一般条件下，上面似然比检验的统计量是服从$\chi^{2}$分布的，自由度为两
个模型中使用的参数之差。与前面一样，我们使用似然比来检验模型中系统部分
的非线性，具体为检验光滑拟合对线性拟合或转化拟合。

GAM模型的自由度可以像可加模型中一样通过光滑矩阵$R$的迹来计算。残差的自
由度为： $$\label{eq:semipara-99}
  df_{\text{err}}=n-\text{tr}(2 \bm{R-R'\Sigma R\Sigma^{-1}}).$$
对于这两个嵌套模型，它们各自的残差自由度的差就提供了似然比$\chi^{2}$检
验的自由度。

需要注意的是似然比检验统计量的分布理论仍不成熟。实际上，现在仍然不能确
定检验统计量是否服从$\chi^{2}$分布。Hastie，Tibshirani(1990)的模拟证据
表明检验统计量的分布非常接近
于$\chi^{2}$分布[@hastie1990generalized]。自动光滑技术的使用使得统
计量的分布变得更复杂。尽管统计量的分布不确
定，Hastie，Tibshirani(1990)认为$\chi^{2}$分布可以作为一个非正式的模型
比较方法。GAM还有其它的模型比较方法，最简单的就是拟合GAM后画出结果图。
如果拟合接近于线性或二次方形式那么就应该用更节俭参数的线性模型。一个更
正式的方法是利用自助法进行非参数模型比较。关于半参数自助模型比较方法详
细可以参考Keele 2008年的著作[@keele2008semiparametric]。

在这一节里，我们把半参数回归模型推广到了广义线性模型。GLM仍然有一个关键
的线性假设，如果不正确的话，将导致假设误差。半参数方法可以允许我们对非
线性进行诊断和建模。我们将前面讨论的光滑方法和非参数回归模型应用到GLM就
可以得到GAM。与在第 \[sec:addit-semip-regr\] 节一样，我们必须小心以防
止发生过拟合。如果使用自动光滑方法，似然比检验得到的$p$值是一个近似值。
最后，非参数估计比参数估计需要更多的数据。GAM有时候不能收敛，而这
在GLM中则不存在。尽管收敛失败不常见但有可能发生。一旦收敛失败，那么我们
必须依靠完全参数模型。\
在这一章里，我们把第一章讨论的非参数回归模型在可加条件下推广到多元情
况，得到了可加模型和半参数模型。对于可加模型和半参数回归模型，我们详细
讨论了其模型设定，估计方法和统计推断。为把半参数回归模型推广到广义可加
模型，我们比较详细地讨论了广义线性模型，包括其三个组成部分：系统部分，
随机部分和联接函数。最后，讨论了广义可加模型的模型设定，估计方法，置信
带构建和假设检验。与单一的非参数回归模型不同，半参数模型和广义可加模型
在实际建模过程发挥了巨大的作用。但是，半参数模型和广义可加模型仍只能适
用于独立数据建模。对于相关数据，半参数模型和广义可加模型无能为力。混合模
型是相关数据的有力工具，因此在下一章我们将讨论半参数混合模型和广义可加
混合模型。

### 广义线性模型(GLM)

### 线性混合模型和广义线性混合模型(GLMM) {#sec:lme}

混合效应模型是分析分组数据的灵活、强大的工具。分组数据在许多领域中广泛存在，例如
农业、生物、经济、制造业和地质学。纵向数据、重复测量数据，多水平数据、层次数据等
都属于分组数据。经典线性模型中一个典型的假设就是观测值来自一个相同的总体，即是独
立同分布的。而分组数据一般组内的观测值是相依的，因为它们属于相同的自总体，而组间
是独立的。混合效应模型可以对分组数据中存在的组内相关进行建模，并且为平衡数据和非
平衡数据提供了统一的分析框架。混合效应模型是非线性统计模型，主要是因为其具有复杂
的方差结构。混合模型的出现把线性模型带入了一个更广阔的空间。从混合模型的理论发展
过程来看，最开始讨论的是线性混合模型，然后又发展到广义线性混合模型。

#### 线性混合模型

线性混合模型在生物、医学、经济、金融、环境保护、工业设计等领域都具有广
泛应用。但是,在不同的领域有一些特殊的模型。混合效应模型的理论起源较多，
根据应用领域、模型用途和强调的侧重点不同，不同领域中有不同的称呼。在社
会学研究中，它经常被称为多层次模型(multilevel models)或分层模
型(hierarchical models)；在生物统计研究中则有增长曲线模型；计量经济学文
献称之为随机系数模型 (random coefficient models)和面板数据模型。

混合效应模型除了用于分组数据建模外，其对于理解其他一些统计方法也有重要
作用。混合模型的作用非常广泛。Demidenko(2004)指出混合效应模型可以用于以
下目的[@demidenko2004mixed]：拟合复杂的相关数据，包括纵向数据，分
层数据、空间数据等。拟合具有多变异性的数据；拟合异方差数据；作为频率方
法和贝叶斯方法的折衷方法；作为罚似然统计模型；处理参数多维性。

混合效应模型像其他统计模型一样，是用来描述一个因变量和多个自变量之间的
关系。在混合效应模型中，至少有一个自变量是分类变量，其用来代表数据中实
验或观测的单位。分类变量可以取离散水平值。与自变量水平相关联的参数有
时候也被称为水平的效应。如果变量水平的取值是固定并且是可复制的，那么
用**固定效应**参数来对这个自变量建模。如果观测到的水平值代表了该
自变量所有可能取值水平的一个样本，我们则在模型中加入**随机效应**。

区分固定效应参数和随机效应需要注意两点：第一，这两个名字具有误导性，因
为固定和随机的区分更多的是针对分类自变量取值水平的性质，而不是与水平相
关联的效应的性质。第二，注意区分“固定效应参数”和“随机效应”的本质。
固定效应参数就是我们在统计模型中碰到的普通意义上的参数。而随机效应严格
来讲，并不能算参数，实际其为未观测到的随机变量。

从前面的叙述我们看到，混合模型包括一大类模型，适用于各种类型的相关数据。
下面就以纵向数据为例的给出线性混合模型的模型设定。

纵向数据研究一般是考查对个体单位重复测量的特征随时间的变化规律。每个个
体单位在不同的时间点，甚至不同的外界条件下进行重复观测。通常，我们不能
控制观测时的外界条件，并且被观测的个体数量和观测时间可能发生较大变化。
纵向数据通常难以用未限制协方差结构的普通多元模型分析，而混合模型是分析
纵向数据的有力工具。纵向数据混合模型的研究最先由Laird，Ware(1982)年的
一篇论文中给出[@laird1982random]。

线性混合模型可以表示成 $$\begin{aligned}
  \label{eq:13}
  y_{ij}=&\beta_{1}x_{1ij}+\cdots+\beta_{p}x_{pij}
  +b_{i1}z_{1ij}+\cdots+b_{iq}z_{qij}+\varepsilon_{ij} \\
  b_{ik}\thicksim& \mathcal{N}(0,\sigma^{2}\psi_{k}^{2}),
  \text{Cov}(b_{k},b_{k'})=\sigma^{2}\psi_{kk'} \nonumber \\
  \varepsilon_{ij} \thicksim &\mathcal{N}(0,\sigma^{2}\lambda_{ijj}),
  \text{Cov}(\varepsilon_{ij},\varepsilon_{ij'})
  =\sigma^{2}\lambda_{ijj'} \nonumber\end{aligned}$$
其中$y_{ij}$表示所有$M$组中第$i$组，该组中所有$n_{i}$观测值中的
第$j$个。$\beta_{i},\cdots,\beta_{p}$是固定效应参数，对所有组都是相同
的。$x_{1ij},\cdots,x_{pij}$表示$p$个固定效应回归子第$i$组第$j$个观测值；
第一个回归子通常取常数，即$x_{1ij}=1$。$b_{i1},\cdots,b_{iq}$是第$i$组
的随机效应，假设其服从多元正态分布。随机效应随着组的不同而不
同。$b_{ik}$被认为是随机变量，而不是参数，在这个意义上，其与误差
项$\varepsilon_{ij}$相类似。$z_{1ij},\cdots,z_{qij}$是随机效应回归
子。$\sigma^{2}\psi_{k}^{2}$是随机效应的方差，$\sigma^{2}\psi_{kk'}$是
随机效应的协方差，随机效应方差和协方差被假定为是常数，不随着组的不同而
不同。在一些应用中，这些$\psi$的值可以用一些相对较少的基本参数来表
示。$\varepsilon_{ij}$是组$i$第$j$个观测值的误差项。第$i$组的误差项被假
定服从多元正态分布。$\sigma^{2}\lambda_{ijj'}$是第$i$组误差项之间的协方
差。通常$\lambda_{ijj'}$可以用一些基本参数对其进行参数化，它们的具体形
式依赖于具体问题。例如，当观测值是在组内独立抽样时，这时假定具有不变的
误差项方差，$\lambda_{ijj}=1,\lambda_{ijj'}=0(\text{当}j\neq
j'\text{时})$，此时唯一需要估计的参数就是相同的误差项方差$\sigma^{2}$。
当组内的观测值表示来自同一个个体的纵向数据时，此时$\lambda$的结构必须设
定为可以体现误差项之间自相关关系。

将模型改写成矩阵形式有 $$\begin{aligned}
  \label{eq:14}
  \boldsymbol{y_{i}}=&\boldsymbol{X_{i}\beta+Z_{i}b_{i}+\varepsilon_{i}}, \quad
  i=1,\cdots , M,\\
  \boldsymbol{b_{i}}\thicksim&\boldsymbol{\mathcal{N}}(\boldsymbol 0,\sigma^{2} \boldsymbol \Psi)\nonumber\\
  \boldsymbol{\varepsilon_{i}}\thicksim&\boldsymbol{\mathcal{N}}(\boldsymbol 0,\sigma^{2} \boldsymbol \Lambda_{i})\nonumber\end{aligned}$$
其中 $\boldsymbol{y_{i}}$是第$i$组观测值的$n_{i}\times 1$因变量向量。
$\boldsymbol{X_{i}}$是第$i$组观测值的固定效应$n_{i}\times p$模型矩阵。
$\boldsymbol{\beta}$是固定效应系数的$p\times 1$向量。
$\boldsymbol{Z_{i}}$是第$i$组观测值的随机效应$n_{i}\times q$维模型矩阵。
$\boldsymbol{b_{i}}$是第$i$组随机效应$q\times 1$向量。
$\boldsymbol{\varepsilon_{i}}$是第$i$组观测值的误差项$n_{i}\times 1$向量。
$\sigma^{2}\boldsymbol{\Psi}$是随机效应的$q\times q$协方差矩阵。
$\sigma^{2}\boldsymbol{\Lambda_{i}}$是第$i$组误差项的$n_{i}\times n_{i}$
协方差矩阵。

形式中的$M$个等式可以表示成一个更浓缩的形式 $$\label{eq:15}
  \boldsymbol{y=X\beta+Zb+\varepsilon},$$ 其中 $$\label{eq:16}
  \boldsymbol{y=}
     \left [
      \begin{array}{c}
        \boldsymbol y_{1}\\
        \boldsymbol y_{2}\\
        \boldsymbol \vdots \\
        \boldsymbol y_{M}
      \end{array}\right ],
    \boldsymbol{X=}
     \left [
      \begin{array}{c}
        \boldsymbol X_{1}\\
        \boldsymbol X_{2}\\
        \boldsymbol \vdots \\
        \boldsymbol X_{M}
      \end{array}\right ],
    \boldsymbol{Z=}
     \left [
      \begin{array}{ccc}
        \boldsymbol Z_{1} & \boldsymbol 0 & \boldsymbol 0\\
        \boldsymbol 0& \boldsymbol \ddots & \boldsymbol 0\\
        \boldsymbol 0& \boldsymbol 0 & \boldsymbol Z_{M}
      \end{array}\right ],
    \boldsymbol{b=}
     \left [
      \begin{array}{c}
        \boldsymbol b_{1}\\
        \boldsymbol b_{2}\\
        \boldsymbol \vdots \\
        \boldsymbol b_{M}
      \end{array}\right ],
    \boldsymbol{\varepsilon=}
     \left [
      \begin{array}{c}
        \boldsymbol \varepsilon_{1}\\
        \boldsymbol \varepsilon_{2}\\
        \boldsymbol \vdots \\
        \boldsymbol \varepsilon_{M}
      \end{array}\right ]$$
分别是$N\times 1, N\times p, N\times Mq, Mq\times 1, N\times 1$阶向量或
矩阵，其中$N=\sum_{i=1}^{M}n_{i}$是所有观测值的个数，$\text{Cov}(\boldsymbol
b)=\sigma^{2}(\boldsymbol{I \otimes \Psi})$，$\text{Cov}(\boldsymbol
\varepsilon)=\sigma^{2}(\boldsymbol{I \otimes \Lambda_{i}})$。

进一步，模型可以写成只包含一个误差项的形式为 $$\label{eq:17}
  \boldsymbol{y=X\beta+\eta},$$ 其中 $$\boldsymbol \eta= \left[
    \begin{array}{c}
      \boldsymbol \eta_{1}\\
      \boldsymbol \eta_{2}\\
      \boldsymbol \vdots\\
      \boldsymbol \eta_{M}
    \end{array} \right ] =
  \left[
    \begin{array}{c}
      \boldsymbol{\varepsilon_{1}+Z_{1}b_{1}}\\
      \boldsymbol{\varepsilon_{2}+Z_{2}b_{2}}\\
      \boldsymbol \vdots\\
      \boldsymbol{\varepsilon_{M}+Z_{M}b_{M}}
    \end{array} \right ].$$
此时， $E[\boldsymbol \eta]=\boldsymbol 0$ ，$\boldsymbol \eta$ 的协方差矩阵为 $N \times N$ 阶块状对角矩阵形式： 
$$\label{eq:18}
  \boldsymbol V =\sigma^{2} \left [
    \begin{array}{cccc}
      \boldsymbol{\Lambda_{1}+Z_{1}\Psi Z_{1}^{T}} & \boldsymbol 0 & \boldsymbol 0 &\boldsymbol 0 \\
      \boldsymbol 0 &  \boldsymbol{\Lambda_{2}+Z_{2}\Psi Z_{2}^{T}} & \boldsymbol 0&\boldsymbol 0\\
      \boldsymbol \vdots &\boldsymbol \vdots &\boldsymbol \ddots &\boldsymbol \vdots \\
      \boldsymbol 0 &\boldsymbol 0 &\boldsymbol \ldots &  \boldsymbol{\Lambda_{M}+Z_{M}\Psi Z_{M}^{T}}
    \end{array} \right ].$$ 

上面的设定尽管模型和的形式比简单，但其符号的说明比较复杂。

在随机效应和随机误差项服从正态分布的假设下，混合模型可以表示为因变量的
边际分布 
$$\label{eq:20}
  \boldsymbol{y \thicksim \mathcal{N}(X\beta,V)},$$ 
其中 $\boldsymbol{V}$为式所定义。


#### 广义线性混合模型

### 非参数回归和广义可加模型(GAM)

#### 非参数回归



光滑方法和非参数回归一般是可以交换的术语，二者都是指一系列对散点图中二
元变量关系进行概括的统计方法。使用更常见的参数统计方法，两个变
量$x$和$y$之间的关系可以用像回归或相关系数等参数模型来进行概括。使用非
参数回归，不存在任何参数，而是用一条曲线来概括$x$与$y$之间的统计关系，
考虑到统计模型没有产生任何参数，我们通常把这类模型称为**非参数**模型。

假设有两个连续变量$x$和$y$，我们希望估计给定$x$时$y$的期望值。这个关系
可以表示为 $$\label{eq:1}
  y_{i}|x=f(x)+\epsilon_{i},$$
其中$f$表示$y$与$x$之间关系的函数形式，$f$的限制条件为其为光滑
[^2]的。熟悉的线 性方程形式是这种类型函数的一种特殊情形： $$\label{eq:2}
  f(x)=\alpha+\beta x$$
由于线性关系是光滑函数，因此它是光滑函数族的特殊情况。线性回归模型是参
数模型，因为参数$\beta$概括了$x$与$y$之间的统计依赖性。如果我们使用
非参数回归模型，将不存在参数，但我们可以作更少的假设。在线性回归模型中，
我们假设$f$为线性的，我们继续来估计$\hat \beta$。然而$f$可能为线性
的，$f$也可能为非线性的。当使用非参数回归时，我们利用数据来估计$f$的函
数形式。所以，事先的线性假设被更弱的假设光滑总体函数所代替。这个更弱的
假设的代价是两方面的：第一，计算方面的代价是巨大的，但考虑到现代计算技
术的速度，这不再是很大的问题；第二，我们失去了一些可解释性，但一些可解
释性的丢失是值得的，因为我们得到了回归方程一个更具代表性的估计。存在非
常多的估计$f$的非参数回归方法。

### 局部平均

取每一个$x$值处的局部平均值是最简单的非参数回归函数模型。这个非参数回归
模型称移动平均光滑器。移动平均最大的优点是其简易性，但使用每一个$x$值处
的局部均值有几个缺点。即使对于一个大样本，我们也不一定在每一个$x$值处都
有足够多的收入观测值，从而导致局部平均$\bar y$不精确且随着$x$大幅波动。
我们可以采用不同的方法把$x$的范围进行划分来减小局部估计$\bar y$的变异性。
不使用每一个$x$值处的局部估计，而是把$x$的范围划分为区间或称之为“窗”。
只要每一个“窗”中包含足够多的数据点，局部估计$\bar y$将是稳定的。局部
估计$\bar y$的变异性直接受窗的宽度影响。

缩小窗的宽度减少了用于每个局部估计$\bar y$的数据点的个数，从而增加了局
部估计的变异性。增加窗的宽度将增加窗中的数据点的个数，从而使局部估计
$\bar y$的变异性减小。窗的宽度与局部估计的变异性之间的关系对于来源于局
部平均的线图的非参数估计有着直接的影响。更宽的窗估计造成更光滑的拟合，
而较窄的窗导致局部估计之间的线高度变化。选择合适的窗宽度在非参数中是一
个重要的概念，我们在后面会经常回到这个问题。对于大的数据集来说，选择较
窄的窗没有多大的问题，因为在每一个窗中都足够多的观测值。然而，对于许多
数据集来说，过窄的窗宽将导致非参数估计过于粗糙。

有几种不同的方法来“窗化”数据。一种办法是把$x$分成等宽的窗，但是窗的均
值只有在数据在$x$的范围内服从均匀分布时才是稳定的。尽管这是可能的，但是
通常我们不能保证变量$x$总是服从均匀分布。另一种选择就是把$x$的取值范围
分成含有大概相等数量观测值的窗。但是在实际中，这种方法会由于观测值不够
仍然产生高度变化的非参数估计。解决办法是不把$x$的取值范围分成不相重叠的
区间，而是定义一个移动的窗口在整个$x$范围内移动，观测值进出这个窗中。这
样，在计算局部均值时观测值可被重复利用。这种类型的窗使用关注点$x_{0}$，
即正好落在窗中点的$x$的值，来定义宽度。现在我们来决定窗的宽度以确定多
少$x$的值包含在关注的两侧。为了保证关注点正好在每一个窗的中点，因此对每
一个窗取奇数个观测值。扩大窗的宽度导致更多的观测值参与计算局部均值，减
小由局部均值构成的非参数估计的变异性。移动窗口的一个缺点是它在$x$的最小
值和最大值处不能产生好的估计。当$x_{1}$是第一个关注点时，在窗的左边没有
任何观测值，对于$x_{n}$也一样，窗的右边没有任何数据($n$为样本容量)。这
导致在边界处的曲线虚假扁平，这一般被称之为边界偏倚。

### 核光滑

目前为止，我们使用$y$的均值作为局部估计。但是简单均值不适宜作为局部估计。
非参数回归的目的是得到忠于$x$与$y$之间局部关系的估计。但简单均值无论离
关注点的距离如何，都赋予$x$和$y$的值以相等的权重。但使用不加权的均值对
于移动窗是有问题的，因为在局部平均中观测值被重复利用。不考虑观测值与关
注点之间的距离而赋予所有的观测值以相同的权重是没有什么意义的。如果我们
赋予靠近关注点的观测值更大的权重，而赋予靠近窗的边界处的观测点以更小的
权重，就可以得到一个更忠于$y$与$x$之间局部关系的非参数估计量。

核光滑非参数回归模型通过使用加权平均重新定义了移动平均光滑方法。我们所
需要的是一个函数，它可以给靠近关注点的数据比远离关注点的观测值以更大的
权重。在考虑加权均值的形式之前，我们需要找到一个测量观测值与关注点距离
的方法。我们将使用这个距离的测度值在加权平均中赋权。一个常见的距离测度
为 $$\label{eq:6}
  z_{i}=\frac{(x_{i}-x_{0})}{h}.$$
$z_{i}$测量了相对的、正负的第$i$个观测值与关注点$x_{0}$之间的距离。调
正因子$h$称为核估计的带宽，它控制了窗宽，也就控制了非参数估计的光滑或
粗糙程度。

我们现在需要一个函数来赋予数据实际的权重。我们把权重函数称为核函数：
$K(z)$。核函数把最大的权重赋给离关注点$x_{0}$最近的点，也就是$z_{i}$值
小的观测值。随着$|z|$值的增大，此函数光滑对称的给予较小的权重。核函数
以$z_{i}$为自变量来计算每个观测值的权重，然后用于计算局部加权均值。在
每一个窗内把核函数$K$应用到正负的、相对的距离就得到每个窗的权重集合：
$$\label{eq:7}
  w_{i}=K[(x_{i}-x_{0})/h].$$ 权重$w_{i}$用于计算局部加权平均数：
$$\label{eq:8}
  \hat f(x_{0})=\frac{\sum_{i=1}^{n}w_{i}y_{i}}{\sum_{i=1}^{n}w_{i}}.$$

原则上，存在许多不同的核函数可以用于计算局部平均中的权重。不管核函数的
形式是什么，它必须具有一定的性质。首先，核函数必须是关于关注点对称的。
其次，权重必须是正的，并且我们希望权重从关注点到窗的边界光滑的下降。有
许多不同的函数满足这些要求，但最常用的核是三次立方(tricube)核：
$$\label{eq:9}
  K_{T}(z)=\left\{
    \begin{array}{lr}
      (1-|z|^{3})^{3}&\text{当} |z|<1,\\
      0&\text{当} |z|\geq 1.
    \end{array}\right.$$
三次立方核的一个优点就是其计算简单。在早期光滑方法应用中，这是它被推荐
的主要原因。现在，虽然计算问题影响不大，但这个核仍然被广泛使用。另一个
经常使用到的核是正态核，它是把标准正态分布的密度函数应用到$z_{i}$的值上
面： $$\label{eq:10}
  K_{N}(z)=\frac{1}{\sqrt{2\pi}}e^{-z^{2}/2}.$$

使用三次立方核和正态核得到的非参数估计的差异一般可以忽略。注意到实际上
简单移动平均也是一个核光滑器。简单移动平均光滑器具有一个矩形核。对于矩
形核，我们给予窗中的每一个观测值以相等的权重，也就产生了一个没有加权的
局部平均值。矩形核为 $$\label{eq:11}
  K_{R}(z)=\left \{
  \begin{array}{lr}
    1&\text{当} |z|<1,\\
    0&\text{当} |z|\geq 1.
  \end{array}\right.$$

尽管核光滑器相对于简单移动平均估计来说是一个改进，但他们仍然有很大的缺
点。核光滑器的主要缺点在于：无论是加权的还是没加权的均值，都不是一个最
优的局部估计量。因此，在实际应用过程中很少使用核光滑器。但是加权和移动
窗的思想仍然是重要的，使用局部回归估计而不是局部均值可以得到一个更优的
非参数回归模型。

局部多项式回归 {#sec:loc-poly-reg}
--------------

目前为止我们已经使用均值作为估计量来计算$y|x$的局部估计。使用均值作为局
部估计量的主要原因是其计算简单。很久以来非参数回归被认为是计算强度大的
统计方法，因为它要求估计许多局部估计量。在过去计算技术不发达时，重复估
计均值的简易性是重要的。但现代计算技术使得这些顾虑不复存在。实际上，使
用其它局部估计量可以获得更好的统计性质。

### 局部回归光滑器

替代均值作为局部估计量的一个显然的办法就是使用最小二乘估计。实际上，许
多广泛使用的非参数回归模型都是基于局部回归估计而不是局部平均估计，因为
回归具有均值所不具有的偏倚缩减性质。非参数回归估计的基本算法几乎仍然与
核光滑是一样的。我们构建一系列由研究者确定宽度的窗。在每个窗内，做$y$
对$x$的回归，局部估计就是在关注点$x_{0}$处的预测值。在每个窗内重复这个
过程，然后把每个预测值连接起来就得到了$f$的非参数估计。

Cleveland(1979)首先提出局部回归光滑器，大部分统计软件包使用他提出的算法。
他提出的局部回归方法**loess**及其变种**lowess**是使用最多的非
参数回归模型之一[@cleveland1979robust]。这两种光滑器在几个方面都比
目前为止介绍的局部回归思想复杂。下面对Cleveland的非参数回归模型进行讨
论。

Cleveland提出了一个多项式回归模型而不是线性回归的局部估
计[@cleveland1979robust]。预测变量$x$的$p$阶多项式回归为 $$\label{eq:12}
  y=\alpha+\beta_{1}x+\beta_{2}x^{2}+\cdots+\beta_{p}x^{p}+\epsilon.$$
如果$p=1$那么拟合是线性的，如果$p=2$那么拟合是平方的，等等。多项式阶数
的选择可以根据研究的需要，但一般高于2阶的多项式对于通过非参数估计的表
现作用有限。

下面的递归拟合过程得到非参数回归估计量：

首先，对于窗中的每一个$x$的观测值都计算出权重。计算方法与前面介绍的核光
滑的权重计算方法相同。Cleveland推荐使用三次立 方核。

其次，在窗内使用权重为$w_{i}$的加权最小二乘估计拟合局部多项式回归模型。
具体地，我们估计下面的局部回归模型： $$\label{eq:13}
  \frac{y_{i}}{w_{i}}=\alpha+\beta_{1}\frac{x_{i}}{w_{i}}+\beta_{2}\frac{x_{1}^{2}}{w_{i}}+\cdots+\beta_{p}\frac{x_{i}^{p}}{w_{i}}+\frac{\epsilon_{i}}{w_{i}},$$
可以通过最小化加权残差平方和$\sum_{i=1}^{n}w_{i}e_{i}^{2}$来得到参数的
估计值。尽管一般使用三次立方核，但其它权重也是可能的。在最初的加权最小
二乘拟合后，基于局部拟合的残差的新的具有稳健性的权重就可以计算出来。将
具有较大残差的观测值赋予较小的权重，具有较小残差的观测值赋予较大的权重。
这些稳健性权重为 $$\label{eq:14}
  \delta_{k}=B(e_{k}/6s),$$
其中$e_{k}$是局部残差，$s$是$|e_{k}|$的中位数，$B$是双二乘(bisquare)核
函数，其与三次立方核除了使用二阶多项式之外，其它都是相同的。基于这些新
的权重，可以再次进行局部加权拟合，重复这个过程，直到局部估计的变化幅度
小于定义的容忍水平。

最后，计算出在关注点$x_{0}$处$y$的拟合值。在每一个窗内重复这个过程，得
到每一个窗的拟合值，然后把这些拟合值用线段连接起来最后得到非参数回归估
计。

局部回归程序没有权重时也可以进行。实际上，有无权重就是**loess**和
**lowess**的区别。前者是**local regression**的简称，后者是 **local
weighted regression**的简称。这两者之间的区别在实际使用当 中一般很小。

局部多项式回归中带宽的选择仍然是重要的。界定带宽的方法不是通过定义在关
注点两侧观测值的个数来确定，而是通过窗中包含的观测值的个数占总数据点个
数的比例来确定。这个比例一般称为局部回归光滑器的**幅度(span)**，一
般用$s$来表示。每一个窗中包含的观测值的个数就为$m=[sn]$。

从统计性质上讲，局部回归模型要优于局部平均光滑。Fan and
Gijbels(1992)和Fan(1993)展示了局部线性拟合具有一些局部平均所不具有的非
常好的性质[@fan1992variable; @fan1993local]。他们证明了与局部平均非
参数回归相比，局部多项式回归拟合可以缩减$\hat f$的偏倚。局部多项式回归
的偏倚缩减性质在边界处表现的最为明显，而核估计量在边界处趋于使非参数拟
合变平。

### 非参数模型选择 {#sec:nonpara-model-choice}

非参数回归允许我们对$x$与$y$之间统计关系的函数形式做最少的假设，其函数
形式完全从数据进行估计。这与线性回归模型有着显著的区别，因为线性回归模
型要求我们事先假设函数具有线性函数形式。我们放松了函数形式假设的同时，
也必须承担一些代价，也就是必须进行一些模型选择，而这对于参数模型是不需
要的。我们至少必须选择局部回归模型的多项式阶数和窗的宽度值。如果使
用，我们还可以改变局部估计的权重方程。下面我们考虑这些选
择如何影响非参数回归估计。我们期望对于这些选择，非参数估计具有不变性，
或者说，我们期望在这些模型选择的设置中，非参数估计具有稳健性。马上可以
看到窗宽的选择在模型选择中是最重要的。不加权的拟合与加权
的拟合的区别也很小。局部回归估计的多项式的阶数在实际应用
中也影响不大。下面我们首先讨论窗宽的选择如何影响非参数回归估计。

#### 窗宽

窗宽的选择是在使用非参数回归时必须作出的最关键的选择。这是因为对于许多
统计模型来说，偏倚和方差通常是一个此消彼长的关系。在非参数回归中，这个
平衡就体现在窗宽的选择之中。如果窗宽太大，非参数回归估计偏倚会增大，但
是如果窗宽过小，估计将会过拟合，导致方差膨胀，从而影响估计的置信带。在
最开始，可能会对选择带宽特别关注，否则非参数估计将有问题。实际上，整体
上非参数回归估计在带宽值很大的范围内都是不变的，偏倚和过估计只有在窗宽
取极端值时才会出现。

下面用一个模拟数据的例子来展示如何选择带宽实现偏倚方差平衡。例子中模拟
的数据产生过程是$y=x\cos (4 \pi x)+0.3 \epsilon$，其中$x$是从1到50的系
列，$\epsilon \sim \mathcal{N}(0,1)$。我们使用来估计拟
合的$x$与$y$之间的非线性关系。窗宽分别取0.0001，0.3和0.6，得到3个不同
的拟合。在这个例子中，我们包含了估计的95%置信带。


图 \[fig:2-9\] 中显示了3个估计的图形和置信带，两条垂直
实线代表了带宽，虚线代表真实的回归方程，实线是估计的非参数回归曲线，并
给出了其置信带[^3]。在最
上面的图形中，窗宽设置为0.0001，由于窗宽很小，局部估计非常忠
于$x$与$y$之间的局部关系，但是由于在每一个窗中包含的数据都很少，估计具
有很大的变异性。注意到这时的变异带是很宽的。很小的窗宽的结果就是非参数
回归估计的偏倚较小而方差膨胀，具有较宽的置信带。此时，我们过拟合了数据，
使用了比需要概括$x$与$y$之间关系更多的参数。在非参数回归的背景下，我们
称这种过拟合为欠光滑。在图 \[fig:2-9\] 中的第二个图形中，非参数估计的
带宽是0.30。这时的拟合的变异性要小得多，但是在峰和谷处估
计与真实曲线有较大差异。与第一个拟合相比，我们降低了变异性，但此时估计
的偏倚有一定增大。我们称这些与真实回归方程的差异为过光滑。但值得注意的
是，这些偏倚没有导致估计改变真实非线性函数的形式。此时不应该与那些不能
代表真实回归方程的非线性估计相混淆。图 \[fig:2-9\] 中的第三个图的带宽
是0.6。这时的估计具有严重的过光滑。但是此时的方差较小，
因为我们使用了大部分数据来得到局部估计。方差缩小的代价就
是拟合与真实函数形式不太吻合。显然，如果我们使用100%的
数据来进行每一个局部估计，那么拟合不再是局部的，拟合将与
数据的整体线性拟合相同。

选择带宽，我们必须在偏倚较大但方差较小的过光滑和偏倚较小但方差较大的欠
光滑之间进行决策。过光滑扭曲了真实的回归函数形式而欠光滑导致估计的置信
带较大。窗宽选择的目标就是在不扭曲数据内在形式的条件下，使得选择的带宽
尽可能的产生光滑的拟合(Cleveland,
1993)[@cleveland1993visualizing]。理想的带宽使得偏倚和方差同时最小。
这表示可以使用均方误差准则来进行选择带宽。存在一些估计最优带宽的方法，
但这些方法比较复杂，将在第 \[sec:automated\] 节进行介绍。最简单最常用
的带宽选择方法就是观察试错。实际中标准的试错方法一般以带宽等于0.5开始。
如果拟合的非参数回归估计看起来太粗糙，那么应以一个较小的增量增加带宽，
一般合理的增量为0.1，如果增加带宽后，拟合还是太粗糙，那么继续增加带宽。
如果最初的带宽值或增加之后的带宽值得到一个看起来比较光滑的拟合，那么应
该检查在不使拟合过度粗糙时能否减小带宽。

#### 多项式阶数与权重方程

除了带宽外，我们可以使用不同的多项式阶数来估计局部回归，如果使用
的话，我们可以使用不同的初始权重方程。这两个的选择实际
比带宽对非参数拟合的作用小的多。实际上，一般没有必要调整这两个因素的设
置。首先，我们先讨论改变多项式阶数对于非参数拟合的影响。

高阶多项式比低阶多项式得到更好的内在均值近似，即高阶多项式具有更小的偏
倚。但是高阶多项式模型有更多的参数，这导致更大的变异性，容易趋于过拟合
数据。实际上，多项式阶数和带宽对非参数回归估计有混合的作用。如果保持带
宽不变，比较局部线性拟合和局部二次方拟合，局部二次方拟合具有更大的变异
性，但可以通过调整带宽来补偿增加的变异性。应用上一般选择低阶的多项式和
使用带宽来调整整个拟合(Loader 1999)[@loader1999local]。实际
上Cleveland(1993)不考虑高于二阶的局部多项式回归，因为高阶多项式的局部拟
合很少能改进拟合但却使用了额外的参数[@cleveland1993visualizing]。
如果数据中存在多个Maxima或Minima时，局部线性估计将存在困难，但这种形式
的非线性很罕见。在实际应用中，要么使用局部线性估计，要么把多项式阶数调
整到二次方。许多和实现不允许把多项式阶数调 整超过2阶。

最后，对于光滑器，可以选择不同的权重方程。权重方程对于
偏倚方差平衡的作用很小，但它可以影响视觉质量。最常用的权重方程就是三次
立方函数，它是大多数软件的默认权重。对于大部分实际应用来说，没有必要采
用其它的权重方程。

当考察非参数估计时，我们易于对一些小的凸起或曲线给予某种意义。但我们应
当尽量避免这种现象的出现，因为这些波动常常是由于一些$x$与$y$之间高度局
部的关系造成的。这些凸起也可能是由于对这两个变量关系的过拟合造成的。过
拟合意味着估计的非参数方程关注了数据中很小的、可能是随机的特征。

过拟合是对非参数回归估计常见的批评。使用非参数回归时有可能过拟合数据，
但任何统计模型都可能会过拟合。而且，可以采取一些方法来避免过拟合。首先，
我们应考察非线性的整体模式而不应关注非参数估计中的微小特征。其次，比较
不同类型的光滑器在不同的非参数拟合条件下确保相同非线性出现是有帮助的。
最后，在估计时我们可以以较小幅度增加带宽，这样局部变异性被光滑掉从而阻
止了过拟合。

### 局部多项式回归的统计推断 {#sec:stat-infer}

当使用参数模型时，统计推断集中于估计模型参数的标准误。我们使用标准误联
合误差分布假设得到置信区间和进行假设检验。尽管非参数回归没有产生任何参
数来概括$x$与$y$之间的统计关系，但统计推断仍然以相似的方式进行。在非参
数回归模型中，我们估计非参数估计的置信带，进行假设检验，检验非参数回归
模型对其它嵌套模型。

#### 置信带

估计置信带的过程与线性回归模型估计预测置信区间相类似。这容易理解，因为
局部多项式估计是由一系列局部回归的拟合值构成的。我们可以把非参数回归模
型的拟合值表示成$y_{i}$值的线性组合： $$\label{eq:15}
  \hat y_{i}=\sum_{k=0}^{d}\beta_{k}x_{i}=\sum_{k=1}^{n}s_{ij}(x_{i})y_{i}.$$
拟合值$\hat y_{i}$来自$y_{i}$对$x$值的一个子集的局部加权最小二乘回归。
$s_{ij}(x_{i})$项表示来自每个局部回归的系数，其作为$y_{i}$的权重得到线
性组合。如果我们假设$y_{i}$s是独立同分布，且具有固定方差，即
$\mathbb{V}(y_{i})=\sigma^{2}$。在这个不变方差的假设下，组成非参数回归
估计的拟合值的方差为 $$\label{eq:16}
  \mathbb{V}(\hat y_{i})=\sigma^{2}\sum_{j=1}^{n}s_{ij}^{2}(x_{i}).$$
此时，使用矩阵形式来表示$\hat y_{i}$的方差更为方便。首先，我们把$y$的
预测值的方程改写成矩阵形式 $$\label{eq:17}
  \boldsymbol{\hat y=Sy}$$
其中$\boldsymbol{S}$是一个$n\times n$的光滑矩阵，其第$(i,j)$个元素为
$s_{ij}^{2}(x_{i})$是在每个关注点处的局部回归系数。拟合值的方差容易推
导出来，并且与最小二乘线性估计有着类似的形式: $$\label{eq:18}
  \boldsymbol{\mathbb{V}(\hat y)=S\mathbb{V}(y)S'}=\sigma^{2}\boldsymbol{SS'}.$$
注意到$\sigma^{2}\boldsymbol{SS'}$与来自线性回归模型$y$的方差
$\sigma^{2}\boldsymbol{XX'}$之间的相似性。

此时，我们需要对$\sigma^{2}$进行估计。我们仍然可以利用非参数回归与线性
回归之间的相似性来估计$\sigma^{2}$。在OLS中，利用残差平方和可以得到
$\sigma^{2}$的无偏估计量 $$\label{eq:19}
  \hat \sigma^{2}=\frac{\sum_{i=1}^{n}e_{i}^{2}}{n-2},$$
其中$e_{i}=y_{i}-\hat y_{i}$是第$i$个观测值的残差，$n-2$是残差平方和的
自由度。在非参数回归中，我们采用相似的估计量来估计$\sigma^{2}$。分子几
乎是相同的，都为残差$e_{i}=y_{i}-\hat y_{i}$，其中$\hat y_{i}$为来自每
一个局部回归的预测值。但为了完成类比，我们还需要一个在非参数回归中残差
平方和自由度的计算方法。在线性回归模型中，残差平方和的自由度为
$$\label{eq:20}
\text{tr}(\boldsymbol{I_{n}-H})=n-(k+1)$$
其中$\text{tr}$表示矩阵的迹，$\boldsymbol{I_{n}}$为$n$阶单位矩
阵，$\boldsymbol{H}$为线性回归模型的帽子矩
阵，$\boldsymbol{H=X(X'X)^{-1}X'}$，$k$为自变量个数。在非参数回归中，光
滑矩阵$\boldsymbol{S}$等同于帽子矩阵$\boldsymbol{H}$。我们使
用$\boldsymbol{S}$矩阵来计算非参数回归模型的自由度。在非参数回归模型
中，$\text{tr}\boldsymbol{S}$就是光滑器使用的参数的有效个数。然而，与线
性模型不同的是，自由度不一定是整数。残差的自由度，用$df_{\text{res}}$表
示，就 为：
$\text{tr}(\boldsymbol{I_{n}-S})=n-tr(\boldsymbol{S})$[@hastie1990generalized]
[^4]。因此，估计的误差方差为 $$\label{eq:21}
  \hat \sigma^{2}=\frac{\sum_{i=1}^{n}e_{i}^{2}}{n-\text{tr}(\boldsymbol{S})},$$
拟合值的估计方差则为 $$\label{eq:22}
  \mathbb{V}(\boldsymbol{\hat y})=\hat \sigma^{2}\boldsymbol{SS'}.$$

在分布已知的假设下，我们就可以得到非参数回归拟合的以点为基础的置信带。
如果我们假设误差服从正态分布，或者在大样本的情况下，以点为基础的近似
95%的置信区间为$\hat y \pm 2\sqrt{s_{ii}}$，其中$s_{ii}$对应于
$\boldsymbol{SS'}$的对角元素。每一个拟合值$\hat y_{i}$的95%的置信区间画在
非参数估计的两侧，就得到了非参数估计的置信带。如果置信带与非参数估计曲
线接近，就可以得到精确的估计；如果置信带与非参数估计曲线较远，得到的估计
就不太精确。置信带的宽度高度依赖于在每个关注点处用于估计的观测值的多少。

#### 假设检验

对于非参数回归模型，我们可以进行一些不同的假设检验，因为非参数估计嵌套
了其它的参数模型。因此，$F$检验构成了这些假设检验的基础。线性回归模型
进行的一个标准的假设检验就是总体斜率$\beta$是否等于0($H_{0}:\beta=0$)。
一般地，$p$值小于0.05时，我们拒绝原假设。对于非参数回归模型我们可以用
$F$检验进行类似的假设检验。非参数背景下不存在关系时的$F$检验采取以下形
式： $$\label{eq:23}
  F=\frac{(\text{TSS}-\text{RSS})/(df_{\text{model}}-1)}{\text{RSS}/df_{\text{res}}}$$
其中，$\text{TSS}=\sum(y_{i}-\bar y_{i})^{2}$是总离差平方
和，$\text{RSS}=\sum(y_{i}-\hat y_{i})^{2}$是拟合的非参数模型的残差平方
和，$df_{\text{model}}=\text{tr}(\boldsymbol{S})-1$，
$df_{\text{res}}=n-\text{tr}(\boldsymbol{S})$。简单地说，我们是检验非参
数回归模型对常数模型。得到的常数统计量可以用来计算$p$值，如果其小
于0.05的临界值，就拒绝原假设。如果我们不能拒绝原假设，那么一般认
为$x$与$y$之间没有关系。这种假设检验在经典线性模型中是标准的检验步骤。
在实际过程中，对变量之间的散点图目测就足够判断这两个变量是否相
关，而无须进行严格的检验。

尽管上面的检验是有用的，但一个更重要的检验是检验非参数回归模型对另一个
参数模型。例如，我们可以检验非参数回归拟合对线性回归拟合。如果我们通过
检验非参数回归模型对线性回归模型发现他们都充分地拟合了数据，那么我们就
要使用线性回归模型来描述$x$与$y$之间的关系。如果非参数回归提供了数据的
一个更好的拟合，我们就认为线性回归模型是不正确的，我们必须使用非参数回
归模型来拟合这两个变量之间的非线性关系。我们把这种检验解释为$x$与$y$之
间关系中非线性统计显著性的检验。而且，我们还可以检验非参数回归模型对其
他参数模型如幂变换，甚至对其它非参数回归模型。这个非线性检验是基于近
似$F$检验，因为线性回归模型是非参数回归模型的一个特殊情况。把来自具有更
多限制模型(线性，二次的，等等)的残差平方和记为$\text{RSS}_{0}$，把来自
非参数回归模型的残差平方和记为$\text{RSS}_{1}$，那么检验统计量为
$$\label{eq:24}
  F=\frac{(\text{RSS}_{0}-\text{RSS}_{1})/J}{\text{RSS}_{1}/df_{\text{res}}},$$
其中$J$是两个模型中使用的参数数量之差。当比较线性拟合与非参数拟合时，
$J$为$df_{\text{model}}-2$。得到的检验统计量服从自由度为
$df_{\text{model}}$和$df_{\text{res}}$的$F$分布，如果计算的$p$值小于
0.05，那么应该使用非参数回归模型。尽管我们可以假设整体模型形式为线性方
程形式或幂转换形式等，但我们没有多少证据来证明这些假设的函数形式。非参
数回归模型提供了一个检验这些假设的方法。非参数回归模型通常不是用来替代
参数模型，而是提供一个检验参数假设的方法。

在这一节里，我们探讨了局部多项式。局部多项式回归模型提供了一个灵活的、
强大的估计非线性关系的方法。这个模型的强大之处在于可以通过假设检验对非
参数拟合对线性模型或其它参数的非线性模型进行检验。然而，在使用非参数回
归模型时，我们必须注意不要使用了过小的带宽参数以致过拟合了数据。而且，
不应对局部非线性进行过度解释。

样条光滑 {#sec:splines}
--------

这一节讨论样条光滑器。样条光滑器是另一种用于散点图的非参数回归方法。样
条相对于局部多项式回归来说有几个优点。首先，样条回归具有优于局部多项
式回归的分析基础，因为可以证明样条光滑器是最优均方误差拟合。第二，一类
样条，光滑样条设计为防止过拟合，而过拟合是非参数光滑器的主要关注之一。
第三，估计样条的方法研究仍然比较活跃，而局部多项式回归的研究进展相对静
止。因此，软件中拟合样条模型的方法要优于局部回归的方法。例如，大部分样
条实现方法都产生置信带，而局部多项式回归光滑器则不一定。而且，在下一节
自动光滑中，样条光滑器的估计算法方面会更具有优势。最后，样条更容易集成
到半参数估计中去，他们是许多半参数回归模型中选择的光滑方法。

样条这个名词起源于制图者用于画曲线的一种工具。在这里，样条是在称之为
“**节点**”的点处连接的分段回归函数。关于样条的详细讨论可以参见 De
Boor(2001)[@de1978practical]。最简单形式的样条就是在模型
右边含有哑变量的回归模型，我们使用哑变量使回归线在$X$的范围内一些点处
改变方向。对于最简单的回归样条，分段函数是线性的，后面我们将放松这个限
制。本质上，我们在节点之间的区域内分别拟合回归线，节点将分段回归拟合连
接在一起。样条也是允许我们从数据估计函数形式的局部模型，只不过这时是位
于节点之间而不是窗内的局部模型。

与局部多项式回归一样，对于样条我们也必须进行模型决策。对于局部多项式回
归，我们必须选择多项式的阶数，带宽，和权重方程等因素。对于样条，我们必
须决定分段回归函数的多项式阶数，节点的个数和节点的位置等因素。在
第 \[sec:smooth-local-regr\] 节里，带宽参数的选择，也即用于每一个局部
拟合的数据所占的百分比，是影响非参数估计光滑性的关键因素。对于样条，我
们一样发现对于一些模型选择，拟合是不变的，我们必须关注拟合的光滑程度如
何。对于一些类型的样条，节点的个数将控制光滑的程度，对于另一些类型的样
条，光滑参数将控制光滑的程度。

样条的类型非常多。例如：有回归样条，立方样条，B-样条，P-样条，自然样条，
薄板样条和光滑样条等等。样条的广泛性部分来源于样条的研究进程。通常一种
新类型的样条不是取代了旧类型的样条就是对已存在的方法进行了改进。统计中
最常使用的样条是光滑样条。尽管光滑样条比回归样条更复杂，但他们原理基本
相同。下面我们就讨论一些在非参数光滑中常见的样条。

### 常见样条

#### 简单回归样条 {#sec:simple-reg-spline}

我们以$x$与$y$之间的光滑拟合的基本方程开始： $$\label{eq:29}
  y=f(x)+\epsilon.$$
和从前一样，我们仅仅假设$f$是一些光滑函数，但现在我们想使用一个单一的
普通最小二乘估计的回归模型来估计这个模型，而不是使用一系列局部模型。为
此，我们需要将模型矩阵写出来，这样我们可以用最小二乘估计模
型  。这个过程可以用一个简单的例子来展示。图 \[fig:3-1\] 
给出了两个模拟的$x$与$y$变量之间非线性关系的散点图。$x$与$y$之间的非线
性依赖形式是非常明显的。图 \[fig:3-1\] 中的实线表示这两个变量之间的整
体线性拟合估计。这个估计很明显没有抓住$x$与$y$之间的非线性依赖关系，它
仅仅表明这两个变量之间具有一个相当强的负相关关系。


回归样条背后的逻辑是估计两个单独的回归线并在数据的扭结处连接。第一个回
归线近似地负相关，第二个回归线近似正相关。在这个例子里，我们可以很明显
的辨别$x$与$y$关系之中的变点，因此我们可以很容易的将两条分段回归估计在
变点处进行连接。为了估计样条模型，我们需要指定两个单独的回归线的连接点。
这两条回归线之间连接点的位置，即节点容易找到，因为数据中的扭结很明显。
由于只有两条分段拟合需要连接，这里我们仅需要一个节点。更多的分段拟合就
需要更多的节点。我们把这个节点用$c_{1}$来表示。利用$c_{1}$我们可以写出
以下回归样条模型： $$\label{eq:30}
  y=\alpha+\beta_{1}x+\beta_{2}(x)_{+}+\epsilon$$ 其中 $$\label{eq:31}
  (x)_{+}=\left\{
    \begin{array}{lr}
      x&\text{若} \, x>c_{1},\\
      0&\text{若} \, x\leq c_{1}.
    \end{array}\right.$$
函数$(x)_{+}$表示如果$x$大于节点值，函数值等于$x$，否则等于0。如果我们
假设是分段线性函数，那么我们可以改写方程  为两段单独但相连 的回归直线：
$$\label{eq:32}
  y=\left\{
    \begin{array}{lr}
      \alpha+\beta_{1}x&\text{若}\, x\leq c_{1},\\
      \alpha+\beta_{1}x+\beta_{2}(x-c_{1})&\text{若}\, x>c_{1}.
    \end{array}\right.$$
我们将一个单一的线性模型改写成为两个单独的线性拟合分别来描述$x$与$y$之
间非线性依赖关系的不同部分。为了联立的估计两个分段拟合，我们需要基函数。
基函数是估计样条时的一个重要的概念。

在线性代数中，向量空间的一组**基**是等于空间维度个数且线性无关的一
组向量。在回归模型中，设计矩阵$\boldsymbol{X}$可以看做一个具有对应基方
程的向量空间。例如，如果回归模型带有常数和一个自变量，那么这个模型对
应的基函数就是由1组成的向量和向量$\bm x_{1}$，唯一的自变量。任何回归模型的
右边都是基函数的线性组合，因此形成了一个基。我们用附加的基函数对回归样
条来近似非线性。最简单的增加基的方法就是使用附加的自变量。对于样条，我
们对数据矩阵增加基，但这个基是单一的自变量的转换。这些附加的基函数允许
我们近似$x$与$y$之间的非线性关系。为了增加基，需要一系列基函数，每一个
分段函数对应于一个基函数。在现在的这个例子里面，我们有两段分段函数需要
估计，所以我们定义两个基函数，一个对应于节点左边的分段函数，一个对应于
节点右边的分段函数： $$\label{eq:33}
  B_{L}(X)=\left\{
    \begin{array}{lr}
      c-x&\text{若}\,x<c,\\
      0&\text{其它}.
    \end{array}\right.$$ $$\label{eq:34}
  B_{R}(X)=\left\{
    \begin{array}{lr}
      x-c&\text{若}\,x>c,\\
      0&\text{其它}.
    \end{array}\right.$$

将这些基函数应用于设计矩阵来形成新的基。实际上也就是使用基函数增加了设
计矩阵中的向量。原始的设计矩阵是由常数向量和$x$向量组成。样条模型的设计
矩阵现在由常数向量和两个数据向量组成。第一个数据向量的值
为$c_{1}$减去$x$直到节点值等于$x$值，然后其它$x$值都为0；第二个数据向量
的值由0组成直到我们得到放置节点处的$x$值，然后向量的值取$x$减去节点值。
使用基方程增加了额外的基，原来模型具有2维基，线性模型具有3维基。实质上，
通过使用基函数，我们向设计矩阵中增加了新的回归变量。对于当前的例子，为
了应用基函数，我们必须选择放置节点的位置。我们把这个单一的节点放在$x$值
为60的地方，因此在模拟数据中，这一点就是扭结产生的位置，也是两条分段线
性拟合的连接点处。当节点值选定后，我们将基函数应用到模拟数据。基函数可
以通过两个函数来实现，将这两函数应用到模拟的$x$变量上，然后构建由常数向
量以及应用基函数得到的两个新的数据组成的新的设计矩阵[^5]。下面就是将两个基函数应用到模拟的$x$变量上
构建的设计矩阵$\boldsymbol{X}$的例子： $$\label{eq:35}
  \boldsymbol{X}=\left[
    \begin{array}{ccc}
      1&(60-x_{1})&0\\
      \noalign{\vskip-2pt}
      \vdots&\vdots&\vdots\\
      \noalign{\vskip-2pt}
      1&(60-x_{59})&0\\
      1&0&0\\
      1&0&(x_{61}-60)\\
      \noalign{\vskip-2pt}
      \vdots&\vdots&\vdots\\
      \noalign{\vskip-2pt}
      1&0&(x_{n}-60)
    \end{array}
    \right].$$
一旦我们得到了新的设计矩阵，估计$x$与$y$之间的样条拟合就比较简单。我们
使用新的设计矩阵来构建帽子矩阵$\boldsymbol {H=X(X'X)^{-1}X'}$。对因变量
向量使用帽子矩阵就得到一系列预测值，这些预测值是$x$与$y$之间关系的非参
数样条估计。因此，样条估计为 $$\label{eq:36}
  \boldsymbol{\hat y=Hy}$$
我们可以画出这些预测值以查看样条估计。图 \[fig:3-2\] 展示了$x$与$y$之
间估计的样条拟合的图形，其非常接近于$x$与$y$之间真实的非线性关系。

这个简单的例子很好的描述了使用样条的基本过程。可以看出，回归样条估计是
通过对被基函数改变后的设计矩阵应用最小二乘就可以得到。我们可以使用节点
的组合和更复杂的基函数来近似更复杂的非线性关系。显然，很多方面依赖于节
点的放置。由于样条模型本质上是转换的回归模型，所以它提供了非参数估计和
更标准统计方法的简单混合。在当前这个例子中使用的简单回归样条的一个缺点
就是分段线性函数的限制性假设，但我们容易放松这个假设。

样条模型已经有很多类型的基函数。一般地，基的改变在很大程度上不会改
变$x$与$y$之间的拟合。不同的样条基主要用于更好的数值稳定性和实现的简易
性(Ruppert, Wand and Carroll, 2003)[@ruppert2003semiparametric]。
下面我们讨论其他几种在光滑中经常用到的样条方法。

#### 二次和三次样条基

上面讨论的简单回归样条对大部分应用光滑问题都不适用。原因在于只能估计节点
之间分段线性函数，所以具有很大的局限性。我们希望能估计带有曲度的函数形
式。解决办法就是把分段回归函数和多项式回归结合起来，把每一个分段函数表
示为分段多项式回归函数。分段多项式提供了两个优点。第一，分段多项式允许
节点之间的非线性。第二，分段多项式回归确保了估计在节点处的一阶导数是存
在的，这就使得样条估计不会出现尖角[^6]。

把前面使用的回归样条变换成局部多项式是简单的。对于上一节的样条模型，我
们可以通过在基中增加$x^{2}$，对基函数的结果进行平方来估计分断多项
式。这些改变就得到具有一个节点$c_{1}$的二次样条基。但在实际中应用最
广泛的是三次样条基。三次样条基在估计数据的峰和谷时具有更大的灵活性。具
有三次基和两个节点$c_{1}$和$c_{2}$的样条模型就是下面的线性回归模型：
$$\label{eq:37}
  y=\alpha+\beta_{1}x+\beta_{2}x^{2}+\beta_{3}x^{3}+\beta_{4}(x-c_{1})_{+}^{3}+\beta_{5}(x-c_{2})_{+}^{3}+\epsilon$$

样条估计是将帽子矩阵应用到因变量得到的预测。为了得到帽子矩阵，我们必须
根据新的基来构建设计矩阵。对于这个例子，模型中将含有以下构建的数据向量:
$$\begin{aligned}
  \label{eq:38}
  x_{1}&=x \nonumber \\
  x_{2}&=x^{2}\nonumber\\
  x_{3}&=x^{3}\nonumber\\
  x_{4}&=(x-c_{1})_{+}^{3}\nonumber\\
  x_{5}&=(x-c_{2})_{+}^{3}\end{aligned}$$
其中$x$代表最原始的自变量。设计矩阵将由常数向量和上面这5个变量的数据组
成。我们用这个新的设计矩阵构建帽子矩阵，将这个帽子矩阵应用到因变量上面，
得到的估计值就是$x$与$y$之间可能的非线性关系的样条估计。用于构建样条估
计的参数个数由节点的个数控制。如果节点数为$k$，那么对于三次基，模型将
有$k+4$个回归系数(包括截距)。三次方基可以灵活地拟合节点之间非线性关系并
消除估计中的尖角。这是因为$(x-c_{1})_{+}^{3}$和$(x-c_{2})_{+}^{3}$的一
阶导数都存在，因此 中所有项的任意线性组合的一阶导数都存在。

#### B样条

B样条对三次样条进行了进一步优化。对于三次样条(自然的或其它的)，
设计矩阵$\boldsymbol{X}$的列之间趋于高度相关的，因为其每一列都是$x$的转换
形式，容易导致严重的共线性。共线性会造成近似奇异矩阵和估计的不精确性。
作为一个修正，可以把三次样条(和其它多项式样条)表示为B样条。$k$个节点的
三次B样条可以表示为： $$\label{eq:41}
  f(x)=\sum_{i=1}^{k}B_{i}^{2}(x)\beta_{i},$$ 其中B样条的基函数定义为：
$$\label{eq:42}
  B_{i}^{2}(x)=\frac{x-c_{i}}{c_{i+2+1}-c_{i}}B_{i}^{2-1}(x)
  +\frac{c_{i+2+1}-x}{c_{i+2+1}-c_{i+2}}B_{i+1}^{2-1}(x)\quad i=1,\cdots,k$$
且 $$\label{eq:43}
  B_{i}^{-1}(x)=\left \{
      \begin{array}{ll}
        1&\quad \text{若}\, c_{i}\leq x<c_{i+1}, \\
        0&\quad \text{其它}.
      \end{array}\right.$$
B样条的基函数的实质是每一个分段函数的重新调整。这个思想类似于通过减去均
值来重新调整变量$X$以减小共线性。B样条的重新调整减小了设计矩阵中基函数
之间的共线性。得到的样条模型比三次样条数值上具有更大的稳定性，特别是对
于节点数较多和使用OLS来拟合样条模型。关于B样条的更详细的介绍见de Boor
(2001)和Eilers and
Marx(1996)[@de1978practical; @eiters1996flexible]。统计软件中的许多
样条程序都是使用三次B样条或三次自然B样条。

### 样条和过拟合 {#sec:spline-and-overfit}

与局部多项式回归模型相同，样条也有可能产生过拟合现象。过拟合常常是由于
选择了较小的窗宽或过多的节点而造成的。我们可以通过一定的方法对过拟合进
行修正。对于过拟合的一个修正方法就是选择窗宽或节点数来使估计偏向于欠光
滑这边。尽管欠光滑提供了过拟合问题的一个简单的解决方法，但它没有统计理
论基础。而且估计偏向欠光滑时也造成估计的偏倚增加。因此，我们希望得到一
个基于统计理论的更严格的方法。罚样条就是这样一种既可以最小化过拟合可能
性又有着统计理论基础的非参数回归方法。在讨论罚样条之前，我们先讨论样条
中节点个数和位置对于估计的影响。

#### 节点个数和位置

在样条模型中，选择节点的个数和位置是需要决定的问题。对于一般的样条模型，
通过观察散点图一般不能得到如何放置节点的信息。下面就讨论如何放置节点及
选择节点的个数。

事实上，节点放置位置并不是一个很复杂的模型选择。Stone(1986)发现如何放置
节点对样条模型的影响比选择节点个数带来的影响要
小[@stone1986generalized]。标准做法是把节点等间距的安置在$x$的取值
范围之内。因为这可以保证在$x$的每一个区域内都有足够的数据得到光滑的拟合。
大部分统计软件包默认是在数据的四分位数或五分位数处放置节点。当然我们可
以不采用节点默认的放置方法。当数据具有明显的特征，采用手动的放置节点
的方法也可能是有效的。

但选择节点个数的问题仍然存在。节点的个数对于样条拟合的光滑程度有着重要
的影响。节点的数量通过控制拟合的分段数量影响数据的光滑程度。只有两个节
点的样条回归是线性的且是整体光滑的，因为这时只有一段函数。增加节点的个
数将增加用于拟合数据的分段函数的数量，这将带来更大灵活性。更多的分段函
数将得到更多的局部拟合。如果选择的节点的个数足够多，那么样条模型将在数
据点之间进行连接，因为更多的节点数导致用于每一分段函数拟合的数据个数下
降。所以节点个数有效地成为样条回归的带宽参数。因此，我们同样面临着通过选择
带宽来达到偏倚方差的平衡。如果我们使用较少的节点，样条估计将会过光滑，
这时偏倚较大但变异较小。如果我们使用较多的节点，样条估计将导致欠光滑，
会造成过拟合，此时偏倚较小但变异性较大。

理解节点的个数如何影响样条拟合的光滑性并没有解决如何确定节点个数的问题。
样条拟合对于选择的节点个数并不是特别敏感的。存在两种实用的方法选择节点
的个数。一种方法就是前面用于选择带宽时用过的目测试错法。4个节点是标准的
起点，如果拟合比较光滑，就增加节点的个数。如果拟合看起来过于非线性，就
减少节点的个数。对于大多数应用来说，4个或5个节点就足够了。节点的个数也
在一定程度依赖于样本容量。对于样本容量大于100时，5个节点一般能达到灵活
性与光滑性的平衡，对于小样本，小于30，一般由3个节点开始。

第二种方法比目测方法要正式一点。由于每一个节点代表加入模型的一个额外参
数，Eilers and Marx(1996)检验使用赤池信息准则(AIC)来选择节点个
数[@eiters1996flexible]。选择使得AIC值最小的节点的个数。使用AIC不
像目测法一样带有一定的任意性，将产生更合理的结果。

#### 光滑样条

参数和非参数模型都有可能发生过拟合。过拟合的统计模型具有相对于数据量来
说过多的参数，导致数据中的随机变异看起来像系统的效应。过拟合的解决方法
就是减少模型中的参数的个数，但怎么减小参数个数没有一个直观的方法。必须
依据一定的原则来减少参数的个数。AIC就是减少参数个数的准则，正与我们在
上一节看到的其可以应用于样条估计上。

过拟合的另一个解决方法是罚估计。对于模型中的每一个参数，一个惩罚加于模
型上。光滑样条就是对用于估计非参数的局部参数施加一个惩罚因子。由于样条
模型使用最小二乘进行估计，所以也具有线性回归估计的性质。这表明样条估
计$\hat f$就是使$y$与非参数估计$f(x_{i})$的平方和达到最小：
$$\label{eq:44}
  SS(f)=\sum_{i=1}^{n}[y-f(x)]^{2}.$$
问题是使得 最小的$\hat f$使用了太多的参数。罚估计解决方法
是在用于估计$f$的参数数量上附加一个罚。这表示是在具有约束条件下或带有
使用局部参数的惩罚项时最小化$SS(f)$。对于样条模型我们使用的罚是
$$\label{eq:45}
  \lambda \int_{x_{1}}^{x_{n}}[f''(x)]^{2}dx$$ 从而样条估计为
$$\label{eq:46}
  SS(f,\lambda)=\sum_{i=1}^{n}[y-f(x)]^{2}+\lambda\int_{x_{1}}^{x_{n}}[f''(x)]^{2}dx.$$
在方程 中，我们在带有罚的条件下最小化$y$与非参数估计 $f(x)$离差平方和。

方程 中的项是被称为粗糙罚的约束。罚由两部分组成。第一部分
是$\lambda$，一般称为光滑参数或调整参数，第二部分是$f(x)$的二阶导数的
平方积分。使用$f(x)$的二阶导数的平方积分背后的逻辑是非常直观的。二阶导
数表明了一个函数或曲线斜率的变化速度。二阶导数越大意味着曲率越高，反之
也成立。通过使用平方积分来概括了非参数回归估计在整个范围内的曲
率之和。当这个值较大时，说明$f(x)$比较粗糙，当值较小时，说明$f(x)$较光
滑。

取值为非负的$\lambda$参数，直接控制着给予测量$f$光滑程度的二阶导数的
权重。因此，$\lambda$建立了拟合与数据相近性和罚之间的平衡。因此，
$\lambda$的功能与光滑器中的带宽是类似的。当$\lambda$值
下降时，$\hat f(x)$将连接数据，我们得到一个粗糙的估计。当$\lambda
\rightarrow \infty$，平方积分的二阶导数被限制为0，这时就得到光滑整体最
小二乘拟合。更一般地，当$\lambda$增大时，我们得到数据更光滑但可能有偏
的一个拟合，当这个参数下降时，拟合偏倚小但是方差增加。

一个非常小的$\lambda$值近似为将数据进行连接，而较大的$\lambda$将得到一
个最小二乘拟合，但$\lambda$中间的值却通常对于应用到数据上的光滑程度的作
用却没有明显的解释。为了解决这个问题，我们把$\lambda$转化为自由度的近似。
光滑样条的自由度可以通过与局部多项式回归相类似的方式来计算，但惩罚使问
题变得复杂一些。在上一节中，线性回归模型的自由度等于拟合的参数个数，也
就是等于帽子矩阵的迹$\text{tr}(\boldsymbol{H})$。标准的样条模型是通过修
改的设计矩阵进行最小二乘拟合得到，它的自由度也可以通过计
算$\text{tr}(\boldsymbol{H})$来得到。为了计算罚样条的自由度，我们必须产
生罚样条模型的帽子矩阵$\boldsymbol{H}$。

首先，我们写出  中罚样条模型的矩阵形式。考虑到样条模型与线
性回归模型之间的等价性，我们可以把  中的第一项表示成线性回
归模型的矩阵形式，罚项可以写成$\beta$的二次型的形式。即把罚项写成下面
的矩阵形式： $$\label{eq:47}
  \int_{x_{1}}^{x_{n}}f''(x)^{2}dx=\boldsymbol{\beta'D\beta}$$
其中$\boldsymbol{D}$是具有下列形式的矩阵： $$\label{eq:48}
  \boldsymbol{D}=\left[
    \begin{array}{cc}
        \boldsymbol{0}_{2\times 2}& \boldsymbol{0}_{2\times k}\\
        \boldsymbol{0}_{k\times 2}& \boldsymbol{I}_{k\times k}
    \end{array}
\right].$$
其中$k$表示节点的个数。有了罚的矩阵形式，罚样条回归模型就可以写成以下矩
阵形式： $$\label{eq:49}
  SS(f,\lambda)=\boldsymbol{\Vert y-X\beta}\Vert^{2}+\lambda \boldsymbol{\beta' D\beta}.$$
罚样条的帽子矩阵具有把标准的线性回归矩阵依据惩罚项进行更改后的形
式。Ruppert, Wand and Caroll(2003)得到以下的罚样条的帽子矩阵或光滑矩
阵[@ruppert2003semiparametric]： $$\label{eq:50}
  \boldsymbol{S}_{\lambda}=\boldsymbol{X(X'X}+\lambda^{2p}\boldsymbol{D})^{-1}\boldsymbol{X}',$$
其中$p$为基方程中多项式的阶数。从这个形式可以看出，惩罚项是由标量
$\lambda^{2p}$乘以矩阵$\boldsymbol{D}$。和线性模型一样，矩阵
$\boldsymbol{S}_{\lambda}$的迹就是样条模型的自由度，近似等价于样条拟合
所有参数的个数。由于惩罚项的缩减作用，罚样条模型的自由度不是一个整数。
这时样条模型如何估计将很清晰。我们可以选择$\lambda$和$p$的值，然后按照
与标准样条模型相同的基方程来构建设计矩阵。使用这些值，我们就可以得到矩
阵$\boldsymbol{S}_{\lambda}$，并将它应用到因变量向量上得到估计值：
$$\label{eq:51}
  \boldsymbol{\hat y}=\boldsymbol{S}_{\lambda}\boldsymbol{y}.$$
来自这个方程的预测值就是罚样条的估计，我们可以把它在图中画出。光滑样条
矩阵表示的简单性使得光滑样条的编程仅比三次样条稍微复杂一点。过程与回归
样条模型中对构建的设计矩阵使用最小二乘是相同的。然而，尽管光滑样条模型
可以通过最小二乘估计，但这个方法在数值上不稳定。正交矩阵方法，像
Cholesky分解或谱分解，在数值上具有更大的稳定性。

由于自由度是$\lambda$的数学转换，因此他们控制了应用到数据上的光滑程度。
通过选择自由度，就选择了用于样条估计有效的局部参数的个数。使用自由度控
制惩罚项比选择$\lambda$的值来控制更加实用，因为即使非常大的$\lambda$的
变化值也只会造成相当小的自由度的变动。罚样条与标准样条之间的一个重要不
同就是罚样条中节点的个数对拟合的光滑程度的影响很小，因为$\lambda$现在控
制了拟合的光滑程度。这些罚样条一般被称为光滑样条。在这里，我们把这些样
条可以互换的称为罚样条或光滑样条。

对于光滑样条，我们把控制光滑程度的量从节点个数转换到调整参数$\lambda$上，
或等价的自由度上。光滑样条模型的优点是在提供相同拟合的情况下使用更少的
有效参数，因此无论分析者施加的光滑程度如何，减小了过拟合的可能性。因此，
虽然光滑样条不能排除过拟合的可能性，但是光滑样条减小了这种可能性。而且，
正与我们在下一节中将要看到的，光滑样条提供了拟合与使用的参数个数之间最
优的平衡。关于比较严格的选择$\lambda$的方法将在
第 \[sec:automated\] 节中讨论。

一般地，非参数回归性质分析上的证明是不存在的。然而，Wood(2006)证明了
三次光滑样条得到的拟合是具有最小误差的。详细的证明可以参考Green and
Silverman(1994)和
Wood(2006)[@green1993nonparametric; @wood2006generalized]。下面提供
该证明的框架。任何非参数回归模型的目的是选择光滑的估计$f$来最小化估计与
数据之间离差平方和。我们必须选择一个估计$f$，其在$[x_{1},x_{2}]$上面是
连续的，并具有连续的一阶导数，且在下式最小时是最光滑的 $$\label{eq:52}
  \int_{x_{1}}^{x_{n}}f''(x)^{2}dx.$$
如果$f(x)$是光滑的样条拟合，那么最小化以下函数： $$\label{eq:53}
  \sum_{i=1}^{n}[y-f(x)]^{2}+\lambda \int_{x_{1}}^{x_{n}}f''(x)^{2}dx.$$

最后，样条也可以在多维情况下用来光滑。局部多项式回归面临的问题也适应于
多维情况下的样条光滑。“维度诅咒”仍然是一个问题，多于二维的拟合仍然没
有办法进行解释。一般地，统计上大部分工作使用样条而不是局部多项式回归来
光滑二维数据。

### 样条推断 {#sec:infer-for-spline}

样条推断与局部多项式回归推断是相同的。对于置信带，我们可以使用光滑矩阵
$\boldsymbol{S}$来构建以点为基础的标准误差，然后代入95%的置信区间公式
中就可以在拟合图上作出置信带。我们也可以使用$F$检验或其转换形式来检验
样条模型对线性模型。

#### 置信带

对于样条模型，使用光滑样条或不使用光滑样条得到的光滑矩阵
$\boldsymbol{S}$是不一样的。三次样条或自然样条模型是对设计矩阵进行了变
换的简单回归模型。在第 \[sec:smooth-local-regr\] 节中，
$\boldsymbol{S}$的定义与线性回归模型中的帽子矩阵$\boldsymbol{H}$类似。
由于样条模型是回归模型，所以$\boldsymbol{S}$与帽子矩阵
$\boldsymbol{H=X(X'X)^{-1}X'}$等价，唯一的区别在于我们用一组基方程重新
定义了设计矩阵$\boldsymbol{X}$。而对于光滑样条模型，$\boldsymbol{S}$要
更复杂一点。光滑样条模型的光滑矩阵为
$\boldsymbol{S=X(X'X}+\lambda^{2p}\boldsymbol{D)^{-1}X'}$。为了计算置
信带，两种形式的$\boldsymbol{S}$矩阵可以用相同的方式使用。在下面的讨论
中，我们假定$\lambda$为固定的，$\boldsymbol{S}$代表两种形式的光滑矩阵。
在这些假设下，拟合向量$\boldsymbol{\hat f=Sy}$的方差协差矩阵为：
$$\label{eq:55}
  \text{Cov}\boldsymbol{(\hat f)=SS'}\sigma^{2}.$$
在已知$\sigma^{2}$的估计和样本容量足够大的情况下，可以使用方差协差阵
$\boldsymbol{SS'}\sigma^{2}$的对角元素的平方根乘以$\pm 2$来构建以点为
基础的置信区间带。我们仍然需要一个$\sigma^{2}$的估计，这里使用前面局部
多项式回归中相同的方法。如果$f$的估计是无偏的，那么$\sigma^{2}$的一个
无偏估计为 $$\label{eq:56}
  \hat \sigma^{2}=\frac{\text{RSS}}{df_{\text{res}}},$$
其中$\text{RSS}=\sum_{i=1}^{n}[y_{i}-\hat f(x_{i})]^{2}$是残差平方和，
$df_{\text{res}}$是残差的自由度： $$\label{eq:57}
  df_{\text{res}}=n-2\text{tr}[\boldsymbol{S}+\text{tr}(\boldsymbol{SS'})].$$
在实际中，这些以点为基础的置信带给出了样条拟合变异性的合理的估计。但在统
计理论方面，这些变异的估计有一定的局限性。首先，用$\hat \sigma$来估计
$\sigma$具有一定的误差，尽管在样本容量足够大的情况下这些误差很小。当在
小样本情况下，我们应用自由度为$k$的$t$分布的临界值来代替正态的临界值2，
其中$k$为模型中使用的参数($\boldsymbol{S}$的迹)。更重要的是，我们必须
假设$\hat f(x)$是近似无偏的。而这个假设是难以检验的。实际上，对于非参
数回归，我们一般认为估计$\hat f$是有偏的。非参数拟合是偏倚和方差的平衡，
具有较小偏倚的拟合的变异性将较大，因此我们必须接受一些偏倚来减小方差。
由于我们不能观测真实的光滑函数，因此拟合中偏倚的水平是难以判断的。对于
这种以点为基础的变异带，假设拟合是近似无偏的，通常可以认为是合理的。这
时，这些变异带可以解释为置信带。但如果我们能在构建变异带时能够得出估计
$f$中的偏倚将会更好。光滑样条模型在构建拟合置信带时再一次体现出优异性，
因为其允许对置信带进行偏倚调整。对于样条模型，存在两种对变异带偏倚进行
调整的方法。一种是基于贝叶斯准则的，另一种是基于混合模型框架的。首先讨
论贝叶斯变异带。

样条模型可以由贝叶斯光滑模型得到，其假设$f$是内在的随机线性方程的和与一
个积分的维纳过程。Wahba(1983)和Nychka(1988)给出了样条的贝叶斯推导的细
节[@wahba1983bayesian; @nychka1988bayesian]。重要的是，他们展示了来
自贝叶斯模型的变异带考虑了估计$f$时可能的偏倚。使用$\hat \sigma
\boldsymbol{S}_{\lambda}$估计$f$的方差得到的偏倚调正的变异带等价于贝叶
斯置信带(Hastie and Tibshirani, 1990)[@hastie1990generalized]。并
不是所有的光滑软件以这种方式给出修正偏倚的变异带。例如，Wood(2006)在他
的光滑软件包中给出了对修正变异带的建议及其软件实
现[@wood2006generalized]。一般地，这些修正对估计的变异带改变很小。

当使用混合模型框架来估计样条模式时，偏倚调整的方差估计为 $$\label{eq:58}
  \hat \sigma_{\text{adj}}^{2}=\hat \sigma_{\varepsilon}
  \sqrt{\boldsymbol{C_{x}} \left( \boldsymbol{C'C+}
      \frac{\sigma_{\varepsilon}^{2}}{\sigma_{u}^{2}}\boldsymbol{D}
      \right ) ^{-1}\boldsymbol{C_{x}'}},$$ 其中$\boldsymbol{C=[X,Z]}$，
$\boldsymbol{D}=\text{diag}(0,0,1,\cdots,1)$。在混合模型框架中，预测是
以随机效应为条件时$f$的估计中可能的偏倚(Ruppert, Wand and Carrol,
2003)[@ruppert2003semiparametric]。

#### 假设检验

我们也可以进行假设检验。由于样条模型中嵌套了整体模型，我们可以依赖近
似$F$检验来进行假设检验(Hastie and Tibshirani,
1990)[@hastie1990generalized]。为了检验模型的整体统计显著性，我们
可以检验样条模型对常数模型。像以前一样，还可以检验样条模型对整体线性模
型或幂转换模型。如果用$\text{RSS}_{1}$和$\text{RSS}_{0}$分别表示要比较
的模型和样条模型的残差平方和，那么一个近似的$F$的检验为：
$$\label{eq:59}
  \frac{(\text{RSS}_{1}-\text{RSS}_{0})/(df_{\text{res1}}-df_{\text{res0}})}
  {\text{RSS}_{0}/(n-df_{\text{res0}})} \sim  F(df_{\text{res1}}-df_{\text{res0}},n-df_{\text{res2}}).$$
这种方法在检验非线性或评价幂转换的充分性时非常有用。如果样条模型与一个
更简单的模型之间没有显著的差别，为了节俭的缘故，那么应更偏向于简单的模
型。非参数方法是没有必要的，除非数据显示出非参数必须的明显证据 [^7]。

### 非参数光滑方法比较 {#sec:compar-and-conclude}

目前为止，我们已经介绍了几种不同的非参数回归模型。在这一节中，我们对这
些模型进行简单比较。一个常见的问题是某一种非参数回归方法是否优于其它
方法。对于许多实际问题来说，没有哪一种方法完全优于另一种方法，但光滑样
条方法确实具有一些优点。它是唯一对在拟合中使用的参数施加惩罚项的光滑器。
非参数回归的主要批评之一就是其易于过拟合数据，光滑样条直接面对这个批评
的并加以解决。而且，光滑样条的混合模型框架为这些光滑器提供了一个分析基
础。

我们提供一些模拟的证据来展示不同的光滑器对一个高度非线性函数形式的拟合
效果。在这个模拟中，我们产生一个函数$f$并使用4个不同的光滑器进行拟合，
两个局部多项式拟合，两个样条光滑器来对模拟的数据进行拟合。这个非线性方
程为： $$\label{eq:60}
  y=\sin^{3}(2\pi x^{2})+\varepsilon.$$
其图形呈现周期样式。这种形式的函数在实际中非常罕见，但对于非参数回归来
说，是难以估计的。图 \[fig:3-11\] 给出了这4个非参数拟合，其中虚线代表
真实函数形式，实线代表非参数估计[^8]。

第一个非参数模型是光滑器。采用目测试错方法，我们选取0.1作
为带宽值。拟合效果不错但存在一些欠光滑，因为它缺失了一些
峰和谷。右上角的图是使用AIC准则选择节点的自然三次B样条拟合。这个模型中
显示了明显的欠光滑，在$x$的后半部分拟合效果较差。左下角图中
是估计。估计与估计几乎是完
全相同的，因此我们再次发现中使用的权重对于估计几乎没有什
么作用。最后我们使用目测试错方法选择自由度为31的光滑样条估计。光滑样条
估计很好的拟合了非线性，只有轻微的欠光滑出现。光滑样条的表现与两个局部
多项式回归相类似。模拟显示光滑样条和两个局部多项式都是不错的选择。对于
基本的散点图光滑来说，没有什么理由偏好于哪一种非参数回归方法。只有在比
较罕见的情况下，不同的光滑方法才会导致不同的拟合结果。在下一节我们将看
到，还有其它的原因偏向于光滑样条模型。而且，对于半参数回归模型来说，光
滑样条也是更好的选择。

光滑器本身只能作为强大的诊断工具。在实际研究中很少单独使用非参数回归
本身进行建模。然而，非参数方法对于检验两个变量之间是否具有非线性关系特
别有用。不使用光滑器仅凭目测很难得到两个变量之间的关系。我们将看到，光
滑器与标准的参数模型结合使用将是更为强大的统计建模工具。

自动光滑方法 {#sec:automated}
------------

不管使用哪种光滑器，我们必须选择对数据施加的光滑程度。当使用局部多项式
回归光滑器时，我们必须决定带宽的设置；当使用样条模型时，我们必须选择节
点个数或等价的自由度的个数。光滑选择的基本方法是目测试错法。尽管这个方
法在大部分情况都很好地发挥了效用，但光滑器经常被批评结果具有随意性，因
为它们要作出一个光滑选择，并且在这个选择下的拟合还有偏倚或方差膨胀发生。
但是目前已经存在许多自动光滑技术以消除使用目测方法选择光滑程度的问题。
自动光滑技术中，我们从数据本身来估计应该用于数据的光滑程度(带宽
或$\lambda$值)并使用这个光滑程度来拟合非参数回归模型。使用自动光滑技术，
我们无需对光滑估计过程作出任何决策。在许多实际应用中，自动光滑技术是一
个很好的选择。

### 交叉验证选择带宽

对于局部多项式光滑器，我们想估计一个光滑参数可以同时拟合中的最小偏倚和
方差。但光滑参数是一个外部参数，这意味着我们必须比较一系列具有不同光滑
参数的非嵌套模型。这意味着必须使用像交叉验证之类的模型选择方法。交叉验
证是一种基于重抽样的评估模型技术，它可以用于大部分统计模型。交叉验证依
赖于残差平方和作为模拟拟合的测度。尽管RSS可以对预测的效果进行测度，但它
本身不能用作模型选择，否则的话用$y$来预测$y$就是最佳的，因此还必须对模
型中使用的自由度进行限制。使用交叉验证时，我们把数据进行划分以避免$y$使
用其自己的值来预测自己。最简单的交叉验证就是把数据划分为两半，得到两个
数据集。第一个数据集，称之为训练数据。我们可以通过其它方法(目测试错
法，AIC准则等)来选取一个光滑参数进行拟合，把得到的拟合应用到另一个数据
进行预测，并评估拟合的效果。交叉验证还有很多其它划分数据的方法，但大部
分都需要相当大的样本容量，详细参考Efron and
Tibshirani(1994)[@efron1994introduction]。Leave-one-out交叉验证可
能是最常使用的划分数据的方法，因为其对于任何样本容量都适用。对
于Leave-one-out交叉验证，随机选择一个观测值，然后从数据集中排除。首先对
这个轻微截断的数据进行拟合一个可能的模型，并测度拟合效果。再选择另一个
数据点，并再次计算测度效果。重复这个过程直至每个数据点都被移除并计算拟
合效果。交叉验证得分就是平均的模型拟合测度，可以用于比较不同的模型。尽
管还可以使用其它的数据划分方法，Leave-one-out交叉验证是最常用的局部多项
式选择带宽参数的方法。

为了使用交叉验证来选择带宽，我们从数据中忽略第$i$个观测值并把带宽设置
为$s$来拟合一个局部多项式回归。把这个估计记为$\hat f_{x}(x_{-i})$并计算
其与$y$离差平方。对于所有的$N$个观测值都重复这个过程。对这$N$个离差
平方取平均得到交叉验证得分： $$\label{eq:61}
  \text{CV}(s)=\frac{1}{n}\sum_{i=1}^{n}[y_{i}-\hat f_{s}(x_{-i})]^{2}$$
其中$\hat f_{s}$是带宽为$s$减去一个观测值时$y$的非参数估计。最小化该函
数的$s$被认为是应用于局部回归拟合的最佳光滑度。Leave-one-out验证法计算
强度较大，因为对于每一个$s$值我们都要估计$n$个非参数拟合。对于
有10个$s$值和100个观测值的数据集，我们就必须估计1000次拟
合。对于较大的数据集，使用交叉验证较为繁琐。这时，可以使用交叉验证的一
个近似方法：广义交叉验证(GCV)。其由Graven and
Wahba(1979)[@graven1979smoothing]年提出，与交叉验证相比，其计算强
度较小，因此可以作为交叉验证的一个代替。广义交叉验证得分为
$$\label{eq:62}
  \text{GCV}(s)=\frac{\sum_{i=1}^{n}[y_{i}-\hat f(x_{i})]^{2}}{(n-\text{df})^{2}}$$
其中$df$为非参数回归模型的拟合自由度。对于不同的$s$的值分别计算其GCV得
分，选择具有最小GCV得分的$s$值。GCV本质是通过计算在非参数估计中使用自
由度调整的观测值$y_{i}$与拟合值离差平方和来对交叉验证进行近似。

但是，当使用局部多项式回归时，无论哪种形式的交叉验证表现都较差。GCV得分是
一个估计量，容易随着样本变异而变异，即使对于中等大小的样本，估计的不确
定性也是非常大的。一般地，当使用局部多项式回归时GCV趋于低估$s$，除非我
们使用相当大的样本。一些其它带宽选择方法被用于改进交叉验证和广义交叉验
证。然而，如Loader(1999)所展示的，这些方法对交叉验证的改进通常非常有限，
并且存在其自己的缺点[@loader1999local]。因此，他认为GCV仍然是最常
用的带宽参数选择方法。一般地，自动光滑技术对于样条模型使用更好，这也可
能是相对于局部多项式回归而言，在统计研究中逐渐更加关注样条模型的一个原因。

### 样条与自动光滑

尽管自动光滑技术可以应用于任何种类的样条，但光滑样条提供了一个更自然的
自动光滑框架。对于局部多项式回归和标准样条模型来说，带宽和节点数都是应
用于模型的外部参数。然而，对于光滑样条模型，光滑程度是模型中的一个参数。
因此，在选择光滑参数$\lambda$的最佳值时，我们可以使用评价模型表现的一些
准则。最佳的$\lambda$值就是最小化模型均方误差。在理论上，我们可以
把$\lambda$看作非参数回归的均方误差来估计$\lambda$: $$\label{eq:63}
  L(\lambda)=\frac{1}{n}\sum_{i=1}^{n}[f(x_{i})-f_{\lambda}(x_{i})]^{2}$$
其中$f_{\lambda}(x_{i})$是在给定$\lambda$时的光滑样条拟合。$\lambda$的
估计将依赖于未知的内在的回归曲线和光滑估计量的内在变异性。通过这个函数
得到的$\lambda$的估计将具有最小的MSE且是最优的。但是由于真实的
$f(x_{i})$是无法观测的，因此无法由  直接估计$\lambda$。通
常有两种替代方法来估计$\lambda$，一种是使用最大似然估计，另一种是使用
交叉验证。这两种方法都可以得到合理的$\lambda$的估计。

#### 通过似然估计光滑

在第 \[sec:splines\] 节中，我们看到光滑样条模型等价于一个混合模型，其
中随机效应放在每一个节点处以保证合理的光滑拟合。光滑样条模型的混合模型
估计方程为： $$\label{eq:64}
  \frac{1}{\sigma_{e}^{2}}\Vert \boldsymbol{y-X\beta-Zu}
  \Vert^{2}+\frac{\lambda^{2}}{\sigma_{e}^{2}}\Vert \boldsymbol{u} \Vert^{2}.$$
混合模型表达的一个优点为光滑罚是光滑样条混合模型的似然的一部分。因
此，$\lambda$就是似然函数的另一个要估计的参数。Ruppert, Wand and
Carrol(2003)证明了对于三次光滑样条，$\lambda$的估计
为[@ruppert2003semiparametric]： $$\label{eq:65}
  \hat \lambda=(\hat \sigma_{\varepsilon}^{2}/\hat \sigma_{u}^{2})^{3/2}$$
其中$\hat \sigma_{\varepsilon}^{2}$和$\hat \sigma_{u}^{2}$分别为随机效
果的估计方差和模型的误差项。通过似然方法估计$\lambda$，从统计的角度来看
是具有吸引力的，因为光滑参数变成了另一个从数据进行估计的参数。通过其它
方法的光滑样条估计必须依靠像交叉验证的模型选择技术。

#### 光滑样条和交叉验证

通过交叉验证选择光滑参数$\lambda$的过程与选择带宽的过程相同。对于一个
给定的$\lambda$值，随机选择一个观测值从数据集中剔除。对这个轻微截除的
数据集用光滑样条模型进行拟合。计算模型预测误差，并重复这个过程直至数据
集中每一个观测值都被删除过。交叉验证得分就是对每一个模型的误差进行平均。
使得交叉验证得分最小的$\lambda$值就是所选的光滑参数值。因此，普通交叉
验证得分是： $$\label{eq:66}
  \text{CV}(\lambda)=\frac{1}{n}\sum_{i=1}^{n}[y_{i}-\hat f_{\lambda}(x_{-i})]^{2}.$$
为了重复这个过程，交叉验证得分$\text{CV}(\lambda)$是每次丢掉一个数据，
拟合模型并计算拟合值与观测值$y_{i}$的离差平方和。这些离差平方和然后被平
均。这个过程必须对一定范围内的$\lambda$值重复，我们选择使得交叉验证得分
最小的$\lambda$值。但是，普通交叉验证计算强度仍很大，并且具有不变异问
题(Wood,2006;Wahba,1990)[@wood2006generalized; @wahba1990spline]。即
普通交叉验证当使用光滑样条时对于数据转换是变动的。在对$x$和$y$进行一
个正交变换后，对于同一个模型，交叉验证会得到不同的最优的$\lambda$值。因
此，广义交叉验证用于代替普通交叉验证。对于光滑样条模型，广义交叉验证得
分为： $$\label{eq:67}
  \text{GCV}(\lambda)=\frac{\sum_{i=1}^{n}[y_{i}-\hat f_{\lambda}(x_{i})]^{2}}{[1-n^{-1}\text{tr}(\boldsymbol{S})]^{2}}$$
其中$\boldsymbol{S}$是第 \[sec:splines\] 节中定义的光滑样条模型的光滑
矩阵，$\hat f_{\lambda}(x_{i})$表示对于给定的$\lambda$值对所有数据的
光滑样条拟合。尽管一般认为GCV优于普通交叉验证自动光滑技术，但在实际中，
这二者之间的差异通常很小的。这两种交叉验证方法对于光滑样条模型都比局部
回归模型要好。光滑样条罚将可以阻止过拟合的发生，而过拟合出现在使用GCV选
择带宽时的局部多项式回归中。

无论是使用交叉验证还是似然方法，都可以通过估计置信带来反映$\lambda$的估
计不确定性。当$\lambda$是通过GCV估计得到时，可以使用贝叶斯置信区间。通
过对光滑拟合使用惩罚项，我们可以使用模型特征的先验信条，贝叶斯置信带反
应出这种先验信条(Wood, 2006;Wahba,1983;Silverman,
1985)[@wood2006generalized; @wahba1983bayesian; @silverman1985some]。
在似然环境下，置信区间可以通过混合模型的方差项估计出(Ruppert,Wand and
Carrol,2003)[@ruppert2003semiparametric]。无论使用哪种方
法，$\lambda$估计的不确定性都可以反映在置信带中。

### 自动光滑建议

无论使用哪种光滑器，我们都必须要选择光滑程度：带宽，节点个数或自由度。
考虑到选择过程中的方差偏倚平衡，所以这个过程会产生不确定性。值得注意的
是通过目测方法得到的拟合通常是比较好的，但目测方法给人的感觉是比较随意，
因此通常不使用目测方法。使用自动光滑参数选择的光滑样条模型可以让我们依
赖数据本身来选择光滑程度。通过自动光滑产生的置信带更好的反应了对于光滑
过程的不确定性。在许多情况下，我们无需考虑太多，可以使用自动光滑方法。
但是，如果我们有关于光滑水平的相关信息或用自动光滑方法得到的拟合比较粗
糙时，我们应采取手动方法选择光滑程度。

无论是通过GCV还是似然方法估计$\lambda$都有估计不确定性，但样本容量的增
大可以改进这个估计。Hardel,Hall and Marron(1998)使用模拟展示了来自GCV方
法的光滑参数$\lambda$的估计随着样本容量的增大收敛于其真值的速度非常缓
慢[@hardle1988far]。结果有时候对于小样本数据(样本容量小
于50或100)自动光滑方法的表现较差。对于小样本，自动光滑方法得到的拟合可
能会过于粗糙或高度非线性。在这种情况下，我们应使用目测方法。

自动光滑方法在使用光滑器进行统计推断时存在一定的问题。光滑器的作用一部
分来自于其可以检验光滑非线性拟合是否优于线性拟合的能力。但正如前面所说
明的，此时的$F$检验仅为一个近似检验。自动光滑方法的使用使得这些检验更为
复杂。尽管这方面的研究仍在进行，但这些检验的$p$值比其真实值要小是公认的。
这是由于光滑参数的不确定性没有在$F$分布中考虑进来。一般认为当$p$值很明
显的大于或小于临界值时，检验是没有问题的。但检验非常重要时，而$p$值又在
临界值附近时，这时我们必须慎重考虑。在这种情况下，我们应比较线性模型或
幂模型和像三次自然样条的没有惩罚的光滑模型。这些模型具有正确
的$p$值(Wood,2006)[@wood2006generalized]。这个问题不仅仅是光滑器所
独有的，其它模型选择方法也存在这个问题。重要的是，我们可以使用自助法来
对线性拟合和使用自动光滑的非参数拟合的比较问题进行完全非参数的检验。

现在我们使用非参数光滑器时，可以使用自动光滑技术，也可以手工选择光滑程
度。但我们往往更多使用的是自动光滑技术。尽管有这些推断或理论上的考虑，
但我们一般最好还是从数据本身来估计光滑程度。自动光滑方法不仅剔除了手工
选择光滑程度拟合过程中的不确定性成份，而且还提供了一个更精确反应光滑水
平不确定性的置信带。

这一章我们主要讨论了非参数回归模型。我们首先通过介绍两种简单的光滑方法
揭示了非参数回归背后的基本思想。接下来主要介绍了两种重要的光滑方法：局
部多项式回归和光滑样条。在局部多项式回归中，我们给出了局部多项式光滑器，
并讨论了局部多项式回归光滑程度的选择、置信带构建和假设检验等问题。在光
滑样条中，我们首先给出了几种常见的样条：简单样条，二次和三次样条，B样条
等。选择合适的节点个数和位置，利用这些样条就可以拟合非线性。但这些样条
容易发生过拟合现象，为此我们讨论了光滑样条。此外还对光滑样条的置信带构
建和假设检验等统计推断问题进行了讨论。最后，我们讨论了非参数回归中的自
动光滑方法:广义交叉验证和利用似然方法估计光滑参数。有了非参数回归基础，
我们就可以转入下一章半参数回归模型的讨论。

#### 广义可加模型

#### 半参数模型和混合模型的关系

随机效应是解决统计模型中未观测到的异质性一种常见方法。例如，面板数据模
型就容易受到异质性影响。在面板数据模型中，模型的截距随着数据中的个体而
变化，随机效应可以用于对这些个体截距中的变异性进行建模。在随机效应模型
中，一个来自均值为0，方差为$\sigma^{2}$的正态分布的随机冲击加上每一个个
体截距上。这个随机冲击就可以消除异质性。因此，我们可以使用混合模型来估
计样条。实际上，光滑样条刚好可以表示为混合模型框架中的最优预测
量(Ruppert, Wand and Carroll 2003)[@ruppert2003semiparametric]。尽
管混合模型框架对于样条方法在实际数据分析中没有很大作用，但是从混合模型
框架的角度来看待样条方法可以提供两点新理解。第一，混合模型为理解为什么
光滑样条是最优光滑器提供了分析框架。第二，混合模型框架把非线性表示成未
观测的异质性，这有助于我们理解为什么需要非参数回归技术。接下来，我们非
常简略地概述混合模型框架并展示如何把光滑样条表示为混合模型。把样条视为
混合模型的详细讨论参见Ruppert, Wand and
Carroll(2003)[@ruppert2003semiparametric]。

在混合模型框架中，对$Y$我们可以写出以下线性回归模型： $$\label{eq:112}
  Y_{ij}=\beta_{0j}+\beta_{1j}X_{ij}+e_{ij}.$$
对于混合模型，一般地模型公式中每一项都有两个下标(或者更多)。在这种记号
中，我们有嵌套在$j$个个体当中的$i$个观测值。这可以是嵌套在$j$个学校中
的$i$个学生或者是嵌套在$j$个郡的$i$个投票者。我们认为在不同的$j$个体之
间具有异质性，也即斜率和截距随着$j$个体的不同而变化。如果我们怀疑在截
距和斜率之间存在这样的变异性，那么一个来自正态分布的随机数就可以按照以
下方式加入到截距和斜率参数中： $$\begin{aligned}
  \label{eq:113}
  \beta_{0j}=\gamma_{00}+u_{0j} \nonumber \\
  \beta_{1j}=\gamma_{10}+u_{1j}\end{aligned}$$
其中$u_{0j}$和 $u_{1j}$都服从$\mathcal{N}(0,\sigma^{2})$ ，是随机效应，
$\gamma_{00}$是$j$个个体的平均结果，$\gamma_{10}$是$j$个个体的平均斜率。
使用ML或者REML估计量，我们对随机效应进行积分以从对数似然函数中移除它们。

混合模型是一种对分组数据进行建模的惩罚方法，它是在简约模型与参数过多模
型的一种折衷。当数据聚集在个体中时，我们可以估计三种统计模型。在第一个
模型中，我们忽略$j$个体中的聚集作用，使用聚合之后的数据估计回归模型。
当$j$个体之间差异很大时，这样得到的聚合模型是有偏的。使用聚合数据，得到
的拟合没有多少变异性，因为这时我们把所有观测值都放在了一起使用。从参数
的个数角度来看，使用聚合数据得到的模型是最简约的模型。另一个极端情况是，
我们可以对$j$个体的每一个个体都估计一个回归模型。这种方法要估计的参数将
很多，当每个个体中包含的观测值个数不大的情况下，参数$\beta$的变异性很大。
然而，这些估计是无偏的。混合模型方法代表了这两种极端情况的一个中间方法。
混合模型中参数$\beta$的估计是完全忽视数据的结构和通过估计$j$个不同的模
型来全部体现数据结构两种方法的一个折衷方案。混合模型估计从$j$个不同模型
朝一个聚合模型方向收缩。混合模型得到的估计可以看作是来自个体模型的加权
评价。收缩得到的估计的均方误差优于聚合模型和个体模型的均方误差。线性混
合模型估计是最佳线性无偏预测(BLUP)(Pinero and Bates 2000; Ruppert, Wand
and Carroll
2003)[@pinheiro2000mixed; @ruppert2003semiparametric]。因此，当$j$个
体之间具有显著的差异时，依据均方误差原则，混合模型就提供了最佳拟合。

非线性可以看作是另一种形式的组间异质性。节点之间的数据就形成了一个组。
线性拟合与聚合模型类似，没有考虑可能存在的局部变异性。这个聚合模型忽视
内在结构，使用一个参数来描述$x$ 与 $y$ 之间的关系。这个拟合是最简约的，但
其忽视了$x$与 $y$之间关系在不同节点之间的差异。如果变异确实存在，那么线
性拟合是有偏的。一个标准样条模型就是一个没有聚合的模型。此时，我们对每
个节点之间的数据都得到一个参数。这样得到的模型将非常确切的反映了局部变
异性，但是在节点之间的数据不多时，得到的估计将具有较大的变异性。与线性
模型和标准样条模型不同，光滑样条模型与混合模型具有类型的结构，其考虑了
局部变异性但同时从所有的节点段之间“借力”。这表明，光滑样条估计是均方
误差意义上的最佳估计。光滑样条估计是具有非线性导致的异质性模型的最佳线
性无偏预测(BLUP)，其从一个高度局部性的拟合向全局估计收缩。

样条回归模型(具有线性基)可以表示为： $$\label{eq:114}
  f(x_{i})=\beta_{0}+\beta_{1}x_{i}+
  \sum_{k=1}^{K}\beta_{k}^{*}(x_{i}-c_{k})_{+}+\varepsilon$$ 其中
$$\label{eq:115eq}
  (x_{i}-c_{k})_{+}= \left \{
    \begin{array}{lr}
      0 & x \leq c_{k}\\
      x-c_{k} & x > c_{k}
    \end{array}
    \right.$$ 表示节点在$c_{k}$的分段线性拟合。下面把方程中的每一项写
成矩阵形式： $$\label{eq:116}
  \boldsymbol X = \left [
    \begin{array}{cc}
      1 & x_{1} \\
      \vdots & \vdots \\
      1 & x_{n}
    \end{array}
  \right ],
  \boldsymbol Z = \left [
    \begin{array}{ccc}
    (x_{1}-c_{1})_{+} & \ldots & (x_{1}-c_{k})_{+} \\
    \vdots & \ddots & \vdots \\
    (x_{n}-c_{1})_{+} & \ldots & (x_{n}-c_{k})_{+}
  \end{array}
\right ]$$ $$\boldsymbol \beta= \left [
    \begin{array}{c}
      \beta_{0}\\
      \beta_{1}
    \end{array}
  \right],
  \boldsymbol \beta^{*}= \left [
    \begin{array}{c}
    \beta_{1}^{*}\\
    \vdots\\
    \beta_{k}^{*}
  \end{array}
\right],
\boldsymbol \varepsilon =
\left [
  \begin{array}{c}
    \varepsilon_{1}\\
    \vdots\\
    \varepsilon_{n}
  \end{array}
\right].$$
其中向量$\boldsymbol \beta^{*}$表示分段函数的系数。使用上面的这些记号就可以把
方程写成矩阵形式 $$\label{eq:117}
  \boldsymbol {y=X\beta+Z\beta^{*}+\varepsilon}.$$
为了把线性样条模型改写成混合模型，需要 $$\label{eq:118}
  \boldsymbol u= \left[
    \begin{array}{c}
      u_{1}\\
      \vdots\\
      u_{K}
    \end{array}
  \right],$$ $\boldsymbol u$是随机效应向量，每一个元素都来自于正态分布
$\mathcal{N}(0,\sigma_{u_{k}}^{2})$。我们可以把改写成以 下混合模型：
$$\label{eq:119}
  \boldsymbol{y=X\beta+Zu+\varepsilon}.$$
这个两个模型的差异是在每个节点上的系数用随机效应来代替。方程 的解为：
$$\label{eq:120}
  \boldsymbol {\widehat f} =\boldsymbol C(\boldsymbol{C'C}+\lambda^{2} \boldsymbol D)^{-1}\boldsymbol{C'y}$$
其中$\boldsymbol{C=[XZ]}$，$\boldsymbol{D}=\text{diag}(0,0,1,\cdots,1)$，
$\lambda^{2}=\sigma_{\varepsilon}^{2}/\sigma_{u}^{2}$。Ruppert, Wand and
Carroll(2003)证明了方程等价于 $$\label{eq:121}
  \text{SS}(f,\lambda)=\sum_{i=1}^{n}[(y_{1}-f(x_{1}))]^{2}
  +\lambda \int_{x_{1}}^{x_{n}}f''(x)^{2}\text{d}x$$
这是光滑样条的表示形式。

光滑样条和混合模型之间的等价性具有重要意义。首先，这表明光滑样条拟合
是$x$和$y$之间的非线性关系的BLUP。当存在非线性时，光滑样条拟合具有最小
的均方误差。因此，光滑样条在拟合和使用的参数数量之间提供了一个最佳权衡。
第二，混合模型框架可以把$x$与$y$之间的非线性关系概念化为未观测的异质性。
如果存在该未观测的异质性却未被拟合，模型就存在设定误差。非参数回归提供
了拟合这种异质性的工具。这样，非参数回归背后的逻辑与混合模型背后的逻辑
就没有多大区别。非线性是一种形式的异质性，对于这种异质性，光滑样条提供
了平衡拟合与使用参数个数之间的最佳估计。光滑样条的混合模型表示方法容易
转换为贝叶斯估计框架，并且其更容易把光滑样条集成到标准混合模型中具体可
以参见Ruppert, Wand and Carroll (2003)[@ruppert2003semiparametric]。


## 广义可加混合模型(GAMM) {#sec:gamm}

### 广义可加混合模型提出背景

如同线性回归模型可以推广到广义线性模型一样，线性混合模型也可以推广到广
义线性混合模型(GAMM)。广义线性混合模型(GLMM)(Breslow and Clayton,
1993)为各种过度离散和相关因变量的参数回归提供了统一的似然框
架[@Breslow1993]。这种类型数据在许多领域研究中都会出现，
例如纵向数据研究，抽样调查，临床医学和疾病绘图(desease mapping)。GLMM推
断的主要困难在于完全似然分析中难以解决多重数值积分问题。各种近似推断方
法(Breslow and Clayton, 1993; Lee and Nelder, 1996; Lin and Breslow,
1996)和基于EM算法和Gibbs抽样的贝叶斯方法(McCulloch, 1997; Zeger and
Karim, 1991)被用于解决这个问题
[@Breslow1993; @lee1996hierarchical; @lin1996bias; @mcculloch1997maximum; @zeger1991generalized]
。关于完全最大似然估计的讨论可以参 见Aitkin(1999)[@aitkin1999general]。

GLMM一个关键特征是其使用参数均值函数来对自变量的效应进行建模，并通过
向线性预测子添加随机效应来拟合过离散化和相关性。然后，这个参数均值函数
的假设不一定总是正确的，因为合适的自变量函数形式事先并不知道，因变量和
自变量之间的依赖关系有可能具有复杂的形式。因此，向GLMM模型中添加非参
数均值函数项，建立相关数据的非参数回归模型具有实际意义。这将允许因变量和
自变量之间具有更灵活的函数依赖关系。

对于独立数据，使用核或者样条等方法的非参数回归文献很多(Hardle, 1990;
Green and Silverman,
1993)[@hardle1990applied; @green1993nonparametric]。Hastie and
Tibshirani (1990)的广义可加模型应用非常广
泛[@hastie1990generalized]。然后，对于相关数据非参数回归的研究却非
常有限。大部分研究都局限于具有正态因变量的纵向数据并带有一个非参数函
数(Hart, 1994; Rice and Silverman,
1991)[@hart1994automated; @rice1991estimating]。还有一些研究在线性混
合模型中加入一个非参数时间函数(Zeger and Diggle, 1994; Zhang *et al.*,
1998; Diggle,Verbyla,
1998)[@zeger1991generalized; @Zhang1998; @diggle1998nonparametric]
。对于非正态纵向数据，Wild and Yee (1996)和Berhane and
Tibshirani(2008)把广义可加模型推广到广义估计方程(Liang and Zeger,
1986)[@yee1996vector; @berhane2008generalized; @liang1986longitudinal]
。而在混合模型框架内研究非正态相关自变量的非参数回归文献不多。参
见Verbyla(2002)关于独立非正态数据广义线性模型中光滑样条的混合模型公式的
讨论[@verbyla2002analysis]。

相关数据的非参数回归面临许多新的问题。除了必须开发非参数函数的估计程序，
我们还必须考虑如何估计相关参数。已被许多学者(Green and Silverman, 1994;
Wahba, 1978)强调过的至关重要的问题是如何选择好的光滑参数和带宽参
数[@green1993nonparametric; @wahba1978improper]。这些问题的相关研究
很少，特别是相关参数和光滑参数的估计。传统光滑参数估计方法，数据驱动方
法面临着许多新的问题。例如，尽管交叉验证方法(Rice and Silverman,
1991)对于相关数据的光滑参数选择是一个合理的方
法[@rice1991estimating]，但其通常计算强度很大，而且接下来相关参数
估计非常困难(Zeger and Diggle, 1994)[@zeger1994semiparametric]。此
外，交叉验证方法对于交叉设计和空间数据无效。因此，开发同时对模型所有参
数进行估计的系统方法具有重要意义。

Lin，Zhang(1999)提出广义可加混合模型(GAMM)来解决这些问
题[@Lin1999]。GAMM是根据Hastie and Tibshirani (1990)的思
想对GLMM的可加模型推广[@hastie1990generalized]。这种新类型模型使用
可加非参数函数来拟合自变量的效应，而通过对可加预测子上增加随机效应来应
对数据中的过离散化和相关性。GAMM可以用于分组、层次和空间数据。

### 广义可加混合模型设定

假设$n$个个体的第$i$个观测值的因变量$y_{i}$条件独立，并且期望
为$\mathbb{E}(y_{i}|\boldsymbol{b})=\mu_{i}^{\boldsymbol{b}}$，方差为
$\text{var}(y_{i}|\boldsymbol{b})=\phi m_{i}^{-1}v(\mu_{i}^{\boldsymbol{b}})$，其中
$v(\cdot)$是设定的方差函数，$m_{i}$是权重，$\phi$是尺度参数。那么广义
可加混合模型为 

$$
  g(\mu_{i}^{\boldsymbol{b}})=\boldsymbol{X_{i}\beta} + f_{1}(x_{1i}) + f_{2}(x_{2i})
  + \cdots + \boldsymbol{Z_{i}b},
$$

其中$g(\cdot)$是联接函数，$\mu_{i}^{\boldsymbol{b}}$是 $y$
的条件期望，$\boldsymbol{\beta}$ 是固定效应参数向量，$\boldsymbol{X_{i}}$是固定
效应设计矩阵，$f_{j}$是自变量$x_{k}$的光滑函数，$\boldsymbol{Z_{i}}$是随机效应
的设计矩阵，$\boldsymbol{b \sim \mathcal{N} (0, \Psi)}$ 是随机效应变量，其中方差
协方差阵$\boldsymbol{\Psi}$ 一般未知而需要估计。

在模型中，线性预测子和非参数函数共同来拟合自
变量的固定效应，而随机效应用来拟合观测值之间的相关关系。当光滑函
数$f(\cdot)$都为线性函数时，那么此时GAMM就变化为GLMM。GAMM可以用于不同
的相关数据类型，如纵向数据，分层数据，空间数据等。对于不同的数据类型，
我们对随机效应$\boldsymbol b$设定不同的方差协方差矩阵结构，具体可以参
考Zeger，Diggle(1994)，Zhang *et al.*(1998)(纵向数
据)[@zeger1994semiparametric; @Zhang1998]，Lin，
Breslow(1996)(分层数
据)[@lin1996bias]和Cressie(1993)，Breslow，Clayton(1993)(空间数
据)[@cressie1993statistics; @Breslow1993]。

Lin，Zhang(1999)使用光滑样条来估计非参数函数，使用边际拟似然同时给出光
滑参数和方差成分的估计[@Lin1999]。边际拟似然方法是限制最
大似然(REML)方法的推广。REML方法被Wahba(1985)和Kohn *et
al.*(1991)用在经典非参数回归模型
中[@wahba1985comparison; @kohn1991performance]，被Zhang *et al.*(1998)，
Brumback and Rice(1998)和Wang(1998)用在正态非参数混合模型 中
[@Zhang1998; @brumback1998smoothing; @wang1998smoothing]
，这些学者把光滑参数看作是额外的方差成分。因为在最大化目标函数时需要求
数值积分，双重惩罚拟似然(DPQL)被用来作近似推断。上面方法的一个关键特征
是在统一的参数混合模型框架下对GAMMs的所有部分同时进行了系统推断。具体地
讲，GAMM的非参数函数、光滑参数和方差成分的估计可以通过已有的统计软件拟
合一个GLMM来得到。当数据是稀疏的时候(例如二分类数据)，方差成分的DPQL估
计具有一定的偏倚，这个偏倚可以通过一定的方法修正以改进这个估计。关于广
义可加混合模型的估计和推断更详细的讨论可以参 考Lin，Zhang(1999)和
Wood(2006)[@Lin1999; @wood2006generalized]。

总之，半参数回归方法容易推广到混合模型。考虑到混合模型中交互项的普遍存
在，非参数技术为描述第一层和第二层之间的非线性交互效应提供了灵活的方法。
但是，半参数的这种推广并不是没有代价的。混合模型与标准模型相比，是一种
计算强度更大的方法，而GAMM更是增加了这种计算强度。一般地，我们注意到的
差别就是在计算时间上多花几秒而已。然而，在估计GAMM经常碰到的一个问题就
是收敛问题。由于在估计GAMM时计算变得更困难，模型可能不能收敛。如果发生
这种情况，我们必须采取更简单的模型来拟合数据。

到目前为止，我们已经比较完整的讨论了半参数回归模型及其推广模型，包括广
义可加模型(GAM)，半参数混合模型和广义可加混合模型(GAMM)。下面我们将转
向实证部分。我们将利用这些模型来拟合中国宏观经济数据并利用统计诊断方法
来检验中国全国及地区GDP数据准确性问题。

[^1]: 多水平模型实际上混合模型的一种特殊情况。混合模型可以有多种形式的变形，而多水平模型是其中一种形式。

### 特例：半参数混合模型设定
最近以来，半参数混合模型得到了广泛关注。当建立混合模
型时，我们一般使用线性函数形式。与其他参数模型一样，对于一个给定的混合
模型我们并没有先验的理由认为线性函数形式是正确的。尽管线性函数形式有可
能是合适的，我们仍然可以使用非参数方法来诊断和拟合混合模型中的非线性关
系。这一节我们主要从半参数方法如何融入到混合模型的角度来讨论半参数混合模
型。下面我们给出半参数混合模型的模型设定。一般地，半参数混合模型具有以下形
式 $$\label{eq:additive-mixed}
  y_{i}=\boldsymbol{X_{i}\beta} + f_{1}(x_{1i}) + f_{2}(x_{2i})
  + \cdots + \boldsymbol{Z_{i}b} + \varepsilon_{i},$$
其中$y_{i}$是因变量，$\boldsymbol{\beta}$是固定效应参数向量，$\boldsymbol{X_{i}}$是固定
效应设计矩阵，$f_{j}$是自变量$x_{k}$的光滑函数，$\boldsymbol{Z_{i}}$是随机效应
的设计矩阵，$\boldsymbol{b \sim \mathcal{N} (0, \Psi)}$是随机效应变量，其中方差
协方差阵$\boldsymbol{\Psi}$一般未知而需要估计，$\boldsymbol{\epsilon \sim
  N(0,\Lambda)}$是误差向量，其由$\epsilon_{i}$堆积而成，一般假设其方差
协方差矩阵具有比较简单的形式。

半参数混合模型的估计和假设检验问题放在下一节中和广义可加混合模型一起讨论。

## 贝叶斯广义可加混合模型

<!-- # 参考文献 {-} -->
<!--[//]: # (\bibliography{Bibfile})-->
