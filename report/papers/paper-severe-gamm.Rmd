---
title: "基于广义可加混合模型空气严重污染影响因素研究"
author: "Jin"
date: '2019-04-15'
output:
  bookdown::pdf_document2:
    keep_tex: yes
    toc: false
    latex_engine: xelatex
    md_extensions: +east_asian_line_breaks
    citation_package: natbib
    pandoc_args: ["--listing", "--bibliography=Bibfile", "--filter", "pandoc-crossref"]
  bookdown::html_document2:
    number_sections: true
    seq_numbering: true
    fig_caption: true
    highlight: haddock
    theme: null
    md_extensions: +east_asian_line_breaks
    keep_md: true
    toc: false
    pandoc_args: ["--filter", "pandoc-crossref", "-M", "eqnPrefix="]
  bookdown::word_document2:
    fig_caption: true
    reference_docx: ../style/word-styles-02.docx
    md_extensions: +east_asian_line_breaks
    pandoc_args: ["--filter", "pandoc-crossref"]
css: ../style/markdown.css
bibliography: ../Bibfile.bib
eqnPrefixTemplate: ($$i$$)
link-citations: yes
linkReferences: yes
notice: '@*'
csl: ../style/chinese-gb7714-2005-numeric.csl
autoEqnLabels: true
---



```{r setup, echo=F}

knitr::opts_knit$set(root.dir = getwd())
knitr::opts_chunk$set(echo = FALSE, results = 'hide')
knitr::opts_chunk$set(warning = FALSE, message=FALSE)
```

```{r prepare}
rm(list=ls())
options(digits=4)
options(scipen=100)
graphics.off()
Sys.setlocale("LC_ALL", "Chinese")
```

# 简介

近几年来，空气质量问题引起了社会各界的广泛关注，城市空气污染已经成为了一个严重的社
会问题。恶劣的空气环境不只严重影响了人们的健康和正常生活，也给社会各行各业带来了巨
大的经济损失。日益下降的空气质量状况警醒我们比须及时采取相关措施提升城市空气质量。
在2018年召开的全国生态环境保护大会上，习近平总书记就提出要加大力度推进生态文明建设、
解决生态环境问题，坚决打好污染防治攻坚战，并要求坚决打赢蓝天保卫战是重中之重，要以
空气质量明显改善为刚性要求，基本消除重污染天气，还老百姓蓝天白云。要做到这些，就需
要我们找到空气质量的影响因素，进而根据影响因素及影响程度的大小进行相应的处理。因此，
本文重点关注空气严重污染，利用广义可加混合模型对城市空气质量的影响因素进行研究。

广义可加混合模型是广义线性混合模型的推广，Lin和Zhang（1999）提出了广义可加混合模型，
在GLMM中引入非参数均值函数来研究非参数回归，可以更好的解决因变量和自变量之间复杂的函
数形式。但广义可加混合模型(GAMM)面临的主要问题是参数估计问题。由于GAMM模型中涉及多个
参数，传统的似然估计函数很难实现，故基于MCMC抽样的贝叶斯统计推断方法被用来解决这一问
题。Fahrmeir、Lang（2001）提出了通过基于Gibbs抽样的MCMC进行GAMM推断的一般贝叶斯方法[@Fahrmeir2001]。
鉴于MCMC中比较常用的抽样方法MH抽样和Gibbs抽样的局限性，Neal（2003）提出切片抽样，并验
证了其有效性[@Neal2003a]。Pham 和Wand(2018)在Zhao等(2006)的研究基础上，对广义可加混合
模型实现了一种新的基于切片抽样的MCMC参数估计方法[@pham2018generalised;@Zhao2006]。
对于模型的运用，国内大部分学者还是集中于广义线性混合模型及广义可加模型，关于广义
可加混合模型的应用相对较少，但也有学者涉及。比如，张继磊（2009）通过构建伽玛可加
混合模型、泊松可加混合模型，将非参数平滑方法运用到广义可加混合模型中，结合贝叶斯
理论和MCMC方法得到参数的估计，研究了GAMM在非寿险公司未决赔款准备金评估中的运用，
发现与传统的模型相比，GAMM得到的结果更为准确、更为客观[@张继磊2009]。针对本文所涉及的
参数估计方法，曹红艳、刘桂芬、曾平等（2008）比较了PQL和基于MCMC的贝叶斯方法在广义线
性混合模型中参数估计的精度和偏差[@曹红艳2008]。

关于空气质量影响因素的研究方法，研究者大多采用环境库兹涅茨曲线（Zanin、Marra,2012,
Zheng,2017,李健、靳泽凡、苑清敏，2019），面板回归分析（王斌会、王术，2015），空间
分析（蔺雪芹、王岱，2016），灰色关联分析（湛社霞、匡耀求、阮柱，2018），主成分分析
（李经路、曾天，2017）等[@zanin2012assessing;@zheng2017a;@李健2019;@王斌会2015;@蔺雪芹2016;@湛社霞2018;@李经路2017]。
在进行空气质量分析时，主要采取以下两种变量来表征空气质量状况。第一类指标是以空气质量
指数（AQI）等空气质量综合指数（蔺雪芹、王岱，2016）或PM2.5、PM10等主要污染物为因变量
进行研究（李茜、宋金平、张建辉，2013）[@蔺雪芹2016;@李茜2013]。第二类是以某个时段内空
气质量达标天数反映空气质量状况（吴雪萍、高明、曾岚婷，2017）[@吴雪萍2018]。同时，在考
虑空气质量的影响因素时，主要考虑两方面的因素。第一类是社会经济因素（曲长雨，2018）
[@曲长雨2018]，第二类是气象因素（李琛、刘瑾、王彦民，2017）[@李琛2017]。也有部分学者综
合考虑了经济和气象因素（李静萍、周景博，2017）[@李静萍2017]。

基于以上分析，可以发现：第一、对于使用的模型和空气质量的研究方法，还未有文章涉及
广义可加混合模型在空气质量研究中的应用，而且国内大部分学者在进行GAMM估计时基本上
都是利用基于M-H抽样和Gibbs抽样的MCMC方法，还未有人将基于切片抽样的MCMC估计方法应
用于GAMM，本文应用H.Pham在2018年最新提出的R包gammSlice对广义可加混合模型进行更加
精确的估计。第二、在考虑空气质量的影响因素时，鲜有文章引入地理因素。因此，本文选
取2014-2017年中国重点监测的35个城市的年度数据和月度数据，综合考虑社会经济因素，
气象因素和地理因素三方面的影响，分别以年度城市空气出现严重污染的天数和月度城市是
否会出现严重污染为因变量建立广义可加混合模型进行相应研究，为空气质量状况研究提供
新的视角和研究方法。

## 贝叶斯广义可加混合模型

广义加性混合模型（GAMM）为涉及横截面，纵向和空间数据现实复杂情况下的回归分析提供
了广泛而灵活的框架。它们扩展了广义线性模型，通过将未知的度量自变量，时间尺度和空
间自变量的光滑函数以及随机效应添加到预测子的一般线性固定效应部分。在下面讨论的贝
叶斯广义可加混合模型中，所有这些影响因素以及光滑参数或其他超参数都被认为是随机的，
并且通过为它们设置适当的先验分布来获得特定模型。

假设$n$个个体的第$i$个观测值的因变量$y_{i}$条件独立，并且期望
为$\mathbb{E}(y_{i}|\boldsymbol{b})=\mu_{i}^{\boldsymbol{b}}$，方差为
$\text{var}(y_{i}|\boldsymbol{b})=\phi m_{i}^{-1}v(\mu_{i}^{\boldsymbol{b}})$，其中
$v(\cdot)$是设定的方差函数，$m_{i}$是权重，$\phi$是尺度参数。那么广义
可加混合模型为 
$$g(\mu_{i}^{\boldsymbol{b}})=\boldsymbol{X_{i}\beta} + f_{1}(x_{1i}) + f_{2}(x_{2i})
  + \cdots + \boldsymbol{Z_{i}b},$${#eq:121-1-1}

其中$g(\cdot)$是联接函数，$\mu_{i}^{\boldsymbol{b}}$是 $y$
的条件期望，$\boldsymbol{\beta}$ 是固定效应参数向量，$\boldsymbol{X_{i}}$是固定
效应设计矩阵，$f_{j}$是自变量$x_{k}$的光滑函数，$\boldsymbol{Z_{i}}$是随机效应
的设计矩阵，$\boldsymbol{b \sim \mathcal{N} (0, \Psi)}$ 是随机效应变量，其中方差
协方差阵$\boldsymbol{\Psi}$ 一般未知而需要估计。

在模型中，线性预测子和非参数函数共同来拟合自变量的固定效应，而随机效应用来拟合观
测值之间的相关关系。当光滑函数$f(\cdot)$都为线性函数时，那么此时GAMM就变化为GLMM。

在贝叶斯半参数模型推断中，未知函数 $f_{1}, \ldots, f_{p}$ ，更准确的说是相应的函数估计
向量，以及参数 $\beta=\left(\beta_{1}, \ldots, \beta_{r}\right)$ 和随机
效应 $b=(b(1), \ldots, b(G))$ 都被认为是随机变量。观测模型被视为以这些随机变量为条件，
并且必须提前为模型设定合适的先验分布。

未知函数 $f_{1}, \ldots, f_{p}$ 的先验设置取决于自变量的类型和对 $f_j$ 光滑度的
经验判断。对于完全贝叶斯分析，在层次结构中进一步引入了方差的超先验。这允许同时估计
未知函数和光滑度。常见的选择是高度分散的逆伽玛先验
$$p\left(\tau^{2}\right) \sim \operatorname{IG}(a ; c)$$
由于估计结果往往对超先验的选择很敏感，故应选择一个高度分散但合适的先验，如$a=1,c=0.005$。
对于固定效应参数 $\beta_{1}, \ldots, \beta_{r}$ ，一般假定独立的离散先验
 $p\left(\beta_{j}\right) \propto$ 一个常数， $j=1,\cdots,r$。固定效应参数先验还可
以是高度离散的正态先验。随机效应的先验是 $b_{g}$ 满足独立同分布的正态假定。
$$b_{g} | v^{2} \sim \mathcal{N}\left(0, v^{2}\right), \quad g=1, \ldots, G$$

并且为 $v^{2}$ 再定义一个高度离散的超先验。接下来分别定义
$$f=\left(f_{1}, \ldots, f_{p}\right), \qquad \tau^{2}=\left(\tau_{1}^{2}, \ldots, 
\tau_{p}^{2}\right), \qquad \beta=\left(\beta_{1}, \ldots, \beta_{r}\right), \quad 
b=\left(b_{1}, \ldots, b_{G}\right)$$ 

表示函数估计、方差效应、固定效应和随机效应的参数向量。于是便可以通过以下的条件独立假设完
成贝叶斯模型的设定：

（a）对于给定的自变量和参数 $f$ 、 $\beta$ 、 $b$ ,观测对象 $y_i$ 是条件独立的；

（b）先验 $p\left(f_{j} | \tau_{j}^{2}\right), j=1, \ldots, p$ 是条件独立的；

（c）固定效应和随机效应的先验以及超先验 $\tau_{j}^{2}, j=1, \ldots, p$ 是彼此独立的。

完全贝叶斯推断是基于以下的后验分布

$$p\left(f, \tau^{2}, \beta, \, b \,| \,y\right) \propto p\left(\,y \,| \,f, \tau^{2}, 
\beta, b\right) p\left(f, \tau^{2}, \beta, b\right)$$
通过假设(a),可以得出观测数据$y$的条件分布，即每个观测对象似然值的乘积：

$$p\left(y | f, \tau^{2}, \beta, b\right)=\prod_{i=1}^{n} L_{i}\left(y_{i} ; \eta_{i}\right)$$ {#eq:m-bayes-13}
其中 $L_{i}\left(y_{i} ; \eta_{i}\right)$ 由数据所属的指数族分布和预测子 $\eta$ 的形式选择
决定。

通过假设(b)和(c)，可以得到如下的后验推断：

$$
p\left(f, \tau^{2}, \beta, b | y\right) \propto \prod_{i=1}^{n} L_{i}\left(y_{i} ; \eta_{i}\right) \prod_{j=1}^{p}\left\{p\left(f_{j} | \tau_{j}^{2}\right) p\left(\tau_{j}^{2}\right)\right\} \prod_{k=1}^{r} p\left(\beta_{k}\right) \prod_{g=1}^{G} p\left(b_{g} | v^{2}\right) p\left(v^{2}\right)
$$
通过MCMC模拟，在给定其余参数和数据的情况下，通过更新单个参数或参数块的充分条件
可以完成贝叶斯推断。

## Lasso变量筛选方法

在统计建模和机器学习中，Lasso是一种回归分析方法，它用于变量选择和正则化，以提高
其产生的统计模型的预测准确性和可解释性。它最初是为最小二乘模型制定的，但Lasso正
则化很容易以一种简单的方式扩展到广泛的统计模型，包括广义线性模型、可加模型和混合
模型等。其进行变量筛选的方法是强制回归系数绝对值之和小于一个固定值，从而强制将某些系数设置为
零，进而有效地选择一个不包含这些系数的更简单的模型，通过改变模型拟合过程，只选择提供的自
变量的子集用于最终模型，而不是使用所有自变量。


# 变量选择和数据来源

空气质量的好坏反映了空气污染的程度，空气污染是一个复杂的现象，在特定时间和地点，空气质量受
很多因素的影响，比如常见的空气质量影响因素包括经济社会因素、地理因素及气象因素。

经济社会因素中，经济增长、人口因素、绿化建设、交通运输、能源消耗、废气排放等都会对
空气质量产生影响。有研究表明，人口集聚会对空气质量产生一定的影响，人口密度可以反映
人口地理分布的疏密程度，但是考虑到市辖区人口较多，郊区人口较少，从某种意义上讲，人
口密度会将市辖区和郊区对空气质量的影响视为等同，因此，选取年末常住人口表示人口因素。
空气质量的两大污染源包括固定污染源和移动污染源，固定污染源是指向环境排放或释放有害
物质或对环境产生有害影响的场所、设备和装置，用房屋建筑施工面积代表。移动污染源主要
指空气排放污染物的交通工具，用私人汽车拥有量和城市公路客运量进行表示。能源消耗产生
的废气严重污染了空气,用全社会用电量代表能源消耗。

经济社会因素可以视为影响空气质量好坏的人为因素，这些因素可以根据实际情况做出相应改变。
而气象因素及地理因素则是影响空气质量好坏的固定因素。气温、降水量、气压、风速、相对湿度、
日照时数都会对空气质量产生一定的影响。同时，城市的地形、南北方差异，北方供暖会产生大量
废气排放，沿海城市因为有海风有利于污染物扩散都会对空气质量产生相应的影响。

根据以上分析，鉴于数据的可获得性，选取比较有代表性的指标，最终确定初步选取空气质量影响因
素24个，具体列举在表 \@ref(tab:tab3) 中。

```{r tab3, eval=T,results='markup', cache=F}
rm(list=ls())
library("kableExtra")
tab3 <- read.csv('../results/variable.csv')
knitr::kable(tab3, row.names =F, align = "l", caption="空气质量影响因素指标体系",
             longtable = TRUE, booktabs = TRUE, escape = F,
             linesep  = c(rep("", 12), "\\hline", rep("",5), "\\hline")) %>%
			     kable_styling(latex_options = c("scale_down", "repeat_header", "hold_position"),
                 repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1:4, width = c("3cm", "3cm", "5cm", "2cm"))
			 
```

以上指标数据来源于《中国气象年鉴》、《中国统计年鉴》和《城市空气质量状况月报》。由于月度固定
资产投资为累计值，故采用后一期减去前一期的计算方法。其他的非月度数据，采用合适的频率转化方法
转化为月度数据以后再进行分析。如经济指标中的月度地区生产总值使用相应的季度生产总值除以3近似代
替。对于常住人口、建成区绿化覆盖率、私人汽车拥有量这些存量数据，将年末值作为各月值进行分析。

在进行实证建模分析之前，首先需要对因变量的内涵及其分布进行考察。按照《环境空气质量指数（AQI
）技术规定（试行）》中的说明，将AQI>300定义为严重污染。并且对年度和月度空气质量为严重污染的
天数进行一系列正态性检验，结果显示两个变量均不服从正态分布。故根据数据特征，将年度严重污染的
天数定义为泊松分布，因为更关注每年有多少天出现严重污染，而不是每天出现严重污染的概率是多少。
但对于月度严重污染天数，大多数城市的取值均为0，若将其定义为二项分布，则关注点为每天出现严
重污染的概率，且概率取值为很小的数。因此，将月度空气严重污染的天数转化为月度是否出现严重污染
进行分析。

# 年度空气严重污染天数影响因素分析

根据2014年-2017年35个城市每一天的AQI值和空气质量指数等级划分标准，可以计算得到2014-2017年35
个城市的年度空气严重污染天数。根据前面的分析结果，可以认为年度空气严重污染天数近似服从泊松分
布。下面就以年度空气严重污染天数作为因变量开展分析，首先进行自变量筛选，然后建立泊松可加混合
模型框架下的各种具体模型。


## 年度空气严重污染天数Lasso自变量筛选

以年度空气严重污染天数为因变量进行相应分析，Lasso方法变量筛选结果如图
\@ref(fig:fig-var-sel-y-severe) 所示。在图 \@ref(fig:fig-var-sel-y-severe) 中，
横轴表示各自变量，纵轴表示标准化后的年度空气严重污染的天数。由图
\@ref(fig:fig-var-sel-y-severe) 可知，地区生产总值、地区生产总值增长率、固定资产
投资额、城市公路客运量、房屋建筑施工面积、全社会用电量、工业二氧化硫排放量、工业
烟粉尘排放量、工业污染治理完成投资额、废气治理完成投资额、平均气温、平均气压、经
度、海拔对年度空气严重污染的天数无影响，这些变量被剔除，而剩下的变量有常住人口、
建成区绿化覆盖率、私人汽车拥有量、降水量、平均相对湿度、平均风速、日照时数、纬度。
且在剩下的这些变量中，可以看出，私人汽车拥有量、纬度对年度空气严重污染的天数呈正
向影响，而降水量、平均相对湿度对年度空气严重污染的天数呈负向影响，常住人口、建成
区绿化覆盖率、平均风速、日照时数与年度空气严重污染的天数呈非线性相关关系。

```{r fig-var-sel-y-severe, eval=T, fig.height=8.5, fig.width=6.5,out.width="95%", fig.pos="H", fig.cap = "年度严重污染天数自变量筛选结果", dev=c("png","cairo_pdf"),dev.args=list(family="Microsoft YaHei UI Light")}
rm(list=ls())
varlist <- read.csv("../data/var_list.csv")
dat.sel.y.severe <- read.csv("../results/dat.sel.y.severe.csv")

varinfo <- varlist[match(names(dat.sel.y.severe), as.character(varlist$var_code)), c(1:3,7)]
varinfo <- varinfo[order(varinfo$var_no), ]

dat.sel.y.severe$city <- factor(dat.sel.y.severe$city)
dat.sel.y.severe$year <- factor(dat.sel.y.severe$year)
dat.sel.y.severe$heating <- factor(dat.sel.y.severe$heating)
dat.sel.y.severe$coast <- factor(dat.sel.y.severe$coast)

library(gamsel)
gam1 <- gamsel(as.matrix(dat.sel.y.severe[,-c(1:3, 23:24)]), as.matrix(dat.sel.y.severe[,3]), gamma = 0.5)


par(mfrow=c(6,4), mar=c(2.1, 3.1, 2.1, 1.1))
mapply(function(i, y) {
    plot(gam1,newx=as.matrix(dat.sel.y.severe[,-c(1:3, 23:24)]),
         index=18, which = i, main = y, cex.main = 0.95, ylim = c(-3, 3))},
    as.list(1:22),
    as.list(varinfo[,2][-c(1:3, 23:24)]))
```

以上是对连续型变量的筛选。对于地理因素中的是否集中供暖和是否临海这两个因素，本文采用t检验探
究城市空气质量与地理环境之间的关系。对2017年35个城市的相关数据进行t检验，结果显示在本文所研
究的35所城市中，集中供暖的有17个，剩下的18所城市不采取集中供暖。在集中供暖的城市中，2017年严
重污染天数为6.18天。而在没有集中供暖的18所城市中，严重污染的平均天数只有0.28天。且在5%的显著
性检验下，检验结果通过显著性检验，说明集中供暖的城市与没有集中供暖的城市其空气质量存在显著差
异。同样，在5%的显著性水平下，临海和不临海的城市的空气质量之间也存在显著差异。在本文研究
范围内，临海城市有10个，内陆城市有25个，临海城市严重污染的平均天数为0.4天。内陆城市严重污染
的平均天数为4.24天。以上分析表明，城市空气质量与地理因素有关，是否集中供暖和是否临海其城市的
空气质量差异较大。表 \@ref(tab:tab-geo) 给出了具体的分析结果。

```{r tab-geo, echo=FALSE, results='markup'}
varlist <- read.csv("../data/var_list.csv")
dat.y <- read.csv("../data/yearly.csv")

geovar <- names(dat.y)[c(1,3,10,15, 41,42)]
geo.y17 <- dat.y[dat.y$year==2017, geovar]

varinfo <- varlist[match(geovar[-1], as.character(varlist$var_code)), c(1,2,7)]

geo.stat <- as.data.frame(rbind(
apply(geo.y17[2:4], 2, function(x) {temp <- t.test(x~geo.y17$heating)
    c(temp$esti, temp$stat, temp$p.v)
})[c(2,1,3,4),],
apply(geo.y17[2:4], 2, function(x) {temp <- t.test(x~geo.y17$coast)
    c(temp$esti, temp$stat, temp$p.v)
})[c(2,1,3,4),]))

geo.count <- c(as.vector(table(geo.y17[,5]))[2:1],NA,NA,
               as.vector(table(geo.y17[,6]))[2:1],NA,NA)

geo.factor <- c("是否集体供暖", NA,"t统计量值","P值", "是否临海", NA,"t统计量值","P值")
geo.factor2 <- c("是", "否", rep(NA, 2), "是", "否", rep(NA, 2))
geo.stat <- cbind(geo.factor, geo.factor2, geo.count, geo.stat)
geo.stat1 <- geo.stat[,c(1,2,3,6)]

names(geo.stat1) <- c("属性", "取值", "城市数量", "严重污染平均天数")
#write.csv(geo.stat, "../results/geo.stat.csv", row.names=F)

library("kableExtra")
knitr::kable(geo.stat1, row.names =F, align = c("l","l","c", "r"),
             digits=2,
             caption="2017年35个城市空气质量与地理环境关系检验",
             longtable = TRUE, booktabs = TRUE, linesep  = c("", "", "", "\\hline"), escape = F) %>%
    kable_styling(full_width = T) %>%
    column_spec(1:4, width = c("3.5cm", "1.1cm", "2cm","4cm"))%>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)",
                  )%>%
    footnote(general ="城市是否集中供暖来自各城市政府网站，城市是否临海根据城市地理位置确定",
             general_title = "数据来源：",
             threeparttable = T)

```

下面就以筛选出的变量和其余两个分类型变量共10个变量建立模型。

## 年度空气严重污染天数模型

通过以上分析，对年度严重污染的天数通过选择最优模型来分析空气质量的影响因素。根据因变量的
具体分布，且遵循模型由简单到复杂的原则，对于服从泊松分布的年度严重污染的天数建立泊松回归
模型，进一步分别考虑城市之间的相关性及自变量的非线性影响，分别建立泊松混合模型及泊松可加
模型，最后综合考虑城市之间的相关性及自变量的非线性影响，建立泊松可加混合模型进行相应分析。
最后在这些可选模型中通过综合比较模型拟合优度，模型实际意义等确定年度空气污染天数最优模型。

### 年度空气严重污染天数泊松回归模型

作为比较的基准，利用筛选出的10个变量首先建立泊松回归模型,结果见表 \@ref(tab:tab-severe-y-huizong)。在10%的显著性水平下，虽然只有降水
量和纬度两个变量未通过显著性检验，但建成区绿化覆盖率和临海地区两个变量的符号与实际意义不符，
其对应系数为0.0312和1.5828。也就是说，在其他变量保持不变的条件下，建成区绿化覆盖率越高，空
气质量越差；临海地区的空气严重污染天数平均比内陆地区多1.5828天。但实际情况是建成区绿化覆盖
率越多，空气质量应该越好，临海地区比非临海地区的空气质量好。

```{r tab-severe-lm-y, include=FALSE, results='markup'}
varlist <- read.csv("../data/var_list.csv")
dat.sel.y.severe <- read.csv("../results/dat.sel.y.severe.csv")

varinfo <- varlist[match(names(dat.sel.y.severe), as.character(varlist$var_code)), c(1:3,7)]
varinfo <- varinfo[order(varinfo$var_no), ]
varsel <- c(as.character(varinfo[,3][-c(1:3, 23:24)][getActive(gam1, 18, "nonzero")[[1]]]),
            "heating", "coast")
varselname <- varlist[match(varsel, as.character(varlist$var_code)), c(1:3,7)]
varselname <- as.character(varselname[order(varselname$var_no), 2])

glm.y.severe1 <- glm(dat.sel.y.severe[, c("severe", varsel)], family = "poisson")
lm.y.severe.coef <- summary(glm.y.severe1)$coef
#glm.y.severe1$aic
#BIC(glm.y.severe1)

dimnames(lm.y.severe.coef) <- list(c("截距项", varselname), c("估计值", "标准误", "t值", "P值"))
#write.csv(lm.y.severe.coef,"C:/Users/Administrator/Desktop/lm.y.severe.coef.csv")
library("kableExtra")
knitr::kable(lm.y.severe.coef, row.names =T, align = c("r", "r", "r", "r"),
             caption="年度空气严重污染天数泊松回归模型回归系数表",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))
```


### 年度空气严重污染天数泊松混合效应模型

将城市作为随机效应建立泊松混合效应模型，对年度空气质量严重污染天数影响因素进行分
析。结果显示在10%的显著性水平下，常住人口、降水量、平均风速、日照时数、纬度通过显著性检
验，且其系数分别为0.0606、-0.0009、-0.7571、-0.0013、0.1575。表明在其他变量保持不变的条件
下，常住人口越多、纬度越高，年度严重污染的天数越多，空气质量越差；而降水量越多、平均风速
越大、日照时数越多，年度空气严重污染的天数越少，空气质量越好。

```{r tab-severe-lme-y-model, include=FALSE, results='hide'}

library(mgcv)
lme.y.severe <- gamm(severe~green+pop+car
                    +rain+humid+wind_speed+sun
                   +heating+coast+lat,
                   random=list(city=~1), data=dat.sel.y.severe,
                   family="poisson", method = "REML")
```

```{r tab-severe-lme-y, include=FALSE, results='markup'}
lme.y.severe.coef <- summary(lme.y.severe$lme)$tTable[,-3]
#lme.y.severe$lme$logLik
#AIC(lme.y.severe$lme);BIC(lme.y.severe$lme)
dimnames(lme.y.severe.coef) <- list(c("截距项", varselname), c("估计值", "标准误", "t值", "P值"))
#write.csv(lme.y.severe.coef,"C:/Users/Administrator/Desktop/lme.y.severe.coef.csv")
library("kableExtra")
knitr::kable(lme.y.severe.coef, row.names =T, align = c("r", "r", "r", "r"),
             caption="年度空气严重污染天数泊松混合效应模型回归固定效应表",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```

### 年度空气严重污染天数泊松可加模型

由之前变量筛选的结果可知，常住人口、建成区绿化覆盖率、平均风速、日照时数与年度空气严重污
染天数之间存在非线性相关关系。进一步建立泊松可加模型，模型参数部分显示降水量和是否临海，纬度
三个变量通过了10%的显著性检验，其中纬度对空气质量出现严重污染有正向作用，纬度越高，空气质量
越差；而降水量越多、临海的地区，年度空气严重污染天数越少，空气质量越好，详细结果见表 \@ref(tab:tab-severe-y-huizong)。非参数项的曲线显示在
图\@ref(fig:fig-severe-gam-y)中，非参数项显著性检验结果在表\@ref(tab:tab-severe-gam-y-smooth
) 中。

```{r tab-severe-gam-y, include=FALSE, results='markup'}

library(mgcv)
gam.y.severe <- gamm(severe~s(pop)+s(green)+car
                    +rain+humid+s(wind_speed)+s(sun)
                   +heating+coast+lat,
                   data=dat.sel.y.severe,
                   family = "poisson", method = "REML")
#gam.y.severe$aic;BIC(gam.y.severe)
#summary(gam.y.severe)
gam.y.severe.coef <- summary(gam.y.severe$lme)$tTable[-(8:11),-3]

dimnames(gam.y.severe.coef) <- list(c("截距项", varselname[c(3:5,8:10)]), c("估计值", "标准误", "t值", "P值"))
#write.csv(gam.y.severe.coef,"C:/Users/Administrator/Desktop/gam.y.severe.coef.csv")
library("kableExtra")
knitr::kable(gam.y.severe.coef, row.names =T, align = c("r", "r", "r", "r"),
             caption="年度空气严重污染天数泊松可加回归模型参数估计结果",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```


```{r fig-severe-gam-y, eval=T, fig.height=5.5, fig.width=6.5,out.width="95%", fig.pos="H", fig.cap = "年度空气严重污染天数泊松可加回归模型非参数曲线", dev=c("png","cairo_pdf"),dev.args=list(family="Microsoft YaHei UI Light")}
par(mfrow = c(2,2))
par(mar=c(5,4,2,1))
plot.gam(gam.y.severe$gam,
         select=1,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "人口数"
         )
par(mar=c(5,4,2,1))
plot.gam(gam.y.severe$gam,
         select=2,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "绿化率"
         )
par(mar=c(5,4,2,1))
plot.gam(gam.y.severe$gam,
         select=3,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "平均风速"
         )
par(mar=c(5,4,2,1))
plot.gam(gam.y.severe$gam,
         select=4,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "日照时数"
         )

```

```{r tab-severe-gam-y-smooth, eval=T, results='markup'}
gam.smooth.tab.y.severe <- as.data.frame(summary(gam.y.severe$gam)$s.table[,-2])

dimnames(gam.smooth.tab.y.severe) <- list(varselname[c(1,2,6,7)], c("经验自由度", "卡方统计量值", "P值"))

library("kableExtra")
knitr::kable(gam.smooth.tab.y.severe, row.names =T, align = c("c", "c", "c", "c"),
             caption="年度空气严重污染天数泊松可加模型非参数项显著性",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```

图 \@ref(fig:fig-severe-gam-y) 中显示了常住人口、建成区绿化覆盖率、平均风速、日
照时数的拟合曲线，阴影部分表示95%的置信区间。同时由表
\@ref(tab:tab-severe-gam-y-smooth) 可知，在10%的显著性水平下，常住人口、建成区绿
化覆盖率、平均风速、日照时数均通过显著性检验，表明常住人口、建成区绿化覆盖率、平
均风速、日照时数对年度空气严重污染天数存在非线性影响。由图
\@ref(fig:fig-severe-gam-y) 可以发现，年度空气严重污染的天数随常住人口的增加呈现
先上升后下降的趋势，具体来讲，在常住人口在2000万人之后，年度空气严重污染的天数会
下降；同时，年度空气严重污染天数随建成区绿化覆盖率的增加而有所增加，随平均风速的
增加而有所减小，随日照时数的增加呈先增加后下降的平缓趋势。

### 年度空气严重污染天数泊松可加混合效应模型

同样以城市作为随机效应，进一步建立泊松可加混合效应模型，模型估计结果中的参数部分与泊松可加
模型中的结果相似，具体见表 \@ref(tab:tab-severe-y-huizong)。只是纬度对空气出现严重污染的影响由正向作用变为负向作用。在泊松可加混合效
应模型中，结果表明，纬度越高，空气质量越好。非参数项的曲线显示在图
\@ref(fig:fig-severe-gamm-y)中，非参数项显著性检验结果在表
\@ref(tab:tab-severe-gamm-y-smooth) 中。

```{r tab-severe-gamm-y-model, include=FALSE, results='hide'}

library(mgcv)
gamm.y.severe <- gamm(severe~s(green)+s(pop)+car
                    +rain+humid+s(wind_speed)+s(sun)
                  +heating+coast+lat,
                   random=list(city=~1), data=dat.sel.y.severe,
                   family = "poisson", method = "REML")
#AIC(gamm.y.severe$lme);BIC(gamm.y.severe$lme)

```

```{r tab-severe-gamm-y, include=FALSE, results='markup'}
gamm.y.severe.coef <- summary(gamm.y.severe$lme)$tTable[-(8:11),-3]

dimnames(gamm.y.severe.coef) <- list(c("截距项", varselname[c(3:5, 8:10)]), c("估计值", "标准误", "t值", "P值"))
#write.csv(gamm.y.severe.coef,"C:/Users/Administrator/Desktop/gamm.y.severe.coef.csv")
library("kableExtra")
knitr::kable(gamm.y.severe.coef, row.names =T, align = c("r", "r", "r", "r"),
             caption="年度空气严重污染天数泊松可加混合效应模型回归固定效应表",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```

图 \@ref(fig:fig-severe-gamm-y) 显示了泊松可加混合效应模型的非参数曲线，其非参数
项为常住人口、建成区绿化覆盖率、平均风速、日照时数，且由表
\@ref(tab:tab-severe-gamm-y-smooth) 的非参数项显著性检验可知，在10%的显著性水平
下，常住人口、建成区绿化覆盖率、平均风速、日照时数均通过显著性检验，表明常住人口、
建成区绿化覆盖率、平均风速、日照时数对年度空气严重污染天数存在非线性影响。且从图
\@ref(fig:fig-severe-gamm-y) 可以看出，年度空气严重污染天数随常住人口的增加而增
加，随平均风速、日照时数的增加而减少，随建成区绿化覆盖率的增加呈先增加后下降的趋
势。

```{r fig-severe-gamm-y, eval=T, fig.height=5.5, fig.width=6.5,out.width="95%", fig.pos="H", fig.cap = "年度空气严重污染天数泊松可加混合模型非参数曲线", dev=c("png","cairo_pdf"),dev.args=list(family="Microsoft YaHei UI Light")}
par(mfrow = c(2,2))
par(mar=c(5,4,2,1))
plot.gam(gamm.y.severe$gam,
         select=1,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "人口数"
         )
par(mar=c(5,4,2,1))
plot.gam(gamm.y.severe$gam,
         select=2,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "绿化率"
         )
par(mar=c(5,4,2,1))
plot.gam(gamm.y.severe$gam,
         select=3,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "平均风速"
         )
par(mar=c(5,4,2,1))
plot.gam(gamm.y.severe$gam,
         select=4,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "日照时数"
         )

```

```{r tab-severe-gamm-y-smooth, eval=T, results='markup'}
gamm.smooth.tab.y.severe <- as.data.frame(summary(gamm.y.severe$gam)$s.table[,-2])

dimnames(gamm.smooth.tab.y.severe) <- list(varselname[c(1,2,6,7)],c("经验自由度", "F统计量值", "P值"))

library("kableExtra")
knitr::kable(gamm.smooth.tab.y.severe, row.names =T, align = c("c", "c", "c", "c"),
             caption="年度空气严重污染天数泊松可加混合模型非参数项显著性",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```


### 年度空气严重污染天数模型比较与最优模型选择

上述分析中，我们选取年度空气严重污染天数作为因变量，基于lasso筛选出的变
量为自变量，分别建立泊松回归模型、泊松混合效应模型、泊松可加模型和泊松可加混合效
应模型对年度空气严重污染天数的影响因素进行分析。表 \@ref(tab:tab-severe-y-huizong) 给出了以上四个模型的汇总结果。

```{r tab-severe-y-huizong, eval=T, results='markup'}
yearly=read.csv("../results/yearly.csv")
yearly..=apply(yearly,2,function(x) as.character(x))
yearly..[seq(1,41,4)+1,(2:5)]=t(apply(yearly..[seq(1,41,4)+1,(2:5)],1,function(x) {as.factor(paste('(',as.character(-as.numeric(x)),')',sep = ""))}))
yearly=yearly..[-c(seq(1,41,4)+2,seq(1,41,4)+3),]
library("kableExtra")
knitr::kable(yearly, row.names =F, align = c("l", "c", "c", "c"),
             caption="年度空气严重污染天数模型汇总表",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```


根据表 \@ref(tab:tab-severe-y-huizong) 结果可知，在泊松回归模型中，显著的变量有常住人口、建成
区绿化覆盖率、私人汽车拥有量、平均相对湿度、平均风速、日照时数、供暖、临海；在泊松混合效应模
型中，显著的变量有常住人口、降水量、平均风速、日照时数、纬度；在泊松可加模型中，显著的变量有
降水量、临海、纬度、常住人口、建成区绿化覆盖率、平均风速、日照时数；在泊松可加混合效应模型中，
显著的变量有降水量、临海、纬度、常住人口、建成区绿化覆盖率、平均风速、日照时数。从模型拟合
优度来看，泊松可加模型效果最好，其AIC值最小，为476.7404，且临海地区的空气严重污染天数小于内陆
地区的严重污染天数，与文章前面的t检验结果一致。但在泊松可加模型中，部分线性自变量未通过显著性
检验，可以将其删掉，重新建立年度空气严重污染天数泊松可加模型。

以年度空气严重污染天数为因变量，降水量、平均风速、是否供暖、是否临海、纬度、
常住人口、日照时数为自变量建立泊松可加模型，模型估计的参数部分结果显示在表
\@ref(tab:tab-excel-gam-y-best) 中，非参数项的曲线显示在图
\@ref(fig:fig-excel-gam-y-best) 中，非参数项显著性检验结果在表
\@ref(tab:tab-excel-gam-y-smooth-best) 中。


```{r tab-severe-gam-y-best, eval=T, results='markup'}

library(mgcv)
gam.y.severe.best <- gam(severe~s(pop)
                    +rain+wind_speed+s(sun)
                   +heating+coast+lat,
                   data=dat.sel.y.severe,
                   family = "poisson", method = "REML")


gam.y.severe.best.coef <- summary(gam.y.severe.best)$p.table

dimnames(gam.y.severe.best.coef) <- list(c("截距项", varselname[c(4,6,8:10)]), c("估计值", "标准误", "t值", "P值"))

library("kableExtra")
knitr::kable(gam.y.severe.best.coef, row.names =T, align = c("r", "r", "r", "r"),
             caption="年度空气严重污染天数最优模型参数估计结果",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```

由表 \@ref(tab:tab-severe-gam-y-best) 可知，在10%的显著性水平下，降水量、平均风
速、是否供暖、是否临海、纬度均通过显著性检验，且参数项系数分别为-0.0011、-0.8767、
1.3932、-1.2146、0.0794。表明在其他条件不变的情况下，纬度越高的地区，年度空气严
重污染天数越多，空气质量越差；且供暖区域比非供暖区域空气质量差。而降水量越多、平
均风速越大、临海地区，年度空气严重污染天数越少，空气质量越好。

图 \@ref(fig:fig-severe-gam-y-best) 表明了常住人口、日照时数的非参数曲线，且从表
\@ref(tab:tab-severe-gam-y-smooth-best) 中可以看出，在10%的显著性水平下，常住人
口、日照时数对年度空气严重污染天数有非线性影响。且从图
\@ref(fig:fig-severe-gam-y-best) 中可以看出，年度空气严重污染天数随常住人口和日
照时数的增加均呈先上升后下降的趋势。

```{r fig-severe-gam-y-best, eval=T, fig.height=3.0, fig.width=6.5,out.width="95%", fig.pos="H", fig.cap = "年度空气严重污 染天数最优模型非参数曲线", dev=c("png","cairo_pdf"),dev.args=list(family="Microsoft YaHei UI Light")}
par(mfrow = c(1,2))
par(mar=c(5,4,2,1))
par(cex.lab = 0.9)
plot.gam(gam.y.severe.best,
         select=1,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "常住人口数"
         )

par(mar=c(5,4,2,1))
plot.gam(gam.y.severe.best,
         select=2,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "日照时数"
         )

```

```{r tab-severe-gam-y-smooth-best, eval=T, results='markup'}
gam.smooth.tab.y.severe <- as.data.frame(summary(gam.y.severe.best)$s.table[,-2])

dimnames(gam.smooth.tab.y.severe) <- list(varselname[c(1,7)], c("经验自由度", "F统计量值", "P值"))

library("kableExtra")
knitr::kable(gam.smooth.tab.y.severe, row.names =T, align = c("c", "c", "c", "c"),
             caption="年度空气严重污染天数最优模型非参数项显著性",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```


# 月度是否出现空气严重污染影响因素研究

利用2014年-2017年35城市每一天的AQI值，根据每一天的AQI值和空气质量指数等级划分标
准，可以计算得到2014年-2017年35城市的月度是否出现空气严重污染，把出现空气严重污
染记为1，否则记为0。根据第\@ref(sec:dep-dist)节中对因变量分布的分析，这个变量服
从两点分布。下面就以这个服从两点分布的变量作为因变量开展分析，首先利用Lasso方法
进行自变量筛选，然后建立Logistic可加混合模型框架下的各种具体模型并进行模型比较和
最优模型选择。

## 月度是否出现空气严重污染Lasso自变量筛选

对月度是否出现严重污染使用Lasso方法，变量筛选结果如图
\@ref(fig:fig-var-sel-m-severe) 所示。在图 \@ref(fig:fig-var-sel-m-severe) 中，
横轴表示各自变量。

```{r fig-var-sel-m-severe, eval=T, fig.height=8.5, fig.width=6.5,out.width="95%", fig.pos="H", fig.cap = "月度是否出现严重污染Lasso自变量筛选结果", dev=c("png","cairo_pdf"),dev.args=list(family="Microsoft YaHei UI Light")}
rm(list=ls())

varlist <- read.csv("../data/var_list.csv")
dat.sel.m.severe <- read.csv("../results/dat.sel.m.severe.csv")

varinfo <- varlist[match(names(dat.sel.m.severe), as.character(varlist$var_code)), c(1:3,7)]
varinfo <- varinfo[order(varinfo$var_no), ]

dat.sel.m.severe$city <- factor(dat.sel.m.severe$city)
dat.sel.m.severe$year <- factor(dat.sel.m.severe$year)
dat.sel.m.severe$month <- factor(dat.sel.m.severe$month)
dat.sel.m.severe$heating <- factor(dat.sel.m.severe$heating)
dat.sel.m.severe$coast <- factor(dat.sel.m.severe$coast)

dat.sel.m.severe$severe[dat.sel.m.severe$severe>0] <- 1

library(gamsel)
gam1 <- gamsel(as.matrix(dat.sel.m.severe[,-c(1:4, 24:25)]), as.matrix(dat.sel.m.severe[,4]), gamma = 0.48, family = "binomial", num_lambda = 50)
## gam1

par(mfrow=c(6,4), mar=c(2.1, 3.1, 2.1, 1.1))
## plot(gam1,newx=as.matrix(dat.sel.m.severe[,-c(1, 23:24)]), index=22)
mapply(function(i, y) {
    plot(gam1,newx=as.matrix(dat.sel.m.severe[,-c(1:4, 24:25)]),
         index=37, which = i, main = y, cex.main = 0.95, ylim = c(-0.2, 0.2))},
    as.list(1:22),
    as.list(varinfo[,2][-c(1:4, 24:25)]))

```

由图 \@ref(fig:fig-var-sel-m-severe) 可知，地区生产总值、地区
生产总值增长率、固定资产投资额、建成区绿化覆盖率、城市公路客运量、房屋建筑施工面
积、全社会用电量、工业二氧化硫排放量、工业烟粉尘排放量、工业污染治理完成投资额、
废气治理完成投资额、平均气压、经度、海拔对月度是否出现严重污染无影响，这些变量被
剔除，而剩下的变量有常住人口、私人汽车拥有量、平均气温、降水量、平均相对湿度、平
均风速、日照时数、纬度。且在剩下的这些变量中，可以看出，私人汽车拥有量对月度是否
出现严重污染呈正向影响，而降水量、平均相对湿度、平均风速、日照时数对月度是否出现
严重污染呈负向影响，常住人口、平均气温、纬度与月度是否出现严重污染呈非线性相关关
系。下面就以筛选出的变量建立模型。

## 月度是否出现空气严重污染模型构建

类似于以上关于年度空气严重污染天数的模型构建过程，首先对于服从二点分布的月度是否发生严
重污染建立logistic回归模型、然后考虑城市之间的相关性及自变量的非线性影响，分别建立Logistic
混合模型和Logistic可加模型，最后综合考虑城市之间的相关性及自变量的非线性影响，建立Logistic
可加混合模型进行相应分析。最后在这些可选模型中通过综合比较模型拟合优度，模型实际意义等确定
月度空气污染天数最优模型。

### 月度是否出现空气严重污染Logistic回归模型

作为比较的基准，首先建立Logistic回归模型，结果表明在其他变量保持不变的条件下，私人汽车拥有
量越多，纬度越高，月度出现严重污染的概率越大；而常住人口越多、平均气温越高、降水量越大、平
均相对湿度越大、平均风速越大、日照时数越长，月度出现严重污染的概率越小。而供暖和临海这两个地
理因素对月度是否出现严重污染无显著影响，具体结果见\@ref(tab:tab-severe-m-huizong)。


```{r tab-severe-lm-m, include=FALSE, results='markup'}
varlist <- read.csv("../data/var_list.csv")
dat.sel.m.severe <- read.csv("../results/dat.sel.m.severe.csv")
severe=ifelse(dat.sel.m.severe$severe>0,1,0)
dat.sel.m.severe$severe=severe
varinfo <- varlist[match(names(dat.sel.m.severe), as.character(varlist$var_code)), c(1:3,7)]
varinfo <- varinfo[order(varinfo$var_no), ]
varsel <- c(as.character(varinfo[,3][-c(1:4, 24:25)][getActive(gam1, 37, "nonzero")[[1]]]),
            "heating", "coast")
varselname <- varlist[match(varsel, as.character(varlist$var_code)), c(1:3,7)]
varselname <- as.character(varselname[order(varselname$var_no), 2])

glm.m.severe1 <- glm(severe~pop+car
                   +mean_temp+rain+humid+wind_speed+sun
                   +heating+coast+lat,
                   data=dat.sel.m.severe,
                   family = binomial)
#glm.m.severe1$aic;BIC(glm.m.severe1)
lm.m.severe.coef <- summary(glm.m.severe1)$coef


dimnames(lm.m.severe.coef) <- list(c("截距项", varselname), c("估计值", "标准误", "t值", "P值"))
#write.csv(lm.m.severe.coef,"C:/Users/Administrator/Desktop/lm.m.severe.coef.csv")
library("kableExtra")
knitr::kable(lm.m.severe.coef, row.names =T, align = c("r", "r", "r", "r"),
             caption="月度是否出现空气严重污染Logistic回归模型回归系数表",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```


### 月度是否出现空气严重污染Logistic混合效应模型

接下来将城市作为随机效应建立Logistic混合效应模型，对空气质量影响因素进行分析。除了常住人口
和供暖、临海两个地理因素对月度出现严重污染无显著性影响外，其余变量结果与月度是否出现空气严重污染
Logistic回归模型的结果相似，详见\@ref(tab:tab-severe-m-huizong)。在10%的显著性水平下，私人汽车拥有量、平均气温、降水量、平均相
对湿度、平均风速、日照时数、纬度均通过显著性检验，且在其他变量保持不变的条件下，私人
汽车拥有量越多，纬度越高，月度出现严重污染的概率越大；而平均气温越高、降水量越大、
平均相对湿度越大、平均风速越大、日照时数越长，月度出现严重污染的概率越小。

```{r tab-severe-lme-m-model, include=FALSE, results='hide'}
library(mgcv)

lme.m.severe <- gamm(severe~pop+car
                   +mean_temp+rain+humid+wind_speed+sun
                   +heating+coast+lat,
                   data=dat.sel.m.severe,
                   family = binomial, 
                   random=list(city=~1), method = "REML")
#AIC(lme.m.severe$lme);BIC(lme.m.severe$lme)
```

```{r tab-severe-lme-m, include=FALSE, results='markup'}

lme.m.severe.coef <- summary(lme.m.severe$lme)$tTable[,-3]

dimnames(lme.m.severe.coef) <- list(c("截距项", varselname), c("估计值", "标准误", "t值", "P值"))
#write.csv(lme.m.severe.coef,"C:/Users/Administrator/Desktop/lme.m.severe.coef.csv")
library("kableExtra")
knitr::kable(lme.m.severe.coef, row.names =T, align = c("r", "r", "r", "r"),
             caption="月度是否出现空气严重污染Logistic混合效应模型回归固定效应表",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```

### 月度是否出现空气严重污染Logistic可加模型

由之前变量筛选的结果可知，常住人口、平均气温、纬度与月度是否出现严重污染之间存在
非线性相关关系。进一步建立Logistic可加模型，建立的Logistic可加模型中参数部分结果
显示供暖和临海两个地理因素尚不足以影响月度出现严重污染的概率。与Logistic回归模型
和Logistic混合效应不同的是，Logistic可加模型中的私人汽车拥有量对月度出现严重污染
的概率有负向作用，私人汽车拥有量越多，月度出现严重污染的概率越小。非参数项的曲线
显示在图\@ref(fig:fig-severe-gam-m)中，非参数项显著性检验结果在表
\@ref(tab:tab-severe-gam-m-smooth) 中。


```{r tab-severe-gam-m, include=FALSE, results='markup'}

library(mgcv)
gam.m.severe <- gamm(severe~s(pop)+car
                   +s(mean_temp)+rain+humid+wind_speed+sun
                   +heating+coast+s(lat),
                   data=dat.sel.m.severe,
                   family = binomial, method = "REML")
summary(gam.m.severe)
#gam.m.severe$aic;BIC(gam.m.severe)
gam.m.severe.coef <- summary(gam.m.severe$lme)$tTable[-(9:11),-3]

dimnames(gam.m.severe.coef) <- list(c("截距项", varselname[-c(1,3,10)]), c("估计值", "标准误", "t值", "P值"))
#write.csv(gam.m.severe.coef,"C:/Users/Administrator/Desktop/gam.m.severe.coef.csv")
library("kableExtra")
knitr::kable(gam.m.severe.coef, row.names =T, align = c("r", "r", "r", "r"),
             caption="月度是否出现空气严重污染Logistic可加模型参数估计结果",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```

```{r fig-severe-gam-m, eval=T, fig.height=5.5, fig.width=6.5,out.width="95%", fig.pos="H", fig.cap = "月度是否出现空 气严重污染Logistic可加模型非参数曲线", dev=c("png","cairo_pdf"),dev.args=list(family="Microsoft YaHei UI Light")}
par(mfrow = c(2,2))
par(mar=c(5,4,2,1))
plot.gam(gam.m.severe$gam,
         select=1,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "常住人口数"
         )
plot.gam(gam.m.severe$gam,
         select=2,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "平均温度"
         )
plot.gam(gam.m.severe$gam,
         select=3,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "纬度"
         )
```

```{r tab-severe-gam-m-smooth, eval=T, results='markup'}
gam.smooth.tab.m.severe <- as.data.frame(summary(gam.m.severe$gam)$s.table[,-2])

dimnames(gam.smooth.tab.m.severe) <- list(varselname[c(1,3,10)], c("经验自由度", "卡方统计量值", "P值"))

library("kableExtra")
knitr::kable(gam.smooth.tab.m.severe, row.names =T, align = c("c", "c", "c", "c"),
             caption="月度是否出现空气严重污染Logistic可加模型非参数项显著性",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```

图 \@ref(fig:fig-severe-gam-m) 中显示了常住人口、平均气温、纬度的拟合曲线，阴影
部分表示95%的置信区间。同时由表 \@ref(tab:tab-severe-gam-m-smooth) 可知，在10%的
显著性水平下，常住人口、平均气温、纬度通过显著性检验，表明常住人口、平均气温、纬
度对月度是否出现严重污染存在非线性影响。由图 \@ref(fig:fig-severe-gam-m) 可以看
出，这三个非参数项的表现与Logistic可加模型中非常类似，月度是否出现空气严重污染的
概率一开始随着常住人口数的上升而上升，但对于常住人口数超过2000万的城市而言，月度
出现空气严重污染的概率会下降。对于城市月平均温度，月度出现空气严重污染的概率随着
平均温度的上升而下降，但这个下降不是线性的。对于纬度，月度出现空气严重污染的概率
随着纬度的上升而上升，但到了北纬40度之后，月度出现空气严重污染的概率不再随着纬度
上升而上升，而是基本持平的。

### 月度是否出现空气严重污染Logistic可加混合效应模型

同样以城市作为随机效应，进一步建立Logistic可加混合效应模型，估计的模型中参数部分
结果显示在\@ref(tab:tab-severe-m-huizong)。在10%的显著性水平下，降水量、平均相对湿度、平均风速、日照时数均通过显著性
检验，且其系数均为负，表明在其他条件不变的前提下，降水量越多、平均相对湿度越大、平
均风速越大、日照时数越长，月度出现严重污染的概率越小，同样供暖和临海这两个地理因素
对月度出现严重污染的概率无显著影响。非参数项的曲线显示在图
\@ref(fig:fig-severe-gamm-m) 中，非参数项显著性检验结果在表
\@ref(tab:tab-severe-gamm-m-smooth) 中。


```{r tab-severe-gamm-m-model, include=FALSE, results='hide'}

library(mgcv)
gamm.m.severe <- gamm(severe~s(pop)+car
                   +s(mean_temp)+rain+humid+wind_speed+sun
                   +heating+coast+s(lat),
                      random=list(city=~1), data=dat.sel.m.severe,
                     family = "binomial", method = "REML")
logLik(gamm.m.severe$lme)
#AIC(gamm.m.severe$lme);BIC(gamm.m.severe$lme)
```

```{r tab-severe-gamm-m, eval=T, results='markup'}

gamm.m.severe.coef <- summary(gamm.m.severe$lme)$tTable[-(9:11),-3]

dimnames(gamm.m.severe.coef) <- list(c("截距项", varselname[-c(1,3,10)]), c("估计值", "标准误", "t值", "P值"))
#write.csv(gamm.m.severe.coef,"C:/Users/Administrator/Desktop/gamm.m.severe.coef.csv")
library("kableExtra")
knitr::kable(gamm.m.severe.coef, row.names =T, align = c("r", "r", "r", "r"),
             caption="月度是否出现空气严重污染Logistic可加混合模型回归固定效应表",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```


```{r fig-severe-gamm-m, eval=T, fig.height=5.5, fig.width=6.5,out.width="95%", fig.pos="H", fig.cap = "月度是否出现空气严重污染Logistic可加混合模型非参数曲线", dev=c("png","cairo_pdf"),dev.args=list(family="Microsoft YaHei UI Light")}
par(mfrow = c(2,2))
par(mar=c(5,4,2,1))
plot.gam(gamm.m.severe$gam,
         select=1,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "常住人口数"
         )
par(mar=c(5,4,2,1))
plot.gam(gamm.m.severe$gam,
         select=2,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "平均温度"
         )
par(mar=c(5,4,2,1))
plot.gam(gamm.m.severe$gam,
         select=3,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "纬度"
         )

```

```{r tab-severe-gamm-m-smooth, eval=T, results='markup'}
gamm.smooth.tab.m.severe <- as.data.frame(summary(gamm.m.severe$gam)$s.table[,-2])

dimnames(gamm.smooth.tab.m.severe) <- list(varselname[c(1,3,10)],c("经验自由度", "F统计量值", "P值"))

library("kableExtra")
knitr::kable(gamm.smooth.tab.m.severe, row.names =T, align = c("c", "c", "c", "c"),
             caption="月度是否出现空气严重污染Logistic可加混合模型非参数项显著性",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```

图 \@ref(fig:fig-severe-gamm-m) 显示了Logistic可加混合效应模型的非参数曲线，其非
参数项为常住人口、平均气温、纬度，且由表 \@ref(tab:tab-severe-gamm-m-smooth) 的
非参数项显著性检验可知，在10%的显著性水平下，三个非参数项均通过了显著性检验。由
图 \@ref(fig:fig-severe-gamm-m) 可以看出，月度是否出现空气严重污染的概率一开始随
着常住人口数的上升而上升，但对于常住人口数超过2000万的城市而言，月度出现空气严重
污染的概率会下降。对于城市月平均温度，月度出现空气严重污染的概率随着平均温度的上
升而下降，但这个下降不是线性的。对于纬度，月度出现空气严重污染的概率随着纬度的上
升而上升，但到了北纬40度之后，月度出现空气严重污染的概率不再随着纬度上升而上升，
而是基本持平的。


### 月度是否出现空气严重污染模型比较与最优模型选择

上述分析中，文章选取月度是否出现严重污染作为因变量，基于lasso筛选出的变量为自变
量，分别建立Logistic回归模型、Logistic混合效应模型、Logistic可加模型和Logistic可
加混合效应模型对空气质量的影响因素进行分析。现将以上四个模型的结果汇总在表
\@ref(tab:tab-severe-m-huizong) 中。

```{r tab-severe-m-huizong, eval=T, results='markup'}
month=read.csv("../results/month.csv")
month..=apply(month,2,function(x) as.character(x))
month..[seq(1,41,4)+1,(2:5)]=apply(month..[seq(1,41,4)+1,(2:5)],2,function(x) {substr(x,2,9)})
month=month..[-c(seq(1,41,4)+2,seq(1,41,4)+3),]
library("kableExtra")
knitr::kable(month, row.names =F, align = c("c", "c", "c", "c"),
             caption="月度空气严重污染天数模型汇总表",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))
```

根据以上分析结果可知，在Logistic回归
模型中，显著的变量有常住人口、私人汽车拥有量、平均气温、降水量、平均相对湿度、平
均风速、日照时数、纬度；在Logistic混合效应模型中，显著的变量有私人汽车拥有量、平
均气温、降水量、平均相对湿度、平均风速、日照时数、纬度；在Logistic可加模型中，显
著的变量有私人汽车拥有量、降水量、平均相对湿度、平均风速、日照时数、常住人口、平
均气温、纬度；在Logistic可加混合效应模型中，显著的变量有降水量、平均相对湿度、平
均风速、日照时数、纬度。通过比较以上模型的AIC值和模型的实际意义，本文选择Logistic
可加模型作为最优模型，其AIC值最小，为753.2231。但在上面估计的Logistic可加模型中，
是否供暖和是否临海两个自变量未通过显著性检验，因此将其删除并重新建立Logistic可加模型。

以月度是否出现严重污染为因变量，私人汽车拥有量、降水量、平均相对湿度、平均风速、
日照时数、常住人口、平均气温、纬度为自变量，建立Logistic可加模型，模型估计结果中
参数部分结果显示在表 \@ref(tab:tab-severe-gam-m-best) 中，非参数项的曲线显示在图
\@ref(fig:fig-severe-gam-m-best) 中，非参数项显著性检验结果在表
\@ref(tab:tab-severe-gam-m-smooth-best) 中。

```{r tab-severe-gam-m-best, eval=T, results='markup'}

library(mgcv)
gam.m.severe.best <- gam(severe~s(pop)+car
                   +s(mean_temp)+rain+humid+wind_speed+sun
                  +s(lat),
                   data=dat.sel.m.severe,
                   family = "binomial", method = "REML")


gam.m.severe.best.coef <- summary(gam.m.severe.best)$p.table

dimnames(gam.m.severe.best.coef) <- list(c("截距项", varselname[-c(1,3,8:10)]), c("估计值", "标准误", "t值", "P值"))

library("kableExtra")
knitr::kable(gam.m.severe.best.coef, row.names =T, align = c("r", "r", "r", "r"),
             caption="月度是否出现空气严重污染最优模型参数估计结果",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))

```


由表 \@ref(tab:tab-severe-gam-m-best) 可知，在10%的显著性水平下，私人汽车拥有量，
降水量、平均相对湿度、平均风速、日照时数均通过显著性检验，且其系数均为负，表明在
其他条件不变的情况下，私人汽车拥有量越大，降水量越大、平均相对湿度越大、平均风速
越大、日照时数越长，月度出现严重污染的概率越小。

同时各项参数的符号与实际意义也相符。结合相关领域知识可以知道，当气温较高时，大气处
于不稳定状态，在热力对流的作用下污染物向上扩散，空气质量就会变好；反之，当气温较低
时，大气变得稳定，污染物的扩散受到抑制作用，空气质量就会变差。这与最优模型的研究结
果保持一致。并且当低压控制时，大气处于中性或不稳定状态，近地面的污染物会随空气上升
到高空，有利于近地面污染物向高空扩散；当高压控制时，空气作下沉运动，阻止污染物的向上
扩散。所以气压越高，越不利于优良空气质量的发展。而风速越大在一定程度内有利于空气污
染物的扩散和稀释，空气质量越优。同样，增加降水量和湿度均对空气有净化作用，空气质量越好。
而模型结果中私人汽车拥有量未对月度严重污染的概率造成影响很有可能是限号等相关交通
政策实施和近年来清洁能源发展的结果，致使私人汽车拥有量的增加没有导致严重污染天数增加。

```{r fig-severe-gam-m-best, eval=T, fig.height=5.5, fig.width=6.5,out.width="95%", fig.pos="H", fig.cap = "月度是否出现空气严重污染最优模型非参数曲线", dev=c("png","cairo_pdf"),dev.args=list(family="Microsoft YaHei UI Light")}
par(mfrow = c(2,2))
par(mar=c(5,4,2,1))
plot.gam(gam.m.severe.best,
         select=1,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "常住人口数"
         )
par(mar=c(5,4,2,1))
plot.gam(gam.m.severe.best,
         select=2,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "平均温度"
         )
par(mar=c(5,4,2,1))
plot.gam(gam.m.severe.best,
         select=3,
         col="blue",
         shade=T,
         shade.col="grey",
         ylab="severe",xlab = "纬度"
         )
```

```{r tab-severe-gam-m-smooth-best, eval=T, results='markup'}
gam.smooth.tab.m.severe <- as.data.frame(summary(gam.m.severe.best)$s.table[,-2])

dimnames(gam.smooth.tab.m.severe) <- list(varselname[c(1,3,10)], c("经验自由度", "F统计量值", "P值"))

library("kableExtra")
knitr::kable(gam.smooth.tab.m.severe, row.names =T, align = c("c", "c", "c", "c"),
             caption="月度是否出现空气严重污染最优模型非参数项显著性",digits = 4,
             longtable = TRUE, booktabs = TRUE, escape = F) %>%
    kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                  ## stripe_index = rep(1:5, 4)+rep(c(0,10,20,30), each = 5),
                  repeat_header_text = "(续)")%>%
    kable_styling(full_width = T) %>%
    column_spec(1, width = c("4.5cm"))
```

图 \@ref(fig:fig-severe-gam-m-best) 展示了常住人口数、平均气温、纬度与月度是否出
现空气严重污染的非参数关系曲线，且从表 \@ref(tab:tab-severe-gam-m-smooth-best)
中可以看出，在10%的显著性水平下，三个变量对月度是否出现严重污染的概率的非线性影
响均是显著的。由图 \@ref(fig:fig-severe-gam-m-best) 可以看出，月度是否出现空气严
重污染的概率一开始随着常住人口数的上升而缓慢上升，但对于常住人口数超过2000万的城
市而言，月度出现空气严重污染的概率会下降。对于城市月平均温度，月度出现空气严重污
染的概率随着平均温度的上升而下降，但这个下降不是线性的。对于纬度，月度出现空气严
重污染的概率随着纬度的上升而上升，但到了北纬40度之后，月度出现空气严重污染的概率
不再随着纬度上升而上升，而是基本持平的。

# 结论

本文从空气污染可能出现的最坏情况，也是空气质量的最低等级：空气严重污染的角度，
对35个城市年度空气严重污染天数建立泊松可加混合模型框架下的各种模型，对月度是否出现
空气严重污染建立Logistic可加混合模型框架下的各种模型，并通过模型拟合优度指标及模
型实际意义等方面综合选取了最优模型。在建立模型过程中，使用了Lasso方法进行自
变量筛选及以决定其进入模型的形式。

对于年度空气严重污染天数，社会经济影响因素中的常住人口数是影响天数多少的主要因素，
并且这个影响是非线性的，总体而言，年度空气严重污染天数是随着常住人口数的增加而逐
渐增多，但常住人口数超过2000万的特大城市，对于空气严重污染控制的比较好，年度空气
严重污染天数并不多。气候因素中的降水量和平均风速对年度空气严重污染天数有负向线性
影响，而日照时数有非线性影响。地理因素中的是否供暖，是否临海和纬度均对年度空气严
重污染天数有显著性线性影响。供暖地区的空气严重污染天数多于非供暖地区，临海地区的
空气质量较内陆地区更好。

对于月度是否出现空气严重污染，社会经济影响因素有常住
人口数，其与月度是否出现空气严重污染概率之间具有非线性关系；气候
因素中的平均气温，降水量，平均相对湿度，平均风速和日照时数对月度是否出现空气严重
污染的概率局有显著性影响，其中平均气温是非线性影响，其他4个气候因素是负向线性影
响。地理因素中只有纬度变量对月度是否出现空气严重污染有显著性影响，并且这个影响是
非线性的。通过比较年度空气严重污染天数和月度是否出现空气严重污染之间的影响因素，
我们发现二者并不完成重合。

# 参考文献 {-}
[//]: # (\bibliography{Bibfile})
